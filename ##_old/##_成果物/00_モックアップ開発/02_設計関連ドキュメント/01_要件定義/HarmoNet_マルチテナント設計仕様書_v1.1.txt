# HarmoNet マルチテナント設計仕様書 v1.1（Part1）
文書バージョン: 1.1
作成日: 2025年10月30日
最終更新日: 2025年10月30日
文書管理番号: HARMONET-MULTI-TENANT-001

---

## 第1章 ドキュメント概要

### 1.1 目的
本書は、HarmoNet プロジェクトにおけるマルチテナント型アーキテクチャの設計仕様を定義する。  
複数の管理組合・住宅群・施設を単一プラットフォーム上で安全かつ効率的に管理するための技術的設計方針を示す。

### 1.2 適用範囲
本書は、HarmoNet アプリケーションの **バックエンド構成・データ分離・テナント初期化・RLS制御** に関わる全ての実装方針を対象とする。  
対象範囲には以下を含む：
- NestJS / Prisma / PostgreSQL を中心としたバックエンド構成
- Supabase Row Level Security (RLS) 設計
- テナントデータモデルと設定マスタ構造
- テナントライフサイクル管理（作成・削除・保守）

### 1.3 背景
HarmoNet は、地域コミュニティ運営を支援する SaaS 型住民コミュニケーションプラットフォームであり、  
1つのアプリケーションから複数の住宅群・管理組合を管理する「マルチテナント型 SaaS アーキテクチャ」を採用する。

### 1.4 開発体制
AI協調開発方式を採用し、以下のAIエージェントが分担して開発を行う。

| AI | 主担当領域 |
|----|-------------|
| Claude | 画面設計・UXデザイン・構造化ドキュメント |
| Gemini | 開発環境構築・インフラ設定・CI/CD |
| GPT（タチコマ） | コード生成・ドキュメント統合・設計レビュー |

---

## 第2章 システム構成概要

### 2.1 システム構成概要図

```
[User] ─→ [React PWA] ─→ [NestJS + Prisma API] ─→ [Supabase PostgreSQL (RLS)]
                                   │
                                   ├─ [Supabase Auth / Storage]
                                   ├─ [SendGrid / SES (Mail)]
                                   └─ [Firebase Cloud Messaging]
```

### 2.2 採用技術スタック

| レイヤー | 技術 | 備考 |
|-----------|------|------|
| バックエンド | NestJS (Node.js 10.x) | APIサーバー |
| ORM | Prisma ORM 5.x | スキーマ自動生成・マルチテナント対応 |
| データベース | PostgreSQL (Supabase) | Row Level Security適用 |
| キャッシュ | Redis 7.x | セッション・翻訳キャッシュ |
| フロント | React + PWA | スマートフォン・PC対応 |
| ホスティング | Vercel + Supabase | MVP構成 |
| 通知 | Firebase Cloud Messaging | iOS/Android通知 |
| メール配信 | SendGrid / Amazon SES | 認証・予約・通知用途 |
| 翻訳 | Google Cloud Translation API | 日・英・中翻訳 |
| 認証 | Magic Link (NextAuth) | パスワードレス方式 |

### 2.3 マルチテナント方式
- **論理分離方式**：単一データベース内で tenant_id により分離。
- **Row Level Security (RLS)** により DB側でもアクセス制御。
- **アプリ層制御**：Prismaミドルウェアにより全クエリに tenant_id を自動付与。
- **スキーマ分離方式（物理分離）** は将来のスケーリングフェーズで検討。

### 2.4 テナント識別方式
- `tenant_id`: UUID v4 形式で一意に採番。
- テナント識別はログイン時の JWT ペイロードに含まれる。
- APIアクセス時、ミドルウェアでtenant_idを解決し、クエリスコープに注入。

---

## 第3章 テナントモデル設計

### 3.1 テーブル構造概要

| テーブル名 | 主目的 |
|-------------|----------|
| tenant | テナント基本情報 |
| tenant_user | テナント所属ユーザー情報 |
| tenant_features | 有効機能設定 |
| tenant_settings | テナント固有設定 (JSON) |

### 3.2 tenant テーブル

| カラム名 | 型 | 説明 |
|-----------|----|------|
| id | UUID | テナント識別子 |
| name | VARCHAR(100) | テナント名称（例：A棟管理組合） |
| code | VARCHAR(50) | 識別コード（URLサブドメイン用） |
| status | VARCHAR(20) | active / suspended / deleted |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

### 3.3 tenant_user テーブル

| カラム名 | 型 | 説明 |
|-----------|----|------|
| id | UUID | 識別子 |
| tenant_id | UUID | 紐付くテナント |
| user_id | UUID | Supabase AuthユーザーID |
| role | VARCHAR(20) | admin / member |
| joined_at | TIMESTAMP | 参加日時 |
| last_login_at | TIMESTAMP | 最終ログイン日時 |

### 3.4 tenant_features テーブル

| カラム名 | 型 | 説明 |
|-----------|----|------|
| id | SERIAL | 主キー |
| tenant_id | UUID | 紐付くテナント |
| feature_name | VARCHAR(50) | 機能名 |
| enabled | BOOLEAN | 有効化フラグ |
| updated_at | TIMESTAMP | 更新日時 |

**feature_name の定義例**:
```
announcement
bbs
parking
survey
consumables
watch_camera
care_support
```
※ 新規追加 `"consumables"` は「住宅設備・消耗品照会／発注機能」を表す。

### 3.5 tenant_settings テーブル

| カラム名 | 型 | 説明 |
|-----------|----|------|
| id | SERIAL | 主キー |
| tenant_id | UUID | 紐付くテナント |
| settings_json | JSONB | 設定データ（テーマ・予約制限等） |
| updated_at | TIMESTAMP | 更新日時 |

**settings_json 構造例**
```json
{
  "theme": "light",
  "language_default": "ja",
  "parking": {
    "max_days": 3,
    "allow_consecutive": false
  },
  "features_enabled": ["bbs", "parking", "announcement", "survey", "consumables"]
}
```

---

## 第4章 テナントライフサイクル管理

### 4.1 テナント作成フロー
1. 管理者が新規テナント作成APIを呼び出す。  
2. tenantレコードを生成。  
3. 初期機能を tenant_features に登録。  
4. 初期設定JSONを tenant_settings に生成。  
5. Supabase Auth に管理者ユーザーを登録。  

**初期有効機能例:**
```
["bbs", "announcement", "parking", "survey"]
```

将来的には `consumables` を管理者ダッシュボードから有効化可能とする。

### 4.2 テナント削除フロー
- `status` を `deleted` に更新（論理削除）。
- 関連テーブル（tenant_user, tenant_features 等）は保持。
- Supabase RLSポリシーにより削除済みテナントは参照不可。

### 4.3 Row Level Security (RLS) 設計

**目的:**  
RLSにより、ユーザーが所属するテナント以外のデータを閲覧・操作できないよう制御する。

**ポリシー例:**
```sql
CREATE POLICY tenant_isolation_policy
ON public.bbs_posts
USING (tenant_id = auth.jwt() ->> 'tenant_id');
```

- Supabase AuthのJWTペイロードに `tenant_id` を含める。  
- Prismaからのリクエストでは、ミドルウェアで tenant_id を付与して発行。  

### 4.4 Prisma ミドルウェアによる制御
```ts
prisma.$use(async (params, next) => {
  if (params.args?.data && context.tenantId) {
    params.args.data.tenant_id = context.tenantId;
  }
  return next(params);
});
```

### 4.5 テナント監査ログ
- tenantごとに操作ログをJSON形式で記録。
- Supabase Storageに1ヶ月保管。

---

# HarmoNet マルチテナント設計仕様書 v1.1（Part2）
文書バージョン: 1.1
作成日: 2025年10月30日
最終更新日: 2025年10月30日
文書管理番号: HARMONET-MULTI-TENANT-001

---

## 第5章 API設計方針

### 5.1 API構成概要

HarmoNetでは、NestJSを利用したモジュラー構成のREST APIを採用する。  
エンドポイントは全て `/api/v1/{tenant_code}/...` の形式をとり、tenant_codeによりデータスコープを分離する。

**基本設計原則:**
- テナントごとにスコープを分離（tenant_idで制御）
- Prisma ORMによる型安全なクエリ実装
- OpenAPI (Swagger) による自動ドキュメント生成
- JWT認証を用いたAPI保護

### 5.2 API命名規則
| 種別 | パターン | 例 |
|------|-----------|----|
| GET | /api/v1/{tenant}/bbs | 掲示板一覧取得 |
| POST | /api/v1/{tenant}/bbs | 新規投稿 |
| PUT | /api/v1/{tenant}/bbs/{id} | 投稿更新 |
| DELETE | /api/v1/{tenant}/bbs/{id} | 投稿削除 |

APIエラーレスポンスはJSON形式で統一する。

**例:**
```json
{
  "status": "error",
  "code": "TENANT_NOT_FOUND",
  "message": "指定されたテナントが存在しません。"
}
```

---

## 第6章 認証・権限管理

### 6.1 認証方式
HarmoNetではパスワードレス認証方式（Magic Link）を採用する。  
Supabase Authをベースに、NextAuth連携によるトークン発行を行う。

**認証フロー:**
1. ユーザーがメールアドレスを入力しログインリンク送信  
2. Supabase Authがトークン付きリンクを生成・送信  
3. リンクをクリック → 認証成功後、JWT発行  
4. JWTには `tenant_id`, `role`, `lang` を含むペイロードを付与

**JWTペイロード例:**
```json
{
  "sub": "user-uuid",
  "tenant_id": "tenant-uuid",
  "role": "admin",
  "lang": "ja",
  "exp": 1735600000
}
```

### 6.2 権限ロール定義
| ロール | 権限範囲 | 操作例 |
|--------|------------|--------|
| system_admin | 全テナント管理 | 新規テナント作成／削除 |
| tenant_admin | テナント内全権 | ユーザー招待・設定変更 |
| member | 一般ユーザー | 投稿・予約・閲覧 |

### 6.3 認可ポリシー
NestJS Guard と Prisma ミドルウェアを併用してアクセス制御を実施する。  
Guard層でロール認可、ミドルウェア層でtenant_id整合性を検証する。

**例:**
```ts
@UseGuards(JwtAuthGuard, RolesGuard)
@Get('/bbs')
async findAll(@Tenant() tenantId: string) {
  return this.bbsService.findAll({ tenantId });
}
```

---

## 第7章 RLS運用と監査ログ設計

### 7.1 Row Level Security方針

**目的:**  
RLS（Row Level Security）により、DBレイヤーでのデータ隔離を強制する。  
これにより、アプリケーション層でのバグによる越権アクセスを防ぐ。

**設定例（Supabase側）:**
```sql
ALTER TABLE public.bbs_posts ENABLE ROW LEVEL SECURITY;

CREATE POLICY tenant_rls_policy
ON public.bbs_posts
USING (tenant_id = auth.jwt() ->> 'tenant_id');
```

**補足:**  
Prisma ORMはRLSを透過的に利用できる。  
tenant_idはJWTから自動解決され、`context` に注入される。

### 7.2 RLS適用対象テーブル
- bbs_posts
- bbs_comments
- announcements
- reservations
- tenant_user
- survey_responses
- consumables_orders

### 7.3 Prismaミドルウェア補足
- API呼出ごとに `tenant_id` を自動挿入  
- 管理者操作時にはシステム権限フラグを付与 (`role=system_admin`)  
- 不整合時は `FORBIDDEN` エラーを返す

### 7.4 監査ログ
- すべての更新操作を `audit_log` テーブルに記録
- 形式: JSONB  
- 保持期間: 90日（Supabase Storageでローテーション）

**テーブル例:**
```sql
CREATE TABLE audit_log (
  id BIGSERIAL PRIMARY KEY,
  tenant_id UUID NOT NULL,
  user_id UUID,
  action VARCHAR(50),
  entity VARCHAR(50),
  payload JSONB,
  created_at TIMESTAMP DEFAULT now()
);
```

### 7.5 ログ構造例
```json
{
  "action": "CREATE_POST",
  "entity": "bbs_posts",
  "payload": {
    "title": "新しい投稿",
    "category": "announcement"
  },
  "user_id": "user-uuid",
  "tenant_id": "tenant-uuid",
  "timestamp": "2025-10-30T10:10:00Z"
}
```

---

## 第8章 運用環境・監視構成

### 8.1 運用環境構成

| 環境 | 構成 | 備考 |
|------|------|------|
| 開発環境 | Docker Desktop + Supabase (local) | 開発者向け環境 |
| ステージング | Vercel + Supabase Project | 本番同等 |
| 本番 | Vercel + Supabase (managed) | 自動バックアップ・監視 |

**構成概要図:**

```
[Vercel Frontend] 
   │
   ├── [NestJS API]
   │       └─ Prisma ORM → Supabase (RLS)
   │
   ├── [Supabase Auth / Storage]
   ├── [SendGrid / SES]
   └── [FCM Notifications]
```

### 8.2 バックアップ運用
- Supabase自動バックアップ（毎日）  
- 保管期間: 7日間  
- 月次バックアップ: Cloud Storage に保存  
- 復旧手順: Supabaseリストア機能利用

### 8.3 監視設計

| 監視項目 | 監視方法 | アラート条件 |
|-----------|------------|---------------|
| 稼働率 | UptimeRobot | 3分間隔でping応答 |
| エラー発生率 | Sentry | 5%以上で通知 |
| API応答時間 | Datadog / Vercel Monitor | 平均>2秒 |
| DB接続数 | Supabaseモニタ | 80%以上 |
| 翻訳API使用量 | Cloud Monitoring | 無料枠80%で警告 |

### 8.4 アラート通知
- 通知先: Slack / メール  
- 通知内容: 発生箇所・時刻・影響範囲  
- レベル定義: Info / Warning / Critical  

### 8.5 障害対応手順
1. 障害検知（Sentry／Slack）  
2. 該当リリースのロールバック（Vercelロールバック機能）  
3. Supabase接続確認・再起動  
4. 状況共有（Slackチャンネル）  
5. 根本原因分析・再発防止策登録

---

# HarmoNet マルチテナント設計仕様書 v1.1（Part3）
文書バージョン: 1.1
作成日: 2025年10月30日
最終更新日: 2025年10月30日
文書管理番号: HARMONET-MULTI-TENANT-001

---

## 第9章 コスト試算

### 9.1 クラウド利用コスト（MVP構成）
| 項目 | サービス | 想定月額 | 備考 |
|------|-----------|-----------|------|
| フロントエンド | Vercel Pro | 約2,500円 | CDN含む |
| DB／Auth／Storage | Supabase | 約3,000円 | RLS含む |
| メール通知 | SendGrid | 無料枠100通まで |
| 翻訳API | Google Cloud Translation | 約0円（50万文字無料） |
| 通知API | Firebase Cloud Messaging | 無料 |
| 監視 | UptimeRobot / Sentry | 約1,000円 |
| 合計 |  | **約6,500円／月** | MVP時想定 |

**備考:**  
将来的にユーザー数増加・マルチテナント拡張に伴い、月額15,000〜25,000円規模を想定。

---

### 9.2 AWS移行時コスト（将来）
| サービス | 概要 | 想定月額 |
|-----------|--------|-----------|
| ECS (Fargate) | APIコンテナ稼働 | 約8,000円 |
| RDS (PostgreSQL) | DB運用 | 約5,000円 |
| CloudFront | CDN配信 | 約2,000円 |
| S3 | 画像・添付保存 | 約1,000円 |
| 合計 |  | **約16,000円／月** |

---

## 第10章 スケーラビリティ設計

### 10.1 スケール戦略
1. **垂直スケーリング**：Vercel/Supabaseプランアップグレード  
2. **水平スケーリング**：ECS分散構成（将来フェーズ）  
3. **キャッシュ分散**：Redisクラスタリング  
4. **DB最適化**：インデックス最適化・RLS効率化

### 10.2 同時アクセス試験想定
| 想定条件 | 値 |
|-----------|------|
| 同時アクセス数 | 200（MVP）／500（拡張） |
| レスポンス閾値 | 2秒以下 |
| 翻訳APIレイテンシ | 5秒以内／500文字 |
| テナント追加時の影響 | RLS＋キャッシュで限定的 |

---

## 第11章 拡張フェーズ計画

### 11.1 フェーズ概要
HarmoNetの機能拡張は以下4フェーズで計画される。

| フェーズ | 期間 | 主な追加機能 |
|----------|------|---------------|
| Phase1 | MVPリリース | 掲示板・お知らせ・駐車場予約・通知・マイページ |
| Phase2 | +6ヶ月 | 安否確認・監視カメラ・住宅設備／消耗品照会 |
| Phase3 | +1年 | HEMS連携・AI自動翻訳最適化・マルチテナント強化 |
| Phase4 | +2年 | IoT統合・コミュニティ拡張・分析レポート |

---

### 11.2 Phase2 詳細：住宅設備／消耗品照会・発注機能

**目的:**  
住宅設備機器や共用部消耗品の交換・発注をオンラインで管理する。  
住民が自宅設備の型番・部品情報を照会し、在庫・再注文を容易に行える仕組みを提供する。

**機能概要:**
- 設備／部品マスタ参照（管理会社登録）  
- 型番・カテゴリ検索  
- 消耗品リスト（例：換気フィルタ・電球・電池）  
- 発注フォーム（数量・備考入力）  
- 注文履歴・再注文機能  
- 外部API連携（管理会社またはECサイト）  

**データモデル例:**
| テーブル | 主目的 |
|-----------|----------|
| consumables_items | 消耗品マスタ（型番・カテゴリ） |
| consumables_orders | 発注履歴（テナント単位） |
| consumables_suppliers | 仕入先情報 |

**テーブルサンプル:**  
```sql
CREATE TABLE consumables_items (
  id SERIAL PRIMARY KEY,
  tenant_id UUID NOT NULL,
  item_name TEXT,
  category TEXT,
  model_number TEXT,
  stock_count INT DEFAULT 0,
  supplier_id INT,
  updated_at TIMESTAMP DEFAULT now()
);
```

**UI想定:**  
ホーム画面タイル「🛒 消耗品」→ 一覧／検索／注文履歴。

**管理画面:**  
管理者が品目登録・在庫調整を行える。

---

### 11.3 Phase3〜4 ハイライト

**Phase3:**  
- HEMSデータ連携（電力使用量グラフ表示）  
- AI翻訳精度最適化（Claude連携）  
- 行動解析ベースのスマート通知  
- フルマルチテナント化（デベロッパー横断）  

**Phase4:**  
- IoT／スマートホーム統合（ロック・センサー）  
- コミュニティ拡張（イベント・物品貸借）  
- AI要約・管理ボット機能  
- 統計・予測分析ダッシュボード  

---

## 第12章 リスク・対策

| リスク | 影響度 | 対策 |
|--------|----------|------|
| Supabase API障害 | 高 | バックアップ環境用意・リトライ |
| 翻訳API超過 | 中 | キャッシュ・差分翻訳 |
| データ越権アクセス | 高 | RLS＋アプリ層検証 |
| テナント設定破損 | 中 | バージョン管理・バックアップ |
| ユーザー離脱 | 高 | UX改善・説明会開催 |
| コスト増大 | 中 | 無料枠モニタリング・段階プランアップ |
| AI連携停止 | 中 | Claude/Gemini/GPT代替切替ポリシー |

---

## 第13章 付録／参照資料

### 13.1 関連ドキュメント
| 名称 | 内容 |
|------|------|
| HarmoNet 機能要件定義書 v1.2 | 機能・非機能要件総覧 |
| HarmoNet デザインガイドライン | UI/UXルール定義 |
| HarmoNet API仕様書 | APIエンドポイント定義 |
| HarmoNet DB設計書 | Prismaスキーマ・ER図 |
| HarmoNet セキュリティガイドライン | 暗号化・RLSポリシー |
| HarmoNet 運用マニュアル | 管理者向け運用手順 |

---

### 13.2 用語集
| 用語 | 意味 |
|------|------|
| テナント | 管理単位（住宅群・管理組合） |
| RLS | Row Level Security。テナント間分離方式 |
| consumables | 住宅設備・消耗品照会機能 |
| Phase | 開発フェーズ（MVP以降の拡張） |
| AI協調開発 | Claude, Gemini, GPTによる分担開発 |

---

### 13.3 Claude登録用サマリー（1ページ版）

**HarmoNet マルチテナント設計仕様書 v1.1（2025-10-30 改訂）**  
- 構成: Vercel + Supabase (RLS対応)  
- テーブル: tenant / tenant_user / tenant_features / tenant_settings / consumables_*  
- 新規追加機能: 消耗品照会・発注（Phase2）  
- Row Level Security: Supabase JWTポリシーによるtenant_id隔離  
- Prismaミドルウェアによるtenant_id自動付与  
- AI開発体制: Claude（UX）＋Gemini（Infra）＋GPT（PMO/Docs）  
- 今後の拡張: HEMS・IoT連携・スマート通知・AI分析  

---

