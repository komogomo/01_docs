# SA-00 システム管理者ログイン画面 詳細設計書 v1.0

**Document ID:** SA-00-SysAdmin-Login-Detail-Design
**Version:** 1.0
**Screen ID:** SA-00 SysAdmin Login
**Path:** `/sys-admin/login`

---

## 1. 概要

### 1.1 目的

本画面は、システム管理者（`system_admin`）専用のログイン画面である。
一般ユーザ・テナント管理者向けのログイン画面（`/login`）とは明確に分離し、システム管理者が誤って一般テナント領域にログインしたり、その逆を防ぐことを目的とする。

### 1.2 前提

* 認証方式は Supabase Auth の MagicLink（メールリンク認証）を利用する。
* パスワード認証は使用しない。
* システム管理者は、事前に DB 上で `system_admin` ロールを付与されている必要がある。

---

## 2. 画面仕様

### 2.1 レイアウト

* **専用レイアウト** (`/sys-admin/login/layout.tsx` 相当) を適用する。
  * ヘッダー・フッターは最小限、または非表示とし、ログインフォームに集中させる。
  * 画面中央にログインカードを配置する。
  * 背景色やロゴなどで、一般ログイン画面とは異なる「システム管理用」であることを視覚的に区別する（例: ヘッダーに "System Admin Console" と表示）。

### 2.2 表示要素

1. **画面タイトル**
   * 「システム管理コンソール ログイン」

2. **説明テキスト**
   * 「システム管理者用のアカウントでログインしてください。」

3. **入力フォーム**
   * **メールアドレス**
     * 型: email
     * 必須: true
     * プレースホルダー: `admin@example.com`

4. **アクションボタン**
   * **「ログインリンクを送信」**
     * 押下で MagicLink 送信処理を実行。

5. **リンク**
   * 「一般ログインはこちら」（`/login` へのリンク）

---

## 3. ロジック仕様

### 3.1 ログインフロー

1. ユーザがメールアドレスを入力し、「ログインリンクを送信」ボタンを押下。
2. フロントエンドから Supabase Auth の `signInWithOtp` (MagicLink) を呼び出す。
   * **Redirect URL**: `/sys-admin/auth/callback` (システム管理専用のコールバック)
3. Supabase からメール送信。
4. 画面は「メール送信完了」状態に切り替わる。
   * 「ログイン用のリンクをメールで送信しました。メールを確認してログインしてください。」

### 3.2 認証コールバック (`/sys-admin/auth/callback`)

1. メール内のリンクをクリックすると、`/sys-admin/auth/callback` に遷移する。
2. サーバサイドで Auth Code を Session に交換する。
3. **権限チェック (重要)**:
   * ログインしたユーザが `system_admin` ロールを持っているか確認する。
   * **チェック方法**: `getSystemAdminContext` ヘルパー、または同等のロジックを使用。
4. 分岐:
   * **OK (`system_admin` あり)**:
     * `/sys-admin/tenants` (SA-01) へリダイレクト。
   * **NG (`system_admin` なし)**:
     * セッションを破棄（ログアウト）。
     * `/sys-admin/login?error=unauthorized` へリダイレクト。

### 3.3 エラーハンドリング

| エラー種別 | 画面表示メッセージ | 備考 |
| :--- | :--- | :--- |
| 入力エラー | 「有効なメールアドレスを入力してください。」 | クライアントサイドバリデーション |
| 送信エラー | 「メールの送信に失敗しました。時間をおいて再度お試しください。」 | API エラー時 |
| 権限なし | 「システム管理者権限がありません。」 | コールバック後のリダイレクト時 |

---

## 4. 認証ガードとの連携

本画面自体は「未認証状態」でアクセス可能であるため、Middleware による保護対象外（public route）とする。
ただし、ログイン後の遷移先（`/sys-admin/*`）は全て厳格に保護される。

* **Middleware (`proxy.ts`)**:
  * `/sys-admin/login` はパススルーさせる。
  * 既にログイン済みで `/sys-admin/login` にアクセスした場合:
    * `system_admin` 権限があれば `/sys-admin/tenants` へリダイレクト。
    * 権限がなければそのまま表示（または `/home` へ誘導）。

---

## 5. 変更履歴

| Version | 日付       | 変更内容 |
| :--- | :--- | :--- |
| 1.0     | 2025-12-01 | 初版作成。 |
