# テナント管理者用ユーザ登録画面 詳細設計書 ch01（画面＋ロジック統合版） v1.1

**Document ID:** HARMONET-DD-TADMIN-USER-REGIST-CH01  
**Version:** 1.1  
**Screen ID:** T-01 TenantUserManagement  
**Path:** `/t-admin/users`

---

## 変更履歴

| Version | 日付       | 変更内容                                                                 |
| ------- | ---------- | ------------------------------------------------------------------------ |
| 1.0     | 2025-xx-xx | 初版作成                                                                |
| 1.1     | 2025-xx-xx | `/t-admin/users` の実装内容に合わせて、画面仕様・API・テーブル利用を更新 |

---

## 1. 画面概要

### 1.1 目的

- `tenant_admin` が、自テナントに所属する利用者（一般ユーザ／テナント管理者）を登録・更新・削除する。

### 1.2 前提

- 認証は Supabase Auth（MagicLink）を利用する。
- 認証コールバック後、`user_tenants` をもとに有効な `tenant_id` が 1 つに確定している。
- 本画面にアクセスできるのは、現在テナントに対して `tenant_admin` ロールを持つユーザのみとする。
- 一時停止／復活／audit／論理削除は扱わない。  
  退会・退去・所属解除は `user_tenants`／`user_roles`／`users`／`auth.users` の **行 DELETE** で対応する。
- 関連テーブルは以下に限定する。

  - `tenants` … テナントマスタ
  - `users` … アプリユーザマスタ（氏名・ふりがな・ニックネーム・住居番号等を保持）
  - `user_tenants` … ユーザ×テナント所属
  - `roles` / `user_roles` … ロール情報（`tenant_admin` / `general_user` 等）

### 1.3 機能範囲

- 自テナントユーザ一覧表示
- フィルタ（キーワード検索）
- ユーザ登録

  - メールアドレス
  - 氏名・ふりがな
  - ニックネーム
  - グループID
  - 住居番号
  - ロール
  - 言語（ベース言語）

- 自テナントユーザ情報の更新
- 自テナントからのユーザ削除
  - 対象ユーザが他テナントにも所属している場合:  
    当該テナントでの `user_roles` / `user_tenants` のみ削除。
  - 対象ユーザが本テナントのみに所属している場合:  
    `user_roles` / `user_tenants` / `users` / `auth.users` を削除。

### 1.4 画面遷移・入口

- 本画面 `/t-admin/users` は、ログイン後ホーム画面に表示される  
  「テナント管理」カードから遷移する。
- ホーム画面の「テナント管理」カード:

  - 表示ラベル: 「テナント管理」
  - 遷移先パス: `/t-admin/users`
  - 表示条件:
    - ログインユーザが、現在選択中テナントに対して `tenant_admin` ロールを持つ場合のみ表示。
    - `tenant_admin` ロールを持たないユーザにはカードを表示しない。

---

## 2. 画面構成

### 2.1 レイアウト

- PC 向け画面。
- `/t-admin` レイアウト配下に配置する。

  - 左: テナント管理メニュー
    - セクション見出し: 「テナント管理」
    - メニュー項目: 「ユーザ管理」（`/t-admin/users`）
  - 右: 本画面コンテンツ。

- 右コンテンツは以下の 3 セクションで構成する。

  1. SEC-01: テナント名表示エリア
  2. SEC-02: ユーザ登録・更新フォーム
  3. SEC-03: ユーザ一覧テーブル（検索・ソート・ページネーションを含む）

### 2.2 SEC-01 テナント名表示

- 要素:

  - テナント名: `{tenant_name}` を中央に表示するテキスト。

- 取得元:

  - セッションの `tenant_id` を用い `tenants` から `tenant_name` を取得。
  - 取得した `tenant_name` を画面コンポーネントに渡して表示する。

### 2.3 SEC-02 ユーザ登録・更新フォーム

#### 2.3.1 フォーム項目

| No | UI項目ID           | ラベル         | 型      | 必須 | 備考                                             |
|----|--------------------|---------------|---------|------|--------------------------------------------------|
| 1  | input_email        | メールアドレス | email   | ○    | ログイン用メールアドレス                        |
| 2  | input_fullName     | 氏名           | text    | ○    | 住民氏名（フルネーム）                          |
| 3  | input_fullNameKana | ふりがな       | text    | ○    | 氏名のふりがな                                  |
| 4  | input_displayName  | ニックネーム   | text    | ○    | 掲示板等での表示名                              |
| 5  | input_groupCode    | グループID     | text    | 任意 | 任意文字列（例: 北A, 南B 等）                   |
| 6  | input_residence    | 住居番号       | text    | 任意 | 例: 101, A-1203 等                               |
| 7  | select_role        | ロール         | select  | ○    | `tenant_admin` / `general_user`                 |
| 8  | select_language    | 言語           | select  | 任意 | `ja/en/zh`。未選択時は `ja` を使用              |

#### 2.3.2 画面上の挙動

- 新規登録モード:

  - 各入力欄に値を入力し、「ユーザ登録」ボタン押下で `POST /api/t-admin/users` を呼び出す。

- 編集モード:

  - 一覧テーブル行の「編集」ボタン押下で、該当ユーザの値をフォームに展開し、モードを「更新」に切り替える。
  - 「更新」ボタン押下で `PUT /api/t-admin/users` を呼び出す。
  - 編集中に「キャンセル」押下で編集状態を解除し、フォームを初期化する。
  - 編集中に「新規登録」ボタンを押下した場合は、編集対象とは別のユーザとして `POST` する。

- メールアドレス存在チェック:

  - 編集モードでは、メールアドレス変更時に `/api/t-admin/users/check-email` を非同期で呼び出し、
    既存ユーザの存在を確認する。
  - 更新時に、存在しないメールアドレスが入力されている場合はエラーメッセージが表示され、更新を行わない。

### 2.4 SEC-03 ユーザ一覧テーブル

#### 2.4.1 列定義

| No | 表示ラベル     | 項目ID          | 内容                                   |
|----|----------------|-----------------|----------------------------------------|
| 1  | メールアドレス | `email`         | `users.email`                          |
| 2  | ニックネーム   | `displayName`   | `users.display_name`                   |
| 3  | 氏名           | `fullName`      | `users.full_name`                      |
| 4  | ふりがな       | `fullNameKana`  | `users.full_name_kana`                 |
| 5  | グループID     | `groupCode`     | `users.group_code`                     |
| 6  | 住居番号       | `residenceCode` | `users.residence_code`                 |
| 7  | 言語           | `language`      | `users.language` (`ja/en/zh` → JA/EN/ZH 表示) |
| 8  | ロール         | `roleKey`       | `roles.role_key`（tenant_admin/general_user） |
| 9  | 操作           | `actions`       | 「編集」「削除」ボタン                 |

#### 2.4.2 検索・ソート・ページネーション

- 検索:

  - 画面の検索欄にキーワードを入力し「検索」押下でフィルタを適用。
  - 対象:
    - メールアドレス
    - ニックネーム
    - 氏名
    - ふりがな
    - グループID
    - 住居番号
    - ロール表示ラベル（テナント管理者／一般ユーザ）

- ソート:

  - 各列ヘッダをクリックで昇順／降順を切り替え。

- ページネーション:

  - 「表示件数」選択（25/50/100）と「前へ／次へ」ボタンでページ遷移。

- 行操作:

  - 編集:
    - 「編集」ボタンで対象ユーザをフォームにロードし、編集モードに切り替える。
  - 削除:
    - 「削除」ボタンで確認モーダルを表示し、確定で削除 API を呼び出す。

---

## 3. 入出力仕様

### 3.1 入力バリデーション（画面・API共通の前提）

- 必須チェック:

  - メールアドレス、氏名、ふりがな、ニックネーム、ロールは必須。
  - グループID・住居番号・言語は任意。言語未指定時は `"ja"` を利用。

- 一意性チェック（サーバ側）:

  - メールアドレス: `users.email` の全テナント横断で一意。
  - ニックネーム: `users.display_name` の全テナント横断で一意。

- 文字種・長さ等の詳細な制約は、DB スキーマおよび共通バリデーションポリシーに従う。

### 3.2 出力

- 正常終了時は、画面上部のメッセージ領域に成功メッセージを表示し、ユーザ一覧を再読み込みする。
- エラー時は、エラー種別に応じたメッセージを表示し、入力値を保持したままにする。

---

## 4. API 詳細

### 4.1 共通事項

- すべての API は Supabase Auth のセッションを前提とする。
- セッションが取得できない場合は 401 を返し、フロント側でログイン画面に誘導する。
- すべての API で、呼び出しユーザが現在テナントの `tenant_admin` ロールを持つことを確認する。

---

### 4.2 ユーザ一覧取得 API

- メソッド: `GET`  
- パス: `/api/t-admin/users`  
- クエリパラメータ:
  - `q=キーワード`（任意）

#### 4.2.1 挙動

1. セッション・`tenant_id` を取得。
2. `user_tenants` から `tenant_id` 一致の行を取得。
3. `users` / `user_roles` を用いて一覧 DTO を構成。
4. `q` が指定されている場合、email / display_name / full_name に対して部分一致フィルタ。

#### 4.2.2 レスポンス

```json
[
  {
    "userId": "uuid",
    "email": "string",
    "displayName": "string",
    "fullName": "string",
    "fullNameKana": "string",
    "groupCode": "string|null",
    "residenceCode": "string|null",
    "roleKey": "tenant_admin|general_user",
    "language": "ja|en|zh"
  }
]
```

---

### 4.3 ユーザ登録 API

- メソッド: `POST`  
- パス: `/api/t-admin/users`

#### 4.3.1 リクエストボディ（JSON）

```json
{
  "email": "string",
  "fullName": "string",
  "fullNameKana": "string",
  "displayName": "string",
  "groupCode": "string|null",
  "residenceCode": "string|null",
  "roleKey": "tenant_admin|general_user",
  "language": "ja|en|zh|null"
}
```

#### 4.3.2 挙動

1. セッション確認。存在しない場合は 401。
2. `user_tenants` から現在の `tenant_id` を取得。
3. 入力バリデーション（必須、一意性チェックなど）を実施。
4. `users` テーブルでメールアドレス重複を確認。存在する場合は 409(CONFLICT)。
5. `users` テーブルでニックネーム重複を確認。存在する場合は 409(CONFLICT)。
6. `auth.users` を確認／作成し、`targetUserId` を確定。
7. `users` に upsert:
   - `id = targetUserId`
   - `tenant_id`, `email`, `display_name`, `full_name`, `full_name_kana`, `group_code`, `residence_code`, `language` などを保存／更新。
8. `roles` から `role_key` に対応する `id` を取得し、`user_roles` に登録。
9. `user_tenants` に `(user_id, tenant_id)` を登録。
10. 成功レスポンスを返却。

#### 4.3.3 レスポンス

- 成功時 (200):

```json
{
  "ok": true,
  "message": "ユーザを登録しました。"
}
```

- バリデーションエラー時 (400):

```json
{
  "ok": false,
  "errorCode": "VALIDATION_ERROR",
  "message": "入力内容を確認してください。"
}
```

- 一意性違反時 (409):

```json
{
  "ok": false,
  "errorCode": "CONFLICT",
  "message": "このメールアドレスは既に使用されています。"
}
```

- 内部エラー時 (500):

```json
{
  "ok": false,
  "errorCode": "INTERNAL_ERROR",
  "message": "サーバーエラーが発生しました。"
}
```

---

### 4.4 ユーザ更新 API

- メソッド: `PUT`  
- パス: `/api/t-admin/users`

#### 4.4.1 リクエストボディ（JSON）

```json
{
  "userId": "string",
  "email": "string",
  "fullName": "string",
  "fullNameKana": "string",
  "displayName": "string",
  "groupCode": "string|null",
  "residenceCode": "string|null",
  "roleKey": "tenant_admin|general_user",
  "language": "ja|en|zh|null"
}
```

#### 4.4.2 挙動

1. セッション確認・`tenant_id` 取得。
2. 必須項目のバリデーション。
3. `users` でメールアドレス重複を確認（`id != userId`）。
4. `users` でニックネーム重複を確認（`id != userId`）。
5. `user_tenants` で `(user_id = userId, tenant_id = 現在テナント)` の存在を確認。
6. 必要に応じて `auth.users` の `email`／`表示名` を更新。
7. `users` テーブルを更新。
8. `roles` / `user_roles` を用いて、ロールが変更されている場合のみ `user_roles` を更新。
9. 成功レスポンスを返却。

---

### 4.5 ユーザ削除 API

- メソッド: `DELETE`  
- パス: `/api/t-admin/users`

#### 4.5.1 リクエストボディ（JSON）

```json
{
  "userId": "<users.id>"
}
```

#### 4.5.2 挙動

1. セッション確認・`tenant_id` 取得。
2. `users` で `(id = userId, tenant_id = 現在テナント)` の存在を確認。
3. 当該テナントの `user_roles` を削除。
4. 当該テナントの `user_tenants` 行を削除。
5. `user_tenants` で `userId` の残り所属数をカウント。
   - 他テナント所属が 1 件以上存在する場合: これ以上削除は行わない。
   - 他テナント所属が 0 件の場合:
     - `users` から当該ユーザを削除。
     - `auth.users` からも削除。
6. 成功レスポンスを返却。

#### 4.5.3 レスポンス

```json
{
  "ok": true,
  "message": "ユーザを削除しました。"
}
```

---

### 4.6 メールアドレス存在チェック API

- メソッド: `POST`  
- パス: `/api/t-admin/users/check-email`

#### 4.6.1 リクエストボディ（JSON）

```json
{
  "email": "string"
}
```

#### 4.6.2 挙動

1. セッション確認・`tenant_id`／`tenant_admin` ロール確認。
2. `users` テーブルで `email` 一致のレコードを検索。
3. 存在有無を `exists: boolean` で返却。

#### 4.6.3 レスポンス

```json
{
  "ok": true,
  "exists": true
}
```

---

## 5. メッセージ仕様（日本語案）

### 5.1 成功メッセージ

| コード                           | 文言                      |
|----------------------------------|---------------------------|
| `tadmin.users.create.success`    | ユーザを登録しました。    |
| `tadmin.users.update.success`    | ユーザ情報を更新しました。|
| `tadmin.users.delete.success`    | ユーザを削除しました。    |

### 5.2 エラーメッセージ

| コード                              | 文言                         |
|-------------------------------------|------------------------------|
| `tadmin.users.error.validation`     | 入力内容を確認してください。 |
| `tadmin.users.error.unauthorized`   | 再度ログインし直してください。 |
| `tadmin.users.error.internal`       | サーバーエラーが発生しました。 |

---

## 6. テスト観点

### 6.1 前提データ・共通前提

- `tenant_admin` ロールを現在テナントに対して持つユーザ A が存在すること。
- `tenant_admin` ロールを持たない一般ユーザ B が存在すること。
- テスト用メールアドレスやニックネームは、一意性制約を満たすように準備しておくこと。
- 対象テナントに既存のユーザが 0 件／複数件の両パターンを用意できるとなお良い。

### 6.2 認証・権限

- ユーザ A（tenant_admin）でログインした場合に `/t-admin/users` へアクセスできること。
- ユーザ B（tenant_admin ではない）でログインした場合に `/t-admin/users` に直接アクセスすると、
  - `/home` など適切な場所へリダイレクトされること。
- セッションが切れている状態で `/t-admin/users` にアクセスした場合、
  - `/login?error=...` へリダイレクトされること。

### 6.3 HOME 画面からの遷移

- ユーザ A でログインした場合:
  - HOME に「テナント管理」タイルが表示されること。
  - タイル押下で `/t-admin/users` が表示されること。
- ユーザ B でログインした場合:
  - HOME に「テナント管理」タイルが表示されていないこと。

### 6.4 ユーザ一覧表示

- 対象テナントにユーザが 0 件の場合:
  - 一覧に「ユーザが登録されていません。」等のメッセージが表示されること。
- ユーザが複数存在する場合:
  - `email` / `displayName` / `fullName` / `fullNameKana` / `groupCode` / `residenceCode` / `language` / `roleKey`
    がテーブルに正しく表示されること。
- 言語カラムが `ja/en/zh` → `JA/EN/ZH` のラベルで表示されること。
- ロールが `tenant_admin` の行は「テナント管理者」、`general_user` の行は「一般ユーザ」と表示されること。

### 6.5 検索・ソート・ページネーション

- 検索欄にキーワードを入力して検索した場合:
  - 対象カラム（メール／ニックネーム／氏名／ふりがな／グループID／住居番号／ロール）が部分一致でフィルタされること。
- 検索条件クリアボタン押下で、全件表示に戻ること。
- 各列ヘッダをクリックしたとき:
  - 昇順／降順が切り替わり、表示順が変わること。
- 表示件数を 25 / 50 / 100 に切り替えたとき:
  - 1 ページあたりの表示行数が切り替わること。
- データ件数が 2 ページ以上ある場合:
  - 「前へ」「次へ」ボタンでページが正しく切り替わること。

### 6.6 ユーザ登録

- 必須項目（メール／氏名／ふりがな／ニックネーム／ロール）をすべて入力して「ユーザ登録」した場合:
  - 成功メッセージが表示されること。
  - 一覧に新規ユーザが表示されること。
  - `users`／`user_tenants`／`user_roles` にレコードが作成されていること。
- 任意項目（グループID／住居番号／言語）を空で登録した場合:
  - 正常に登録されること。
  - 言語が指定なしの場合は `ja` で保存されること。
- メールアドレスが既存ユーザと重複している場合:
  - エラーになり、適切なメッセージが表示されること。
  - DB 側に二重登録されていないこと。
- ニックネームが既存ユーザと重複している場合も同様にエラーになること。
- 登録エラー時に、フォーム入力値が保持されていること。

### 6.7 ユーザ更新

- 一覧から任意のユーザ行で「編集」を押下した場合:
  - フォームに選択ユーザの値が反映されること。
  - 登録ボタンのラベルが「更新」表示になる等、編集モードであることがわかること。
- 氏名・ふりがな・ニックネーム・ロールなどを変更して「更新」した場合:
  - 成功メッセージが表示されること。
  - 一覧に変更内容が反映されること。
  - `users`／`user_roles` が更新されていること。
- 編集モードでメールアドレスを変更した場合:
  - `/api/t-admin/users/check-email` による存在確認が行われること。
  - 存在しないメールの場合はエラーメッセージが表示され、更新が行われないこと。
- 必須項目を空にして更新した場合:
  - バリデーションエラーとなり、エラーメッセージが表示されること。
- 「キャンセル」押下で編集モードが解除され、フォームが初期状態に戻ること。

### 6.8 ユーザ削除

- 一覧からユーザ行の「削除」を押下した場合:
  - 確認モーダルが表示されること。
  - 「キャンセル」で削除されないこと。
  - 「OK」で削除 API が呼ばれ、成功メッセージが表示されること。
  - 一覧から当該ユーザが消えていること。
- DB 確認:
  - 当該ユーザが他テナントに所属していない場合:
    - `user_roles` / `user_tenants` / `users` / `auth.users` に当該ユーザのレコードが存在しないこと。
  - 他テナントにも所属している場合:
    - 対象テナントの `user_roles` / `user_tenants` のみ削除されていること。
    - 他テナント向けの所属情報と `users` / `auth.users` が残っていること。

### 6.9 異常系・エラー表示

- セッション切れや認証エラーが発生した場合:
  - 適切なエラーメッセージ・リダイレクトが行われること。
- 内部エラー（DB エラーなど）発生時:
  - 画面上に汎用エラーメッセージ（`tadmin.users.error.internal` 相当）が表示されること。
  - コンソールやサーバログにエラー詳細が記録されていること。
- 画面リロード後も異常な状態（中途半端な登録／更新結果）が残っていないこと。
