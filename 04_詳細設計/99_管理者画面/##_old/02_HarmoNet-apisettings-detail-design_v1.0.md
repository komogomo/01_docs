# HarmoNet 詳細設計書: テナント別 API 設定（AI設定画面） v1.0

## 1. 概要

本書は、テナント管理者向けの「AI設定」画面と、その背後で利用する外部 API 設定の詳細仕様を定義する。

対象とする API は以下の 3 つに限定する。

* Google Translate API（動的翻訳）
* Google Cloud Text-to-Speech（音声読み上げ）
* OpenAI AI Moderation（投稿チェック）

テナント管理者は、本画面から上記 API の「挙動」に関わる設定のみを変更できる。API キーやプロジェクト ID などのインフラ設定は、システム管理者が環境変数等で一元管理し、本画面には一切出さない。

## 2. 画面配置とナビゲーション

### 2.1 メニュー階層

テナント管理者向けメニューに、既存の「ユーザ管理」と同階層で「AI設定」を追加する。

* テナント管理（t-admin）

  * ユーザ管理
  * **AI設定**（本書の対象）

「AI設定」はサブメニューを持たない単一画面とし、URL は `/t-admin/ai`（仮）とする。

### 2.2 画面構成

AI設定画面は 1 画面完結型とし、以下 3 ブロックで構成する。

1. 翻訳（Google Translate）
2. AIモデレーション（OpenAI）
3. 音声読み上げ（Google TTS）

ページ全体の構成は、既存のテナント管理画面（ユーザ管理）と同一トーンを踏襲する。

* ヘッダー

  * 上部にテナント名（例: 「セキュレアシティ研究学園」）
  * その下にページタイトル「AI設定」
  * 右上に「保存」ボタン
* 左サイドメニュー

  * 「ユーザ管理」「AI設定」の 2 項目
* コンテンツエリア

  * 中央にカードを 1 枚配置し、その内部を 3 セクションに分割（翻訳 / モデレーション / 読上げ）
  * 下部または右下に「保存」ボタン（ヘッダーと同一動作）

## 3. 設定項目（テナント別 API 設定）

### 3.1 共通方針

* 当面の対象は掲示板機能に関わる API 設定のみとする。
* テナント管理者が変更できるのは「挙動」に関わる項目のみとし、API キー、エンドポイント URL、プロジェクト ID 等は対象外とする。
* 設定値は `tenant_settings` テーブル（例: `config_json`）に格納し、バックエンド API はこの設定値に基づいて各 API を呼び出す。

以降、各 API ごとにテナント管理者が編集可能な項目と UI を定義する。

---

### 3.2 翻訳（Google Translate）

#### 3.2.1 概要

掲示板投稿およびコメントの動的翻訳に関する設定を行う。翻訳結果のキャッシュ有無もテナントごとに切り替え可能とする。

#### 3.2.2 設定項目

1. **翻訳を有効にする**

   * 種別: boolean
   * 画面: チェックボックスまたはトグル
   * ラベル: 「翻訳を有効にする」
   * 挙動:

     * ON: 掲示板投稿（＋コメント）を Google Translate API で翻訳し、多言語 UI に表示する。
     * OFF: 翻訳 API を呼び出さず、投稿元言語のみ表示する。

2. **利用言語**

   * 種別: string[]
   * 画面: チェックボックス（複数選択）
   * ラベル: 「利用言語」
   * 選択肢:

     * 英語
     * 中国語
   * 備考:

     * 日本語は常に利用言語とみなし、UI 上の選択肢には出さない（固定）。
     * チェックされた言語が、掲示板の言語切替や翻訳対象となる。

3. **翻訳結果をキャッシュする**

   * 種別: boolean
   * 画面: チェックボックス
   * ラベル: 「翻訳結果をキャッシュする」
   * 挙動:

     * ON: 一度翻訳した結果を DB（翻訳キャッシュテーブル）に保存し、次回以降はキャッシュを利用する。
     * OFF: 毎回 Google Translate API を呼び出す（実運用では基本 ON 想定）。

#### 3.2.3 UI レイアウト（翻訳セクション）

カード内セクション構成（上から順）：

1. セクションタイトル: 「翻訳（Google Translate）」
2. フィールド:

   * [ ] 翻訳を有効にする
   * 利用言語

     * [ ] 英語
     * [ ] 中国語
   * [ ] 翻訳結果をキャッシュする

---

### 3.3 AIモデレーション（OpenAI）

#### 3.3.1 概要

掲示板投稿およびコメントの内容について、OpenAI のモデレーション API による自動チェックを行うための設定を行う。

#### 3.3.2 設定項目

1. **モデレーションレベル**

   * 種別: enum
   * 値:

     * `off` … モデレーションを行わない
     * `level1` … 通常レベルのチェック
     * `level2` … より厳しめのチェック
   * 画面: セレクトボックス（またはラジオボタン）
   * ラベル: 「モデレーションレベル」
   * 挙動:

     * `off`: OpenAI モデレーション API を呼び出さない。
     * `level1` / `level2`: 閾値やカテゴリマッピングはバックエンド側実装に委ねる（本画面ではレベル名のみ管理）。

2. **チェック対象**

   * 種別: オブジェクト（boolean の組み合わせ）

     * `posts`: 掲示板投稿
     * `comments`: コメント（返信）
   * 画面: チェックボックス
   * ラベル: 「チェック対象」
   * 挙動:

     * 「掲示板投稿」にチェック → 投稿本文をモデレーション対象とする。
     * 「コメント」にチェック → コメント本文をモデレーション対象とする。

#### 3.3.3 UI レイアウト（AIモデレーションセクション）

カード内セクション構成（上から順）：

1. セクションタイトル: 「AIモデレーション（投稿チェック）」
2. フィールド:

   * モデレーションレベル（セレクト）

     * オフ
     * レベル1
     * レベル2
   * チェック対象

     * [ ] 掲示板投稿
     * [ ] コメント

---

### 3.4 音声読み上げ（Google Cloud Text-to-Speech）

#### 3.4.1 概要

掲示板投稿の音声読み上げ（Text To Speech）に関する設定を行う。機能自体の有効/無効および対象言語 ON/OFF はテナント管理者には開放せず、

* 音声読み上げ機能は常に有効
* 対応言語は全て有効（日本語 / 英語 / 中国語）

とする。テナント管理者は、「読み上げる声のプリセット」と「読み上げ速度」のみを調整できる。

#### 3.4.2 設定項目

1. **読み上げ音声（プリセット）**

   * 種別: enum（プリセットキー）
   * 画面: セレクトボックス
   * ラベル: 「読み上げ音声」
   * 値（例）:

     * `preset_ja_standard` … 標準（日本語・ニュートラル）
     * `preset_ja_soft_female` … 落ち着いた女性（日本語）
     * `preset_ja_soft_male` … 落ち着いた男性（日本語）
   * 備考:

     * 実際の Google TTS `voiceName` は、バックエンドでプリセットキーにマッピングする。
     * テナント設定画面では、ユーザに分かりやすい日本語ラベルのみを表示する。

2. **読み上げ速度**

   * 種別: enum
   * 画面: セレクトボックス
   * ラベル: 「読み上げ速度」
   * 値:

     * `slow` … ゆっくり
     * `normal` … 標準
     * `fast` … 速い
   * 挙動:

     * TTS リクエスト時の `speakingRate` にマッピングする（具体値はバックエンド実装で定義）。

#### 3.4.3 UI レイアウト（音声読み上げセクション）

カード内セクション構成（上から順）：

1. セクションタイトル: 「音声読み上げ（Text To Speech）」
2. 説明テキスト（固定）

   * 「掲示板投稿の読み上げ設定です。機能は常に有効です。全対応言語で読み上げ可能です。」
3. フィールド:

   * 読み上げ音声（セレクト）

     * 標準（日本語）
     * 落ち着いた女性（日本語）
     * 落ち着いた男性（日本語）
   * 読み上げ速度（セレクト）

     * ゆっくり
     * 標準
     * 速い

---

## 4. 設定値の保存先と JSON 構造

### 4.1 保存先テーブル

テナント別の設定値はすべて `public.tenant_settings` テーブルで管理する。

* `tenant_id` : uuid / text

  * `public.tenants.id` と 1:1 で対応するテナント識別子。
  * JSON 設定値のキーではなく、**レコードの主キー側**でテナントを特定する。
* `config_json` : jsonb

  * 当該テナントに紐づくすべての設定値をまとめて保持する。
  * 本書で定義した API 設定（翻訳 / 音声読み上げ）は、この `config_json` 配下に格納する。

### 4.2 JSON 構造（board 配下）

掲示板関連の設定値は `config_json.board` 配下にまとめる。
ここでは AI 設定画面で編集可能な値のみを対象とする。

```jsonc
{
  "board": {
    "translation": {
      "enabled": true,
      "enabledLanguages": ["EN", "ZH"],
      "cacheEnabled": true,
      "cacheRetentionDays": 30
    },
    "tts": {
      "voicePreset": "preset_ja_standard",
      "speakingRate": "normal"
    }
  }
}
```

* `translation.enabled` : boolean

  * デフォルト: `true`

* `translation.enabledLanguages` : string[]

  * 許可値: `"EN"`, `"ZH"`（**大文字2文字コード**）。
  * 日本語は常に利用言語とみなし、本配列には含めない。
  * デフォルト: `["EN", "ZH"]`

* `translation.cacheEnabled` : boolean

  * デフォルト: `true`

* `translation.cacheRetentionDays` : number

  * 単位: 日
  * 範囲: 1〜365
  * デフォルト: `30`

* `tts.voicePreset` : string（プリセットキー）

  * 許可値例:

    * `"preset_ja_standard"` … 標準（日本語）
    * `"preset_ja_soft_female"` … 落ち着いた女性（日本語）
    * `"preset_ja_soft_male"` … 落ち着いた男性（日本語）
  * デフォルト: `"preset_ja_standard"`
  * 実際の Google TTS `voiceName` はバックエンド側でプリセットキーにマッピングする。

* `tts.speakingRate` : string

  * 許可値: `"slow"`, `"normal"`, `"fast"`
  * デフォルト: `"normal"`
  * Google TTS の `speakingRate` 数値への変換はバックエンド実装で定義する。

### 4.3 AIモデレーション設定の扱い

OpenAI AI Moderation は、掲示板投稿およびコメントに対して **常に有効** とし、
テナント管理者が変更できる項目は持たない。

* モデレーションレベル、対象種別（投稿/コメント）はシステム固定値としてコード側に保持する。
* `config_json` に AIモデレーション用の設定キーは原則として定義しない。
* 必要に応じて内部実装用に JSON キーを追加する場合も、
  テナント管理画面からは非表示とする。

---

以降の章では、`tenant_settings.config_json` を更新するテナント設定 API のエンドポイント仕様
（リクエスト/レスポンス定義、バリデーション、デフォルト値適用ロジック）を定義する。
