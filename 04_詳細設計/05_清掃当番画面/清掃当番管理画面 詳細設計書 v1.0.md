# 清掃当番管理画面 詳細設計書 v1.0

## 0. メタ情報

* ドキュメントID: C-XX-CleaningDuty-DetailDesign
* 対象画面: 清掃当番管理画面（ホーム画面 機能タイル遷移）
* 参照ドキュメント:

  * C-XX_清掃当番管理画面-基本設計_v1.0
  * harmonet-technical-stack-definition_v4.5
  * HarmoNet-DB-Basic-Design_v2.0
  * schema.prisma（現行定義）
* 想定読者: 画面実装担当（Windsurf）、API/RLS 実装担当、テスト担当
* ステータス: v1.0（初版）

---

## 1. 画面構成詳細

### 1.1 レイアウト構造

既存の「テナントユーザ管理」画面と同一系統のカードレイアウトを踏襲する。清掃当番管理画面固有の構造のみ記載する。

* 共通ヘッダー

  * 既存共通コンポーネントをそのまま利用する。
  * 清掃当番専用のタイトルは表示しない。
  * 言語切替ボタン（JA/EN/ZH）、通知アイコン等は既存仕様に従う。

* 本文エリア

  * 外枠: 共通カードコンポーネント（白背景、角丸、最小限のシャドウ）。
  * 縦方向の構成:

    1. グループタイトル表示行
    2. 説明テキストブロック
    3. 清掃当番表（当番一覧テーブル）
    4. ページネーション
    5. 画面下部ボタン行（前回 / 完了）

### 1.2 コンポーネント構成

* CleaningDutyPage（ページコンポーネント）

  * 責務: 認証済みユーザの `group_code` を確認し、自グループの清掃当番情報を取得・表示する。
  * 主な子コンポーネント:

    * `CleaningDutyHeader`（グループタイトル + 説明）
    * `CleaningDutyTable`（当番一覧テーブル）
    * `CleaningDutyPagination`（ページネーション）
    * `CleaningDutyFooterActions`（前回 / 完了ボタン）

* CleaningDutyHeader

  * 表示内容:

    * 1行目: `"<group_code>_掃除当番管理簿"`（suffix は i18n テーブルから取得）。
    * 2行目以降: 説明テキスト（i18n テーブルから取得）。

* CleaningDutyTable

  * 表ヘッダー:

    * 項番 / 実施結果 / 清掃日 / 住居番号 / 世帯主 / 操作
  * 表ボディ:

    * `CleaningDutyRow` を 1 住戸につき 1 行描画。

* CleaningDutyRow

  * 1 行分の表示と操作を担当する。
  * 行ごとに `cleaning_duties` の「現在サイクル」レコードをマッピングする。

* CleaningDutyFooterActions

  * テーブル直下に配置されるボタン行。
  * 左側: ページネーション（既存共通部品）。
  * 右側: [前回] ボタン / [完了] ボタン（班長のみ活性）。

* CleaningDutyHistoryModal

  * 「前回」ボタン押下時に表示するモーダル。
  * 自グループ全体の過去サイクル（最大 3 サイクル）の履歴を表示する。

* CleaningDutyCompleteDialog

  * 「完了」ボタン押下時に表示する確認ダイアログ。

---

## 2. 入出力仕様

### 2.1 画面入力（ユーザ操作）

#### 2.1.1 テーブル入力

* 実施結果（チェックボックス）

  * 対象: 班員・班長ともに、自分の住戸行のみ。
  * 操作:

    * OFF → ON: 清掃を実施したタイミングでユーザがチェックを入れる。
    * ON → OFF: 誤操作修正用として許可するかどうかは詳細設計で要検討（本書では「許可する」とする）。
  * 入力値:

    * boolean（true / false）。

* 世帯主（ドロップダウン）

  * 対象: 班長のみ。
  * 候補:

    * ログインユーザと同じ `tenant_id` + `group_code` を持つ `users` テーブル行。
    * 表示値: `users.last_name`。
    * 内部値: `users.id`。
  * 操作:

    * 班長が [編集] ボタン押下後、ドロップダウンから別ユーザを選択。

* 操作列 [編集] ボタン

  * 対象: 班長のみ表示・活性。
  * 動作:

    * 該当行の世帯主ドロップダウンを編集モードに切り替える。

#### 2.1.2 画面下部ボタン

* [前回] ボタン

  * 対象: `group_code` を持つ全ユーザ。
  * 動作:

    * 自グループ全体の履歴（`completed_at IS NOT NULL`）を最大 3 サイクル分取得し、`CleaningDutyHistoryModal` に表示する。

* [完了] ボタン

  * 対象: `group_leader` ロールを持つ班長のみ表示・活性。
  * 動作:

    * `CleaningDutyCompleteDialog` を表示する。
    * ダイアログで「完了する」が選択された場合、現サイクルの完了処理を実行する。

### 2.2 画面出力

* 表示対象:

  * ログインユーザと同じ `tenant_id` かつ `group_code` を持つ住戸分のみ。
  * 各行は「現在サイクル」の `cleaning_duties` レコードを反映する。

* 各列の表示値:

  * 項番: 描画時に 1 からの連番。
  * 実施結果: `is_done` に応じてチェック状態を表示。
  * 清掃日: `cleaned_on` を `YYYY/MM/DD` 形式で表示（null の場合は空）。
  * 住居番号: `residence_code` をそのまま表示。
  * 世帯主: `assignee_id` に紐づく `users.last_name` を表示。
  * 操作: [編集] ボタン（班長のみ）。

---

## 3. データモデル・API仕様

### 3.1 cleaning_duties テーブル詳細

基本設計書の案を前提とする。

```prisma
model cleaning_duties {
  id             String   @id @default(uuid())
  tenant_id      String
  group_code     String
  residence_code String
  cycle_no       Int

  assignee_id    String
  is_done        Boolean  @default(false)
  cleaned_on     DateTime?
  completed_at   DateTime?

  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  tenant   tenants @relation(fields: [tenant_id], references: [id])
  assignee users   @relation(fields: [assignee_id], references: [id])

  @@index([tenant_id, group_code, residence_code])
  @@index([tenant_id, group_code, residence_code, cycle_no])
}
```

#### 3.1.1 「現在サイクル」と「履歴」の定義

* 現在サイクル

  * 各住戸 (`tenant_id + group_code + residence_code`) ごとに、最大の `cycle_no` を持つレコード。
  * 画面の当番表では、このレコードのみを編集対象とする。

* 履歴

  * `completed_at IS NOT NULL` のレコードを履歴とみなす。
  * 画面からは編集不可（読み取り専用）。

### 3.2 主要 API（概念レベル）

フロントからは Supabase クライアント／既存 API 経由でアクセスする。ここでは概念的な I/O のみ示す。

1. 自グループ現在サイクル一覧取得

   * 入力:

     * `tenant_id`: ログインユーザの tenant
     * `group_code`: ログインユーザの group_code
   * 振る舞い:

     * `cleaning_duties` から `tenant_id` と `group_code` が一致するレコードを取得。
     * 各 `residence_code` ごとに最大 `cycle_no` のレコードのみ返す。

2. 実施結果更新

   * 入力:

     * `id`: cleaning_duties.id（現在サイクルの自分の住戸行のみ）
     * `is_done`: true/false
   * 振る舞い:

     * ログインユーザの `tenant_id` / `group_code` / `residence_code` がレコードと一致することを確認。
     * `is_done` 更新。
     * `is_done = true` になった場合のみ `cleaned_on = now()` を設定。

3. 世帯主変更（班長のみ）

   * 入力:

     * `id`: cleaning_duties.id
     * `assignee_id`: 新しいユーザ ID
   * 振る舞い:

     * 呼び出しユーザが `group_leader` ロールを持ち、同じ `tenant_id` + `group_code` に属していることを確認。
     * 指定された `assignee_id` が同じ `tenant_id` + `group_code` の `users` に存在することを確認。
     * `assignee_id` を更新。

4. 完了処理（班長のみ）

   * 入力:

     * `tenant_id`, `group_code`
   * 振る舞い（サイクル単位）:

     * 対象: 現在サイクルの全住戸行（`cycle_no = max(cycle_no)`）
     * 班長がダイアログで「完了する」を選択した場合:

       1. 各行で `completed_at = now()` を設定。
       2. 各行について次サイクルレコードを新規作成。

          * `cycle_no = 旧 cycle_no + 1`
          * `tenant_id, group_code, residence_code, assignee_id` を引き継ぎ。
          * `is_done = false, cleaned_on = null, completed_at = null`。

5. 前回履歴取得

   * 入力:

     * `tenant_id`, `group_code`
   * 振る舞い:

     * `completed_at IS NOT NULL` のレコードを `completed_at` 降順でソート。
     * サイクル単位で最大 3 サイクル分を取得し、モーダルに表示する。

---

## 4. RLS・認可設計（概要）

※ 実際の RLS ポリシー SQL は DB 詳細設計で定義する。ここでは画面で必要な前提のみ記載する。

### 4.1 参照（SELECT）

* 条件:

  * `tenant_id = current_setting('request.jwt.claim.tenant_id')`
  * `group_code = current_setting('request.jwt.claim.group_code')`（想定）
* 結果:

  * ログインユーザと同一テナント・同一グループのレコードのみ参照可能。

### 4.2 更新（UPDATE）

* 実施結果・清掃日（`is_done`, `cleaned_on`）

  * 条件:

    * ログインユーザの `residence_code` とレコードの `residence_code` が一致すること。
    * 対象レコードが現在サイクルであること。
    * `completed_at IS NULL` であること。

* 世帯主変更（`assignee_id`）

  * 条件:

    * ログインユーザが `group_leader` ロールを持つこと。
    * ログインユーザとレコードの `tenant_id` / `group_code` が一致すること。
    * 対象レコードが現在サイクルであること。

* 完了処理（`completed_at`）

  * 条件:

    * ログインユーザが `group_leader` ロールを持つこと。
    * 対象レコードが現在サイクルであること。

### 4.3 挿入（INSERT）

* 次サイクルレコード作成のみ許可。
* 条件:

  * 挿入処理はバックエンド（完了処理 API）のみが行う。
  * ログインユーザが `group_leader` ロールを持つこと。

### 4.4 削除（DELETE）

* 清掃当番履歴の削除は行わない前提とする。

---

## 5. メッセージ・i18n 仕様

### 5.1 文言管理方針

* 全ての文言は i18n 用翻訳テーブルで管理し、`common.json` は使用しない。
* キー例（案）:

  * 画面タイトルサフィックス: `cleaningDuty.titleSuffix`
  * 説明文: `cleaningDuty.description`
  * 前回ボタン: `cleaningDuty.actions.history`
  * 完了ボタン: `cleaningDuty.actions.complete`
  * 完了ダイアログタイトル: `cleaningDuty.completeDialog.title`
  * 完了ダイアログ本文: `cleaningDuty.completeDialog.message`
  * 完了ダイアログボタン: `cleaningDuty.completeDialog.confirm` / `.cancel`
  * group_code 未設定メッセージ: `cleaningDuty.error.noGroup`

### 5.2 エラーメッセージ

* group_code 未設定時:

  * 「清掃当番管理簿は、グループに所属している利用者のみご利用いただけます。お手数ですが、管理組合までお問い合わせください。」
* データ取得エラー時:

  * 共通エラーメッセージキーを利用する（例: `common.error.fetchFailed`）。

---

## 6. ログ出力仕様（共通ロガー前提）

### 6.1 ログ出力方針

* 出力先: 共通ロガーを通じて Vercel 標準ログに出力する。
* ファイル出力や本画面固有の監査ログは持たない。
* 目的: 不具合調査・トラブルシュートのための最低限の情報を残す。

### 6.2 ログイベント一覧

1. 画面表示

   * タイミング: 清掃当番管理画面表示時（初期ロード完了後）。
   * レベル: info
   * 項目例:

     * event: `cleaningDuty.page.view`
     * tenant_id, user_id, group_code, route

2. 実施結果チェック更新

   * タイミング: 実施結果チェックボックス ON/OFF 時。
   * レベル: info
   * 項目例:

     * event: `cleaningDuty.duty.toggle`
     * tenant_id, user_id, group_code, residence_code, cycle_no
     * is_done, cleaned_on

3. 世帯主変更（班長のみ）

   * タイミング: 班長が世帯主を変更し、保存したとき。
   * レベル: info
   * 項目例:

     * event: `cleaningDuty.assignee.change`
     * tenant_id, user_id (operator), group_code, residence_code
     * old_assignee_id, new_assignee_id

4. 完了処理（班長のみ）

   * タイミング: 完了ダイアログで「完了する」を選択し、処理が成功したとき。
   * レベル: info
   * 項目例:

     * event: `cleaningDuty.cycle.complete`
     * tenant_id, user_id (operator), group_code, cycle_no
     * completed_at

5. エラー

   * タイミング: API 呼び出し失敗 / DB 更新失敗 / 想定外例外など。
   * レベル: error
   * 項目例:

     * event: `cleaningDuty.error`
     * tenant_id, user_id, group_code
     * operation（`fetchCurrent`, `toggleDuty`, `changeAssignee`, `completeCycle`, `fetchHistory` など）
     * error_code / error_message

---

## 7. テスト観点（概要）

※ 単体テスト・結合テスト詳細は別途テスト仕様で定義する。本書では本画面特有の観点のみ列挙する。

1. アクセス制御

   * group_code を持つユーザは画面にアクセスできること。
   * group_code が NULL のユーザは、エラーメッセージが表示され当番表が表示されないこと。

2. 実施結果・清掃日

   * 自分の住戸行でのみチェックが操作できること（班長・班員とも）。
   * チェック ON 時に cleaned_on にシステム日付が入ること。

3. 世帯主変更

   * 班長が自グループ内の行の世帯主を変更できること。
   * 班員には編集 UI が表示されないこと。

4. 完了処理

   * 班長のみ完了ボタンが押下可能であること。
   * ダイアログが表示され、「完了する」選択で completed_at が設定され、次サイクルレコードが作成されること。
   * 完了済みレコードが編集不可であること。

5. 前回履歴

   * 前回ボタン押下で、自グループ全体の過去サイクル（最大 3 サイクル）が表示されること。
   * 履歴はすべて読み取り専用であること。

6. ログ

   * 上記ログイベントが適切なタイミングで出力されていること（手動確認またはテストログ確認）。

---

以上。
