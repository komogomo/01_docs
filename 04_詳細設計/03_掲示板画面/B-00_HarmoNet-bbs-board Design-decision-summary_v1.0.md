# B-00 HarmoNet 掲示板機能 設計決定サマリ v1.1

**Document ID:** HARMONET-BOARD-DESIGN-DECISION  
**Version:** 1.1  
**Supersedes:** v1.0 :contentReference[oaicite:0]{index=0}  
**Status:** 掲示板投稿フォーム・添付実装完了版  
**Scope:** 掲示板 TOP / 詳細 / 新規投稿 / 管理組合ワークフロー（方式レベル）

---

## 1. 画面一覧

本サマリで対象とする画面は以下。

1. 掲示板 TOP 一覧画面（Board Top）
2. 掲示板詳細画面（Board Detail）
3. 新規投稿画面（Board New）
4. 管理組合用掲示板管理／承認画面（Board Management / Approvals）

---

## 2. 掲示板 TOP 一覧（Board Top）

### 2.1 一覧カード

1件あたりの表示要素:

- 投稿区分タグ（1つ）
  - 例: `[重要]`, `[お知らせ]`, `[北-A]` 等
- タイトル
- メタ情報行
  - 左: 投稿者種別表示名
    - 例: `管理組合`, `一般利用者`, `テナント管理者`
    - 表示名ロジックは 3.1 参照
  - 右: 投稿日時（例: `2025/11/21 10:30`）
- 添付ファイル有無
  - 添付が 1 件以上ある場合のみ、カード右上にクリップアイコンを表示

### 2.2 フッター行（ページネーション＋件数）

- 画面下部に 1 行構成で表示
- 左端: 表示件数ドロップダウン（ラベル無し）
  - 例: `[10件 ▼]`
- 右側: ページネーション
  - `[前へ] [1] [2] [3] [次へ]`

### 2.3 新規投稿ボタン（FAB）

- 掲示板 TOP のみ、画面右下にフローティングボタンを表示
- 丸い「＋」アイコンボタン
  - PC: ホバー時に `title="新規投稿"`
  - モバイル: アイコンのみ
- ロールにより表示制御
  - 投稿権限があるユーザ（管理組合＋一般利用者など）のみ表示
  - 閲覧専用ロールには表示しない
- 動作
  - クリック／タップで「新規投稿画面」（Board New）へ遷移

---

## 3. 掲示板詳細（Board Detail）

### 3.1 投稿本文ブロック

- 投稿区分タグ + タイトル
- 投稿者情報行
  - 左: 投稿者種別（例: `管理組合` / `一般利用者`）
  - 中: 対象範囲ラベル（例: `北-A グループ向け`）
  - 右: 投稿日時
- 投稿者表示名ロジック（投稿ヘッダ用）
  - 管理組合投稿:
    - 画面上の表示名は常に `管理組合` 固定
    - DB 上は `board_posts.author_display_name = '管理組合'` を基本とし、TOP/詳細はこの値を優先表示する
  - 一般利用者投稿:
    - `board_posts.author_display_name` が設定されている場合はその値を使用
    - 未設定の場合は `users.display_name` を使用する
- 本文
  - 管理組合投稿: TipTap リッチテキストを HTML/適切な形式でレンダリング
  - 一般利用者投稿: シンプルテキスト（簡易装飾）

### 3.2 本文直下のアクションアイコン（翻訳 / 読上げ）

- 本文直下に右寄せでアイコン 2 つを横並び表示
- アイコンのみ（テキストラベルなし）
  - 翻訳アイコン: Lucide `Languages`
    - `aria-label="投稿本文を翻訳"`
    - `title="翻訳"`
  - 読上げアイコン: Lucide `Volume2`
    - `aria-label="投稿本文を読み上げ"`
    - `title="読み上げ"`
- 状態表示
  - OFF: 通常色
  - ON: ブランド色などでトグル状態を示す
- 機能対象
  - 翻訳 / 読上げともに「投稿本文（＋必要ならタイトル）」を対象とし、画面全体のUIラベルは対象外

### 3.3 添付ファイル

- 「添付ファイル」見出しの下に添付ファイルリストをカード形式で表示
- 添付ファイル種別と挙動
  - PDF:
    - 「プレビュー」「ダウンロード」ボタンを表示
    - プレビューはモーダル内 `<iframe src={fileUrl}>` で表示（PDF ビュー）
  - 画像（JPG / JPEG / PNG）:
    - 「プレビュー」「ダウンロード」ボタンを表示
    - プレビューはモーダル内 `<img src={fileUrl}>`（`object-contain`）で表示
  - その他（Office ファイル等）:
    - 「ダウンロード」のみ表示（プレビュー無し）
- モーダル仕様
  - 画面全体を覆うフルスクリーンモーダル
  - 上部: 小さな「閉じる」テキストまたは ✕ アイコン
  - 下部中央: 「タップで閉じる」テキスト
  - モーダル全体（表示領域含む）を短くタップした場合も閉じる
  - 背景だけをタップして閉じる専用処理は持たず、閲覧コンテンツのスクロール操作を優先
- URL 取得方針
  - BoardDetail は `Attachment.fileUrl` として `/api/board/attachments/{attachmentId}` を受け取り、
    それを `src` / `href` としてそのまま利用する
  - Supabase Storage 上のオブジェクトパスや署名付き URL の生成は `/api/board/attachments/...` 側に隠蔽する

### 3.4 返信セクション

- 見出し: 「返信」
- 返信一覧（新しい順）
  - 1行目: 表示名 + 右側に日時
    - 表示名は `匿名` または `ニックネーム`
    - 実名や部屋番号は表示しない
  - 2行目以降: 返信本文
  - 返信の参照範囲は親投稿と同一（タグに追従）
- 返信入力
  - テキストエリア（プレースホルダ: `返信を入力…`）
  - 表示名既定設定用チェックボックス（例）
    - `□ 常に匿名で返信する`
    - `□ 常にニックネームで返信する`
  - 「送信」ボタン
    - 押下で返信を一覧先頭に追加
    - 参照範囲・タグは親投稿と同一
- 戻り導線
  - 画面上部に「＜掲示板TOPへ」リンクを表示

---

## 4. 投稿区分（タグ）と参照範囲

（v1.0 から変更なし。引用のみ簡略）

### 4.1 投稿区分の基本ルール

- 投稿区分 = 画面上の「タグ」1 個
- 種別:
  - GLOBAL 系: 全体向け（例: `重要`, `お知らせ`, `ルール`, `質問`, `要望`, `フリー投稿` 等）
  - GROUP 系: 居住者グループ向け（例: `北-A`, `北-B`, `南-A`, `南-B` 等）

### 4.2 可視範囲（概念）

- GLOBAL タグ:
  - 管理組合
  - テナント管理者（必要に応じて）
  - 全居住者
- GROUP タグ（例: 北-A）:
  - 管理組合（＋必要ならテナント管理者）
  - 該当グループ所属の居住者（北-A のみ）

### 4.3 ユーザごとの選択肢・UI 表現

- 管理組合ユーザ:
  - すべての GLOBAL / GROUP タグを選択可能
- 一般利用者:
  - 一般向け GLOBAL タグ + 自所属グループの GROUP タグのみ
- 新規投稿時 UI:
  - トグルボタン群で単一選択、必須（未選択時は投稿不可）

---

## 5. 新規投稿画面（Board New）

### 5.1 共通項目

- 投稿区分 *（4章のトグルボタン UI）
- タイトル *（1行テキスト）
- 本文 *
  - 管理組合: TipTap ベースのリッチテキストエディタ
    - PC: フル機能ツールバー
    - スマホ: 主要機能のみの簡易ツールバー
  - 一般利用者: シンプル or 簡易リッチ（別詳細設計に準拠）
- 添付ファイル
  - 掲示板投稿では、PDF を推奨としつつ、画像（JPG/PNG）および Office 系ファイル等も添付可能とする
  - 上限サイズ・上限数はテナント設定（将来の管理画面）から変更可能とする前提で、現在は共通デフォルト値で運用
- 表示名選択
  - 一般利用者投稿:
    - 「匿名で投稿する／ニックネームで投稿する」ラジオ・チェックボックスを表示
  - 管理組合投稿:
    - 表示名選択 UI は非表示
    - 表示名は常に「管理組合」に固定（3.1 参照）
- ボタン
  - 「投稿」ボタン
  - 「キャンセル」ボタン（掲示板 TOP へ戻る）

### 5.2 必須表示とバリデーション

- ラベル右に `*` を付与
  - `投稿区分 *`, `タイトル *`, `本文 *`
- 画面下部に注記: 「* は必須項目です。」
- バリデーション:
  - 投稿区分未選択
  - タイトル未入力
  - 本文未入力
  → 上記いずれかの場合、投稿ボタンを非活性 or エラーメッセージ表示

### 5.3 投稿前確認ポップアップ

- 投稿ボタン押下時（必須チェックOK時）に確認モーダル（または `window.confirm`）を表示
  - 文言イメージ（v1.0 と同様）
  - 「いいえ」: 投稿中止
  - 「はい」: 投稿処理実行

---

## 6. 管理組合向けリッチエディタ仕様

（v1.0 と同様。TipTap ベースで PC フル／スマホ簡易。詳細は別設計書に委譲）

---

## 7. 管理組合投稿の承認フロー（簡易ワークフロー）

- 要件:
  - 対象: 管理組合投稿のみ
  - 要件: 公開前に複数承認者によるワークフロー承認が必須（詳細仕様は別途検討）:contentReference[oaicite:1]{index=1}  
- 状態:
  - `board_posts.status` は `draft` / `published` を主に利用（`pending`/`archived` は当面未使用）
- 詳細なテーブル案・状態遷移は v1.0 記載内容を維持（`board_approvers` / `board_approval_logs` 等）

---

## 8. スキーマ追加・変更ポイント（サマリ）

### 8.1 掲示板関連

- `board_posts`
  - 追加: `author_display_name String?`
    - 表示名ロジックで利用（3.1）
    - 管理組合投稿時は `'管理組合'` 固定で格納
- `board_attachments`
  - モデルは v1.0 と同一（Prisma 定義は schema.prisma を参照）:contentReference[oaicite:2]{index=2}  
  - `file_type` によりプレビュー可否を判断
    - PDF / 画像: プレビューあり
    - その他: ダウンロードのみ
- 添付 Storage
  - Supabase Storage バケット `board-attachments` を採用
  - オブジェクトパス: `tenant-{tenant_id}/post-{post_id}/{uuid}.{ext}`
  - アプリ側は `/api/board/attachments/{attachmentId}` を経由してダウンロード／プレビューを行う（直接 Storage URL を扱わない）

---

## 9. 今後の検討・保留事項

- 管理組合ワークフロー詳細仕様（承認者選択 UI・承認画面・メール通知文面）
- 添付ファイル種別別の上限・禁止拡張子（テナント設定／管理画面での制御方法）
- モデレーション結果（mask / block）を BoardDetail の UI にどう反映するか（マスク表示ラベル等）
- 管理者向けモデレーションログ／掲示板ログ閲覧画面の必要性

---

## 10. 改訂履歴

| Version | Date       | Author | Summary                                             |
| ------- | ---------- | ------ | --------------------------------------------------- |
| v1.1    | 2025-11-25 | TKD/TK | 添付ファイル種別（PDF＋画像＋その他DLのみ）と表示名ロジック、Storage 方針を反映 |
| v1.0    | 2025-11-24 | TKD    | 掲示板 TOP/詳細/新規投稿/ワークフロー 初版サマリ         |

