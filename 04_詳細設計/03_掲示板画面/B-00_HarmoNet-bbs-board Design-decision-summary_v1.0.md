# HarmoNet 掲示板機能 検討内容・最終案サマリ（ドラフト）

> 状態: TKD/WIFE でモック確認前の最終案メモ（正式設計書ではない）

---

## 1. 画面一覧

本サマリで対象とする画面は以下。

1. 掲示板 TOP 一覧画面（Board Top）
2. 掲示板詳細画面（Board Detail）
3. 新規投稿画面（Board New）
4. 管理組合用掲示板管理／承認画面（Board Management / Approvals）

---

## 2. 掲示板 TOP 一覧（Board Top）

### 2.1 一覧カード

1件あたりの表示要素:

* 投稿区分タグ（1つ）

  * 例: `[重要]`, `[お知らせ]`, `[北-A]` 等
* タイトル
* メタ情報行

  * 左: 投稿者種別

    * 例: `管理組合`, `一般利用者`, `テナント管理者`
  * 右: 投稿日時（例: `2025/11/21 10:30`）
* 添付ファイル有無

  * 添付がある場合のみ、カード右上にクリップアイコンを表示

### 2.2 フッター行（ページネーション＋件数）

* 画面下部に 1 行構成で表示
* 左端: 表示件数ドロップダウン（ラベル無し）

  * 例: `[10件 ▼]`
  * ラベル「表示件数」は表示しない
* 右側: ページネーション

  * `[前へ] [1] [2] [3] [次へ]`

### 2.3 新規投稿ボタン（FAB）

* 掲示板 TOP のみ、画面右下にフローティングボタンを表示
* 丸い「＋」アイコンボタン

  * PC: ホバー時に `title="新規投稿"`
  * モバイル: アイコンのみ
* ロールにより表示制御

  * 投稿権限があるユーザ（管理組合＋一般利用者など）のみ表示
  * 閲覧専用ロールには表示しない
* 動作

  * クリック／タップで「新規投稿画面」（Board New）へ遷移

---

## 3. 掲示板詳細（Board Detail）

### 3.1 投稿本文ブロック

* 投稿区分タグ + タイトル
* 投稿者情報行

  * 左: 投稿者種別（例: `管理組合`）
  * 中: 対象範囲ラベル（例: `北-A グループ向け`）
  * 右: 投稿日時
* 本文

  * 管理組合投稿: リッチテキスト（見出し・箇条書き・表等）を反映した表示
  * 一般利用者投稿: シンプルテキスト（簡易装飾）

### 3.2 本文直下のアクションアイコン（翻訳 / 読上げ）

* 本文直下に右寄せでアイコン 2 つを横並び表示
* アイコンのみ（テキストラベルなし）

  * 翻訳アイコン: Lucide `Languages`

    * `aria-label="投稿本文を翻訳"`
    * `title="翻訳"`
  * 読上げアイコン: Lucide `Volume2`

    * `aria-label="投稿本文を読み上げ"`
    * `title="読み上げ"`
* 状態表示

  * OFF: 通常色
  * ON: ブランド色／アウトライン変更などでトグル状態を示す
* 機能対象

  * 翻訳 / 読上げともに「投稿本文（＋必要ならタイトル）」を対象とし、UIラベル全体は対象外

### 3.3 添付ファイル

* 「添付ファイル」見出しの下に PDF ファイル名リストを表示
* 各行: PDF アイコン + ファイル名
* 詳細画面のみ PDF プレビュー対応（TOP はクリップアイコンのみ）

### 3.4 返信セクション

* 見出し: 「返信」

* 返信一覧（新しい順）

  * 1行目: 表示名 + 右側に日時

    * 表示名は `匿名` または `ニックネーム`
    * 実名や部屋番号は表示しない
  * 2行目以降: 返信本文
  * 返信の参照範囲は親投稿と同一（タグに追従）

* 返信入力

  * テキストエリア（プレースホルダ: `返信を入力…`）
  * 表示名の既定設定用チェックボックス（例）

    * `□ 常に匿名で返信する`
    * `□ 常にニックネームで返信する`
  * 「送信」ボタン

    * 押下で返信を一覧先頭に追加
    * 参照範囲・タグは親投稿と同一

* 戻り導線

  * 画面上部に「＜掲示板TOPへ」リンクを表示

---

## 4. 投稿区分（タグ）と参照範囲

### 4.1 投稿区分の基本ルール

* 投稿区分 = 画面上の「タグ」1 個
* 種別:

  * GLOBAL 系: 全体向け

    * 例: `重要`, `お知らせ`, `ルール`, `質問`, `要望`, `フリー投稿` 等
  * GROUP 系: 居住者グループ向け

    * 例: `北-A`, `北-B`, `南-A`, `南-B` 等

### 4.2 可視範囲（概念）

* GLOBAL タグ

  * 管理組合
  * テナント管理者（必要に応じて）
  * 全居住者
* GROUP タグ（例: 北-A）

  * 管理組合（＋必要ならテナント管理者）
  * 該当グループ所属の居住者（北-A のみ）
  * 他グループ居住者には非表示

### 4.3 ユーザごとの選択肢

* 管理組合ユーザ

  * すべての GLOBAL タグ
  * すべての GROUP タグ
* 一般利用者

  * 一般向け GLOBAL タグ
  * 自身が所属する居住者グループの GROUP タグ（例: 自分が北-A の場合は `北-A` のみ）

### 4.4 UI 表現（新規投稿時）

* 投稿区分は「トグルボタン群」でまとめて表示

  * 例（管理組合ユーザ）: `[重要] [お知らせ] [ルール] [北-A] [北-B] ...`
  * 例（一般利用者 / 北-A）: `[質問] [要望] [フリー] [北-A]`
* 単一選択（常に 1 つだけアクティブ）
* 必須項目

  * 未選択時は投稿不可
  * ラベル右に `*` を付与（例: `投稿区分 *`）
  * エラー時メッセージ例: 「投稿区分を選択してください。」

---

## 5. 新規投稿画面（Board New）

### 5.1 共通項目

* 投稿区分 *（4章のトグルボタン UI）
* タイトル *（1行テキスト）
* 本文 *

  * 管理組合: リッチテキストエディタ（C 案相当）
  * 一般利用者: シンプル or 簡易リッチ（A/B 案のどちらかを後日決定）
* 添付ファイル

  * PDF のみ許可
* ボタン

  * 「投稿」ボタン
  * 「キャンセル」ボタン（掲示板 TOP へ戻る）

### 5.2 必須表示とバリデーション

* ラベル右に赤 `*` を付与

  * `投稿区分 *`, `タイトル *`, `本文 *`
* 画面下部に注記: 「* は必須項目です。」
* バリデーション:

  * 投稿区分未選択
  * タイトル未入力
  * 本文未入力
    → 上記いずれかの場合、投稿ボタンを非活性 or エラーメッセージ表示

### 5.3 投稿前確認ポップアップ

* 投稿ボタン押下時（必須チェックOK時）

  * 確認モーダル（または `window.confirm`）を表示

  * 文言イメージ:

    > 掲示板に以下の内容で投稿します。よろしいですか？
    >
    > 投稿区分: [重要]
    > タイトル: ○○○○
    > 本文: △△△△（先頭数十文字）

  * ボタン: 「いいえ」「はい」

    * 「いいえ」: 投稿中止（画面はそのまま）
    * 「はい」: 投稿処理実行

---

## 6. 管理組合向けリッチエディタ仕様（サービスイン初期前提）

### 6.1 利用者と端末前提

* 利用者: 管理組合ロール
* 端末前提:

  * PC での利用を主とする
  * スマホからも利用可能だが、主に簡易な投稿・軽微な修正を想定

### 6.2 提供する編集機能（想定）

* 段落 / 見出し

  * 通常段落
  * 見出し H2 / H3 程度
* 文字装飾

  * 太字 / 斜体 / 下線 / 取り消し線
* リスト

  * 箇条書き
  * 番号付きリスト
* 段落レベル

  * インデント / アウトデント
  * 水平罫線（セクション区切り）
* 表（テーブル）

  * 行の追加 / 削除
  * 列の追加 / 削除
  * 最大列数: 4〜5 列程度に制限
  * セル結合: 原則禁止（必要ならヘッダ行のみ許可）

### 6.3 端末別の扱い

* PC 幅: フルツールバー表示（上記機能をすべて利用可）
* スマホ幅:

  * 初期状態は簡易ツールバー（太字・リスト中心）
  * 「詳細編集」操作でフルツールバー展開
  * 表の新規作成や複雑な構造編集は PC 利用を推奨

### 6.4 実装ライブラリ

* TipTap 等のリッチテキストライブラリを候補とし、実装工程で選定
* 設計書ではライブラリ名に依存せず、「提供機能」「保存形式（HTML/JSON 等）」を仕様として定義する方針

---

## 7. 管理組合投稿の承認フロー（簡易ワークフロー）

### 7.1 対象

* 管理組合の投稿区分で投稿する場合のみ
* 一般利用者の投稿は従来どおり即時公開（承認フロー対象外）

### 7.2 状態（board_posts）

* `draft`  : 管理組合投稿の作成中・承認待ち状態
* `published`: 掲示板に公開済み

`pending`/`archived` は enum に存在しても、当面は利用しない方針。

### 7.3 承認者の前提

* 承認者候補条件:

  * 同一テナント (`tenant_id` 一致)
  * `user_roles` で「管理組合ロール（承認権限あり）」を持つユーザ
* テナント管理者画面で:

  * ユーザ登録
  * ロール付与（管理組合 / 一般利用者 等）
  * グループ紐付け
    を行う想定

### 7.4 現在状態テーブル（案）

* 新規追加: `board_approvers`

```prisma
model board_approvers {
  id          String   @id @default(uuid())
  tenant_id   String
  post_id     String
  approver_id String
  approved    Boolean  @default(false)
  approved_at DateTime?

  tenant   tenants     @relation(fields: [tenant_id], references: [id])
  post     board_posts @relation(fields: [post_id], references: [id], onDelete: Cascade)
  approver users       @relation(fields: [approver_id], references: [id])

  @@unique([post_id, approver_id])
}
```

* 役割:

  * 「誰が承認者として指定されているか」
  * 「誰が承認済みか」を持つ現在状態テーブル

### 7.5 承認履歴テーブル（既存）

* 既存: `board_approval_logs`
* 本フローでは主に `action = approve` の履歴を残す用途で利用
* 否認・コメント入力は今回のスコープでは **利用しない**（将来拡張余地として保持）

### 7.6 ワークフロー動作

1. 投稿者（管理組合）が作成

   * 管理組合投稿区分を選択
   * タイトル・本文など入力
   * 承認者を複数選択（最低 1 人）
   * 「承認依頼」ボタン押下

     * `board_posts.status = draft` のまま保存
     * `board_approvers` に (post_id, approver_id, approved=false) を作成
     * 承認者全員にメール通知（タイトル＋リンク程度のシンプルな本文）
   * この時点で「投稿」ボタンは **非活性**

2. 承認者が確認・承認

   * 通知メールのリンクから対象投稿（draft）を開く
   * 内容を確認し、問題なければ自分の「承認」チェックを ON

     * 対応する `board_approvers` 行: `approved = true, approved_at = now()`
     * `board_approval_logs` に履歴 1 行追加（action = approve）
   * 否認・コメント入力は実装しない（NG 連絡は別チャネル運用）

3. 全員承認完了

   * 対象 post の `board_approvers` が 1件以上存在し、
   * 全レコードの `approved = true` となったタイミングで、投稿者に「承認完了」メール通知

4. 投稿者の最終投稿

   * 投稿者が対象投稿を開くと「投稿」ボタンが活性化
   * 「投稿」ボタン押下で `board_posts.status = published` に更新
   * 掲示板 TOP / 詳細には `status = published` の投稿のみ表示

---

## 8. スキーマ追加・変更ポイント（サマリ）

### 8.1 投稿区分種別

* 既存 `board_categories` に種別カラムを追加（案）

```prisma
enum board_category_type {
  GLOBAL // 全体向け
  GROUP  // 居住者グループ向け
}

model board_categories {
  id            String             @id @default(uuid())
  tenant_id     String
  category_key  String
  category_name String
  category_type board_category_type @default(GLOBAL)
  display_order Int                @default(0)
  created_at    DateTime           @default(now())
  updated_at    DateTime           @updatedAt
  status        status             @default(active)

  tenant tenants       @relation(fields: [tenant_id], references: [id])
  posts  board_posts[]

  @@unique([tenant_id, category_key])
}
```

### 8.2 管理組合マルチ承認

* 新規追加: `board_approvers`（7.4 章参照）
* 既存 `board_approval_logs` は履歴用途に限定して利用
* `board_posts.status` は `draft` / `published` の 2 値を主に使用

---

## 9. 今後の検討・保留事項

* 投稿区分（タグ）の具体的な一覧・命名（重要 / お知らせ / 質問 / 要望 / フリー 等）の確定
* 一般利用者向けエディタ UI パターン

  * A: プレーンテキスト
  * B: 簡易ツールバー付き
* 管理組合投稿用リッチエディタの保存形式

  * HTML / JSON（TipTap Node 構造）など
* ワークフローの否認・コメント機能

  * 現段階ではスコープ外（有償拡張候補）

以上。
