# B-03 BoardPostForm 詳細設計 ch09 添付ファイル連携仕様_v1.0

## 1. 目的
- 掲示板投稿画面 BoardPostForm における「添付ファイル」の保存方式・権限・基本フローを定義する。
- 一般利用者投稿および管理組合投稿の双方に共通する添付仕様を示す。

## 2. 対象範囲
- 対象画面: 掲示板投稿画面 BoardPostForm（新規投稿／編集）。
- 対象機能:
  - 掲示板投稿に対する添付ファイルのアップロード。
  - 投稿編集時の添付ファイル追加・削除。
  - 投稿削除時の添付ファイル一括削除。
- 本章では、承認ワークフローおよび公開期限は対象外とする。

## 3. 使用テーブル・ストレージ

### 3.1 使用テーブル `board_attachments`
- 掲示板投稿に紐づく添付ファイルのメタ情報を保持する。
- スキーマ（既存定義を前提に利用）:
  - `id: String` … 添付ファイルID（UUID, PK）
  - `tenant_id: String` … テナントID
  - `post_id: String` … 紐づく掲示板投稿ID（`board_posts.id`）
  - `file_url: String` … Supabase Storage 上のオブジェクトURLまたはパス
  - `file_name: String` … 元ファイル名
  - `file_type: String` … MIME タイプ（例: `application/pdf`）
  - `file_size: Int` … バイト数
  - `created_at: DateTime` … 登録日時

### 3.2 ストレージ構成
- 基盤: Supabase Storage。
- バケット名: `board-attachments`。
- バケット公開レベル:
  - private（非公開）。アクセスには認証および署名付きURLを利用する。
- オブジェクトパス規約（例）:
  - `tenant-{tenant_id}/post-{post_id}/{uuid}.{ext}`
  - 例: `tenant-abc123/post-xyz789/9f1e2d3c-....pdf`
- `file_url` には、上記パスまたは Supabase SDK で扱いやすい形式の URL/キーを保存する。

## 4. 権限・表示ルール

### 4.1 アップロード権限
- Supabase 側:
  - `auth.role() = 'authenticated'` のユーザは `board-attachments` バケットへ書き込み可能とする。
- アプリ側（HarmoNet）:
  - 添付UI（ファイル選択コンポーネント）を表示する画面は BoardPostForm（新規投稿／編集）に限定する。
  - ロール・区分ごとの制御:
    - 一般利用者投稿: 投稿者本人のみ添付追加・削除可。
    - 管理組合投稿: 管理組合ロールの利用者が添付追加・削除可。
    - 管理者ロール: テナント内のすべての投稿・添付に対し追加・削除が可能（詳細は別途 RLS/ロール設計に準拠）。

### 4.2 閲覧権限
- 添付ファイルの表示・ダウンロード可否は掲示板記事の閲覧権限と完全に連動させる。
- グループタグなし投稿:
  - テナント内のすべての認証済みユーザが記事および添付ファイルを閲覧可能。
- グループタグ付き投稿:
  - 該当グループに所属するユーザのみ記事および添付ファイルを閲覧可能。
- `board_posts` に存在する記事は、BoardDetail 取得時の RLS およびグループタグ判定に従って表示可否が決まる。

## 5. アップロードフロー

### 5.1 新規投稿時
1. ユーザが BoardPostForm で本文・メタ情報（タイトル、カテゴリ、グループタグなど）・添付ファイルを入力する。
2. フロントエンドは FormData を構築し、以下の API に POST する。
   - エンドポイント例: `POST /api/board/posts`
3. サーバ側（API ルート）は、Supabase サーバクライアントで認証ユーザと `tenant_id` を取得する。
4. `board_posts` に投稿レコードを INSERT する。
5. 添付ファイルごとに以下を実行する。
   - Supabase Storage `board-attachments` バケットに `upload()` する。
   - Upload 完了後、オブジェクトパス（または URL）を取得する。
   - `board_attachments` にメタ情報を INSERT する。
6. 正常終了時、作成された `post_id` をレスポンスとして返却する。

### 5.2 投稿編集時（添付追加）
1. 投稿編集画面で既存添付一覧を表示する。
2. 追加されたファイルのみを新規添付として FormData に含め、`PUT /api/board/posts/{postId}` などのエンドポイントに送信する。
3. サーバ側は新規添付分についてのみ 5.1 と同様の処理を行い、既存添付は保持する。

## 6. 削除フロー

### 6.1 投稿削除時（記事＋添付一括削除）
1. 投稿者または管理者が「投稿削除」操作を実行する。
2. サーバ側で以下を順に実行する。
   - `board_attachments` から `post_id` に紐づく添付一覧を取得。
   - 該当オブジェクトパスを元に Storage から `remove()` でファイルを削除。
   - `board_attachments` の該当レコードを DELETE。
   - 最後に `board_posts` の投稿レコードを DELETE。

### 6.2 添付のみ削除
1. 投稿編集画面で、投稿者または管理者が特定の添付ファイルに対して「削除」操作を実行する。
2. サーバ側で以下を実行する。
   - 対象 `board_attachments` レコードを取得し、`tenant_id` / 投稿者などの権限を確認する。
   - Supabase Storage から該当オブジェクトを `remove()` する。
   - 正常に削除できた場合、`board_attachments` レコードを DELETE する。
3. 投稿の本文および他の添付はそのまま維持する。

## 7. 投稿区分別の本文仕様との関係

- 一般利用者投稿:
  - 本文: プレーンテキスト。
  - 添付: 本章の仕様に従い、BoardPostForm 上でファイル選択コンポーネントを使用してアップロードする。
- 管理組合投稿:
  - 本文: TipTap ベースのリッチテキストエディタを使用する。
    - PC: フル機能ツールバー（見出し、リスト、強調、リンク等）。
    - スマホ: 主要機能のみを残した簡易ツールバー。
  - 添付: 一般利用者投稿と同じコンポーネント・フローでアップロードする。
