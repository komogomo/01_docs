# B-04 BoardTranslationAndTtsService 詳細設計書 ch06 非機能設計（性能・タイムアウト・レート・セキュリティ） v1.2

**Document ID:** HARMONET-COMPONENT-B04-BOARDTRANSLATIONANDTTSSERVICE-DETAIL-CH06
**Version:** 1.1
**Supersedes:** v1.0
**Created:** 2025-11-22
**Updated:** 2025-11-22
**Author:** Tachikoma
**Reviewer:** TKD
**Status:** Draft

---

## 6.1 本章の目的

本章では、掲示板専用 翻訳＋音声読み上げサービス B-04 BoardTranslationAndTtsService に関する

* 性能要件（レスポンスタイム等）
* タイムアウト・リトライポリシ
* レート・クオータに関する方針
* セキュリティ（認証情報の扱い・ログマスキング等）

を定義する。UI を持たない API コンポーネントであるため、画面とは独立した非機能要件を明確にし、実装者が守るべき制約を提示することを目的とする。

本章では特に、以下の方針を明示する。

* 翻訳失敗時も投稿処理は成功とするフェイルソフト方針
* 直列実行ではなく並列実行（`Promise.all` 等）を前提としたタイムアウト設計
* 編集時に不要な翻訳呼び出しを避けるコスト最適化方針

---

## 6.2 性能・タイムアウト

### 6.2.1 翻訳・TTS 呼び出しタイムアウト

**翻訳 API（Google Cloud Translation）**

* 1 回の `translateText` 呼び出しに対するアプリケーション側タイムアウト値の目安は **3 秒** とする。
* `BoardPostTranslationService.translateAndCacheForPost` / `translateAndCacheForComment` 内で複数言語を翻訳する場合、各言語の呼び出しは **並列実行（`Promise.all` 等）** とし、全体の処理時間を短縮する。
* 投稿作成 API 内での翻訳処理を含めた全体のレスポンス時間は、**3〜5 秒程度** を目安とする。Next.js (Vercel) の Serverless Function タイムアウト（10 秒 程度）を超えないように実装する。

**TTS API（Google Cloud Text-to-Speech など）**

* 1 回の `text:synthesize` 呼び出しに対するタイムアウト値の目安は **5 秒** とする。
* 掲示板詳細画面（B-02）の UX 観点から、音声再生開始まで 5〜8 秒を超える遅延は避ける。

**タイムアウト発生時の扱い**

* 翻訳:

  * 該当リクエストを「翻訳失敗」として扱い、**投稿・編集処理自体は成功とする**（新規投稿・返信投稿・編集すべて）。
  * 詳細エラーは Logger に WARN または ERROR として記録し、ユーザには汎用エラーまたは何も通知しない（UI 仕様に従う）。
* TTS:

  * 音声再生は開始しない。
  * B-02 には汎用エラーを返し、画面側で「音声読み上げに失敗しました」等のメッセージを表示する（具体的な文言は B-02 のメッセージ仕様で定義）。

### 6.2.2 同時実行・スループット想定

* 想定ユーザ数・投稿頻度が比較的小規模（マンション単位）であるため、B-04 単体に対して厳密なスループット値は設定しない。
* 設計上の前提:

  * 投稿時翻訳は「投稿ごとに 1 回」実行される。
  * 返信翻訳も「返信ごとに 1 回」実行される。
  * オンデマンド翻訳と TTS は、ユーザ操作に応じて発生するが、同時大量実行は想定しない。
* 実装者は、不要な同期処理や重複翻訳を避けることで、レスポンス時間の悪化を防ぐこと。

  * 特に編集 API では、タイトル / 本文に変更がない場合は翻訳 API を呼び出さない（6.2.3 参照）。

### 6.2.3 投稿・編集処理との関係（フェイルソフト方針 / コスト最適化）

* B-04 の翻訳・TTS は、掲示板本体機能（投稿／返信／閲覧）に対する **付加価値機能** と位置づける。
* 新規投稿・返信・編集処理の成否判定は、`board_posts` / `board_comments` への書き込み結果に基づいて判断し、翻訳／TTS の成否は含めない。
* 編集 API（POST/PUT/PATCH）では、以下の方針とする。

  * DB から現行の投稿／返信レコード（少なくとも `title` / `content`）を取得する。
  * リクエストの新しい値と比較し、**タイトルまたは本文に変更がある場合のみ** 翻訳サービスを呼び出す。
  * 公開範囲やカテゴリのみを変更する編集では、翻訳 API を呼び出さない。
* この方針により、翻訳 API の不要な呼び出しを避け、コストとレスポンスタイムを抑制する。

---

## 6.3 レート・クオータ対応

### 6.3.1 Google クオータ超過時の扱い

* Google Cloud Translation / TTS のクオータ超過・料金制限によりエラーが発生した場合:

  * B-04 のサービスはエラーを検知し、ログとして記録する（共通 Logger を利用）。
  * B-02 / B-03 へのレスポンスは「汎用エラー」とし、ユーザには詳細なクオータ情報を表示しない。
* クオータ超過が継続的に発生する場合は、運用側で GCP コンソールから利用状況を確認し、上限値調整または利用頻度の見直しを行う。

### 6.3.2 HarmoNet 側レート制限

* 現時点では、HarmoNet 独自のレート制御（例: 1 日あたりの翻訳回数制限）は導入しない。
* Route Handler / Edge Function に対するアプリケーションレベルのレート制限は本書のスコープ外とする。
* 将来的に必要となった場合の方針:

  * Next.js 側で IP / ユーザ単位の簡易レート制限を導入する。
  * もしくは Supabase 側で RPC / 関数呼び出し頻度を制御する。

---

## 6.4 セキュリティ

### 6.4.1 サービスアカウントキーの管理ルール

* Google Cloud Translation / TTS 用のサービスアカウントキーは、以下のルールで管理する。

  * Git リポジトリには **絶対に含めない**。
  * キーファイル本体は、TKD 管理のセキュアストレージ（パスワード付きアーカイブ等）で管理する。
  * ローカル開発環境では、キーファイルへのパスのみ `.env.local` に記載し、JSON 本体は記載しない。
  * 本番環境では、サービスアカウント JSON の中身を Secrets（Supabase / Vercel 等）に登録し、環境変数経由でアプリに渡す。
* パラメータシートには、以下の情報のみを記載する。

  * GCP プロジェクト ID
  * Translation/TTS 用サービスアカウントのメールアドレス
  * キーファイルの保管場所（論理名）
  * 本番環境での Secrets 名

### 6.4.2 ログ出力時の情報マスキング

* 翻訳・TTS ログにおいて、以下の情報は出力しない。

  * 投稿／返信本文の全文
  * 翻訳結果の全文
  * ユーザの個人情報（メールアドレス、氏名 等）
* ログに含める情報の例:

  * `tenantId`
  * `postId` または `commentId`
  * `lang`（source / target）
  * 呼び出し元コンポーネント（B-02 / B-03 / Edge Function）
  * 外部 API のステータス・エラーコード
  * 処理時間（ミリ秒）
* 必要に応じて本文の先頭数十文字をマスク付きでログ出力する場合は、共通 Logger 詳細設計側で許容範囲を明示する。

### 6.4.3 RLS と tenantId の整合

* `board_post_translations` / `board_comment_translations` テーブルの RLS は、`tenant_id` を基準として `board_posts` / `board_comments` と同一の制約を維持する。
* Route Handler / Edge Function から B-04 のサービスを呼び出す際は、認証コンテキストから `tenantId` を取得し、明示的にパラメータとして渡す。
* Supabase Edge Function での削除バッチにおいても、`tenantId` ごとに削除を行う設計とし、他テナントのデータを誤って削除しないようにする。

---

## 6.5 その他非機能メモ（将来拡張の余地）

* 監視・アラート:

  * 現時点では、致命的エラーの検知はログ確認ベースとし、監視システム連携（Slack 通知等）はスコープ外とする。
  * 導入する場合は、B-04 ch07 と共通 Logger 詳細設計の両方で連携方法を定義する。
* 可用性:

  * 翻訳・TTS 機能は「あると便利な付加価値機能」と位置づけ、本体掲示板機能（投稿／返信／閲覧）が動作している限り、翻訳・TTS の一時的な停止は許容できるものとする。
  * 翻訳・TTS の失敗は致命的障害ではなく警告レベルとして扱い、本体掲示板の利用継続を最優先とする。

---

本章では、B-04 BoardTranslationAndTtsService の非機能要件（性能・タイムアウト・レート・セキュリティ）を定義した。実装時には、本章の方針に従い、翻訳/TTS の失敗が掲示板本体の可用性や UX を損なわないようにする。
