# B-04 BoardTranslationAndTtsService 詳細設計書 ch06 非機能設計（性能・タイムアウト・レート・セキュリティ） v1.0

**Document ID:** HARMONET-COMPONENT-B04-BOARDTRANSLATIONANDTTSSERVICE-DETAIL-CH06
**Version:** 1.0
**Supersedes:** -
**Created:** 2025-11-22
**Updated:** 2025-11-22
**Author:** Tachikoma
**Reviewer:** TKD
**Status:** Draft

---

## 6.1 本章の目的

本章では、掲示板専用 翻訳＋音声読み上げサービス B-04 BoardTranslationAndTtsService に関する

* 性能要件（レスポンスタイム等）
* タイムアウト・リトライポリシ
* レート・クオータに関する方針
* セキュリティ（認証情報の扱い・ログマスキング等）

を定義する。UI を持たない API コンポーネントであるため、画面とは独立した非機能要件を明確にし、Windsurf が実装時に守るべき制約を提示することを目的とする。

---

## 6.2 性能・タイムアウト

### 6.2.1 翻訳・TTS 呼び出しタイムアウト

* 翻訳 API（Google Cloud Translation）

  * 1 回の `translateText` 呼び出しに対するアプリケーション側タイムアウト値: **3 秒** を目安とする。
  * `BoardPostTranslationService.translateAndCacheForPost` 内で複数言語を翻訳する場合、内部での並列／直列実行の設計に応じて、全体のタイムアウト上限を **最大 10 秒** 程度に制限する。

* TTS API（Google Cloud Text-to-Speech など）

  * 1 回の `text:synthesize` 呼び出しに対するタイムアウト値: **5 秒** を目安とする。
  * B-02 の UX 観点から、音声再生開始まで 5〜8 秒を超える遅延は避ける。

* タイムアウト発生時の扱い:

  * 翻訳:

    * 該当リクエストを「翻訳失敗」として扱い、投稿処理自体は成功とする（投稿時）／原文表示を維持する（詳細画面）。
  * TTS:

    * 音声再生は開始しない。
    * B-02 には汎用エラーを返す（詳細は B-02 メッセージ仕様）。

### 6.2.2 同時実行・スループット想定

* 想定ユーザ数・投稿頻度が比較的小規模（マンション単位）であるため、B-04 単体に対して厳密なスループット要件は設けない。
* 設計上の前提:

  * 投稿時翻訳は「投稿ごとに 1 回」実行される。
  * オンデマンド翻訳と TTS は、ユーザ操作に応じて発生するが、同時大量実行は想定しない。
* 実装者は、不要な同期処理や重複翻訳を避けることで、レスポンス時間の悪化を防ぐ。

---

## 6.3 レート・クオータ対応

### 6.3.1 Google クオータ超過時の扱い

* Google Cloud Translation / TTS のクオータ超過・料金制限によりエラーが発生した場合:

  * B-04 のサービスはエラーを検知し、ログとして記録する（ch07 参照）。
  * B-02 / B-03 へのレスポンスは「汎用エラー」とし、ユーザには詳細なクオータ情報を表示しない。
* v1.0 の時点では、HarmoNet 独自のクオータ制御（例: 1 日あたりの翻訳回数制限）は導入しない。

  * 必要になった場合、B-04 とは別に「翻訳/TTS 利用制御コンポーネント」を追加設計する。

### 6.3.2 HarmoNet 側レート制限（v1.0 の扱い）

* Route Handler / Edge Function に対するアプリケーションレベルのレート制限は v1.0 のスコープ外とする。
* 将来的に必要となった場合の方針:

  * Next.js 側で IP / ユーザ単位の簡易レート制限を導入する。
  * もしくは Supabase 側で RPC / 関数呼び出し頻度を制御する。
* 現時点では、設計書上は「レート制限は未実装」と明示し、利用状況に応じて別途検討することとする。

---

## 6.4 セキュリティ

### 6.4.1 サービスアカウントキーの管理ルール

* Google Cloud Translation / TTS 用のサービスアカウントキーは、以下のルールで管理する。

  * Git リポジトリには **絶対に含めない**。
  * ファイル本体は、TKD 管理のセキュアストレージ（例: パスワード付きアーカイブ、クラウドシークレットストア等）で管理する。
  * 環境変数 `GOOGLE_APPLICATION_CREDENTIALS` には、キーが配置されているパスのみを設定する。
  * プロジェクト内の `.env.local` 等には、実際のパスのみ記載し、JSON 本体は記載しない。
* パラメータシートには以下を記載するに留める。

  * GCP プロジェクト ID
  * サービスアカウント名（メールアドレス）
  * キーファイルの保管場所（論理名）

### 6.4.2 ログ出力時の情報マスキング

* 翻訳・TTS ログにおいて、以下の情報は出力しない。

  * 投稿本文の全文
  * 翻訳結果の全文
  * ユーザの個人情報（メールアドレス、氏名 等）
* ログに含める情報:

  * tenantId
  * postId
  * lang（source / target）
  * 呼び出し元コンポーネント（B-02 / B-03 / Edge Function）
  * 外部 API のステータス・エラーコード
  * 処理時間（ミリ秒）
* 必要に応じて、本文の先頭数十文字をマスク付きでログ出力する場合は、別途ログ設計書（共通 Logger 詳細設計）にて許容範囲を定義する。

### 6.4.3 RLS と tenantId の整合

* `board_post_translations` テーブルの RLS は、`tenant_id` を基準として `board_posts` と同一の制約を維持する。
* Route Handler / Edge Function から B-04 のサービスを呼び出す際は、必ず認証コンテキストから `tenantId` を取得し、明示的にパラメータとして渡す。
* Supabase Edge Function での削除バッチにおいても、`tenantId` ごとに削除を行う設計とし、他テナントのデータを誤って削除しないようにする（ch05 参照）。

---

## 6.5 その他非機能メモ（将来拡張の余地）

* 監視・アラート:

  * v1.0 では、致命的エラーの検知はログ確認ベースとし、監視システム連携（Slack 通知等）はスコープ外とする。
  * 将来導入する場合は、B-04 ch07 と共通 Logger 詳細設計の両方を改訂する。
* 可用性:

  * 翻訳・TTS 機能は「あると便利な付加価値機能」と位置づけ、本体掲示板機能（投稿／閲覧）が動作している限り、翻訳・TTS の一時的な停止は許容できるものとする。
  * そのため、翻訳・TTS の失敗は致命的障害ではなく「警告レベル」として扱う（本体掲示板の閲覧・投稿が継続可能であることを重視）。

以上で、B-04 BoardTranslationAndTtsService の非機能要件（性能・タイムアウト・レート・セキュリティ）を定義した。
