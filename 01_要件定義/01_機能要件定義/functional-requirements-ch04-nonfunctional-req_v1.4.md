# 第4章 非機能要件（v1.4 修正版案）

本章は **HarmoNet Technical Stack Definition v4.2** に準拠する。
HarmoNet は **Next.js 16 / React 19 / Supabase v2 系 / Corbado SDK（React + Node） / Prisma / TailwindCSS** を中核とするマルチテナント型 SaaS 基盤上に構築される。

本バージョンでは、現時点の開発・運用方針（個人開発・監視なし・外部ログサービスなし・手動デプロイ）に合わせて内容を現実的なレベルに調整する。

---

## 4.1 セキュリティ要件

### 4.1.1 認証方式

HarmoNet は、以下 2 方式を統合した **完全パスワードレス認証** を採用する：

* Supabase Auth による Magic Link 認証（一般ユーザー用）
* Corbado SDK による Passkey 認証（管理者・高度利用者用）

#### 認証フロー（論理）

1. Magic Link：ユーザーがメールアドレスを入力 → Supabase が OTP メール送信
2. Passkey：CorbadoAuth が WebAuthn 認証を実行 → `short_session` Cookie 発行
3. Supabase 側で Corbado JWT (`id_token`) を検証しセッションを確立
4. JWT には `tenant_id` / `role` / `lang` が含まれ、PostgreSQL RLS によりアクセスが制御される。

```json
{
  "sub": "user-uuid",
  "tenant_id": "tenant-uuid",
  "role": "tenant_admin",
  "lang": "ja",
  "auth_provider": "corbado|supabase",
  "exp": 1739999999
}
```

#### セキュリティ対策

| 項目         | 内容                                              |
| ---------- | ----------------------------------------------- |
| 認証強度       | WebAuthn FIDO2 + UUIDv4 トークン + HTTPS 限定         |
| トークン有効期限   | 15 分（Corbado short_session + Supabase 自動再発行）    |
| レートリミット    | Supabase: 3 リクエスト/分, Corbado: 5/分               |
| 監査ログ       | Supabase Auth Logs + Corbado Cloud Logs（システム標準） |
| 管理者強制ログアウト | Supabase Session API で invalidate() 実行可         |

---

### 4.1.2 通信暗号化

* すべての通信を **TLS 1.2 以上（基本は 1.3）** で暗号化する。
* HTTP リクエストは Vercel 側の設定により自動 HTTPS リダイレクトを行う。
* Corbado `short_session` Cookie は `Secure` + `SameSite=Lax` を基本設定とする。
* Supabase・Corbado の API キー・秘密鍵は環境変数（`.env.local` / Vercel Secrets）で管理し、Git 管理下には置かない。
* 将来、氏名・住所等のセンシティブ情報を扱う場合は、DB 暗号化方式（AES-256 等）を別途検討する。

---

### 4.1.3 データ分離（RLS）

Supabase PostgreSQL の **Row Level Security (RLS)** により、テナント単位でデータアクセスを分離する。

```sql
CREATE POLICY tenant_isolation_policy
ON public.announcements
USING (tenant_id = auth.jwt() ->> 'tenant_id');
```

* すべての業務テーブルに `tenant_id` カラムを持たせることを原則とする。
* `auth.jwt()` の内容に基づき、自動的にデータスコープを制御する。
* Corbado でログインした場合も Supabase 側で JWT 検証が行われるため、テナント越境は起きない設計とする。

---

### 4.1.4 鍵管理

| 項目                 | 管理方法                                     |
| ------------------ | ---------------------------------------- |
| 暗号鍵                | Supabase Secrets / 環境変数で管理し API からは取得不可  |
| Corbado API Secret | サーバ側 `.env` のみに配置しクライアントへ露出させない          |
| 鍵ローテーション           | 重大インシデント発生時に手動でローテーションする（定期ローテーションは将来検討） |
| JWT 署名方式           | Supabase 標準（HS256）を利用                    |
| API キー管理           | Supabase Service Role キーはローカル開発と管理用途に限定  |

---

## 4.2 性能要件

### 4.2.1 目標値（MVP）

| 項目      | 目標値               | 備考                                |
| ------- | ----------------- | --------------------------------- |
| 初回ページ表示 | 3.0 秒以内           | Vercel Hobby + 基本的なコード分割・画像最適化    |
| 再訪時表示   | 1.5 秒以内           | ブラウザキャッシュ・Next.js の最適化を前提         |
| 翻訳応答    | 3 秒以内（500 文字相当）   | StaticI18nProvider を基本とし動的翻訳は将来検討 |
| API 応答  | 2 秒以内（95 パーセンタイル） | Supabase Query のインデックス最適化         |
| DB クエリ  | 1 秒以内             | 必要に応じてインデックス追加                    |
| 同時アクセス  | 100 ユーザー程度        | MVP 規模。将来の拡張はスケーラビリティ要件で扱う        |

### 4.2.2 最適化方針

* Next.js App Router の標準的な最適化（Dynamic Import・画像最適化）を行う。
* 不要なライブラリを避け、バンドルサイズを抑制する。
* クエリ回数を減らし、必要に応じてシンプルなキャッシュ（メモリ・ブラウザ側）を利用する。
* Supabase 側のインデックス設計は、実際の利用状況を見ながら段階的に調整する。

---

## 4.3 アクセシビリティ

HarmoNet は **WCAG 2.2 Level AA 相当** を目標とし、
BIZ UD ゴシックを基調とした「やさしく・自然・控えめ」デザインで、操作性と安心感を重視する。

| 区分  | 要件                                      |
| --- | --------------------------------------- |
| 視覚  | コントラスト比 4.5:1 以上、200% 拡大でも利用可能であること     |
| 操作  | キーボードで主要操作が行えること（ログイン、言語切替など）           |
| 理解  | エラーメッセージはユーザーが次に何をすべきかを理解できる文章であること     |
| 多言語 | 日本語・英語・中国語（簡体）に対応し、文言は i18n キーで一元管理すること |

#### Passkey 操作支援

* WebAuthn 操作時に明示的な進行状態を表示する（例：`auth.passkey.progress`）。
* キーボードナビゲーションで Passkey ボタンへフォーカス移動できるようにする。
* 成功時・失敗時のメッセージは、多言語化された短い文言で統一する。

---

## 4.4 スケーラビリティ

### 4.4.1 基本方針

* 初期は **Supabase Free / Pro + Vercel Hobby** の範囲で運用し、
  利用状況に応じて Supabase プランや Vercel プランを段階的に引き上げる。
* 外部のキャッシュサービス（Redis 等）や CDN 拡張（Cloudflare 等）は、
  実際の負荷が問題になったタイミングで個別に検討する（現時点では必須としない）。

### 4.4.2 想定利用規模と構成（現実的な範囲）

| 段階    | ユーザー規模            | 想定構成                                     |
| ----- | ----------------- | ---------------------------------------- |
| MVP   | 100 ユーザー／単一物件     | Supabase Free Tier + Vercel Hobby        |
| 小規模展開 | 300〜500 ユーザー／複数物件 | Supabase Pro（単一リージョン） + Vercel Pro プラン検討 |

それ以上の規模（複数管理会社・数千ユーザー）に拡張する場合は、
別途スケーラビリティ要件とインフラ設計を見直す。

---

## 4.5 信頼性・可用性

現状、HarmoNet は個人開発プロダクトとして運用されるため、
商用サービスレベルの高い可用性は要求しない。以下に現実的な要件を定義する。

| 項目     | 要件                                                    |
| ------ | ----------------------------------------------------- |
| 稼働率    | 明示的な SLA は定めない。Supabase / Vercel のサービス稼働状況に依存する。      |
| バックアップ | Supabase の自動スナップショット機能に依存し、必要に応じて手動エクスポートを行う。         |
| 保持期間   | Supabase の標準バックアップ保持期間に従う（詳細は運用時に確認）。                 |
| 監視     | 専用監視サービスは導入しない。異常時は開発者が Vercel / Supabase のログを手動確認する。 |
| 復旧手順   | 障害発生時は Supabase 管理画面からリストアし、必要なら Vercel へ再デプロイする。     |
| デプロイ   | ローカル開発環境から Vercel ダッシュボード経由で手動デプロイを実施する。CI/CD は将来検討。  |

---

## 4.6 メンテナンス性・拡張性

| 観点     | 内容                                                              |
| ------ | --------------------------------------------------------------- |
| SDK 更新 | Corbado・Supabase SDK のメジャー更新はリリースノートを確認し、影響が小さい範囲で追従する。         |
| スキーマ管理 | Prisma Migrate を基本とし、必要に応じて Supabase Migration を併用する。           |
| 環境変数管理 | `.env.local` / Vercel Secrets を用いて、機密情報を Git リポジトリ外で管理する。       |
| ログ運用   | ログは Supabase / Vercel の標準ログ画面で確認し、外部ログ可視化サービスは導入しない。            |
| コード規約  | ESLint + Prettier を導入し、型エラー・Lint エラーがない状態を基本とする（100% テストは将来検討）。 |

---

## 4.7 セキュリティ監査・法令準拠

| 区分        | 内容                                                     |
| --------- | ------------------------------------------------------ |
| 個人情報保護    | 日本の個人情報保護法を意識し、不要な個人情報は収集しない。将来の商用化時に改めて精査する。          |
| Cookie 方針 | 認証・セッション維持に必要な Cookie のみに限定し、ポップアップ広告用 Cookie 等は使用しない。 |
| セキュリティ監査  | 外部ペネトレーションテストは現時点では実施しない。商用展開時に必要性を再評価する。              |
| データ削除     | ユーザー退会機能実装時に、関連データを一定期間（例：7 日）内に削除できるように設計する。          |
| 開発者権限     | Supabase・Vercel の管理権限は最小限のアカウントに限定し、共有アカウントは作成しない。     |

---

## 4.8 ログ要件

### 4.8.1 ログ種別と目的

HarmoNet では、現時点で以下 2 種類のログのみを扱う。

| 種別             | 目的             | 主な利用者 |
| -------------- | -------------- | ----- |
| アプリケーションログ（AP） | 障害解析・開発時の動作確認  | 開発者   |
| エラーログ          | 例外発生箇所の特定・原因調査 | 開発者   |

> 注記：操作履歴・コンプライアンス目的の「監査ログ（Audit）」は、
> 現時点のスコープから除外し、将来の商用展開フェーズで必要になった場合に検討する。

### 4.8.2 出力先の基本方針

1. **アプリケーションログ（AP）**

   * アプリケーションコードからは `console.log` / `console.info` / `console.warn` などで **標準出力（stdout）** に出力する。
   * 本番環境では、Vercel の標準ログビューアで確認する。Log Drains や外部ログサービスとの連携は行わない。
   * ローカルディスクのログファイル出力や、AP ログの DB 永続化は行わない。

2. **エラーログ**

   * 例外・致命的エラーは `console.error` で標準出力に出力する。
   * エラートラッキングサービス（Sentry など）は利用しない。
   * 必要に応じて、スタックトレースや簡易的なコンテキスト（画面名・イベント種別など）を JSON 形式で出力する。

### 4.8.3 ログレベルと最小要件

* ログレベルは、`DEBUG / INFO / WARN / ERROR` を基本とする。
* 本番環境では、最低限 `INFO` 以上を出力し、`DEBUG` ログは開発時のみに使用することを推奨する。
* 個人情報（氏名・メールアドレス・住所・電話番号等）は、ログに平文で出力しない。どうしても必要な場合は匿名化 ID などで代替する。

### 4.8.4 保持期間とアクセス制御（方針）

* アプリケーションログ・エラーログは、Vercel・Supabase が提供する標準ログ保持期間に依存する。

  * Vercel の標準ログはおおむね **7 日間** 程度の保持を想定し、それ以上の長期保存は要件としない。
* ログへのアクセス権限は、HarmoNet 開発者（TKD）のみを想定し、外部利用者には公開しない。

### 4.8.5 ログ設計書との関係

* ログの具体的なフォーマット（JSON 構造）や、画面・機能ごとの出力ポイントは、別途「HarmoNet ログ出力 基本設計書」にて定義する。
* 各画面・機能の詳細設計書（例：LoginPage 詳細設計）では、本章の方針に従い、

  * どのイベントで
  * どのレベルで
  * どのようなメッセージを
    記録するかを定義する。

---

## 4.9 監視・運用要件

### 4.9.1 現時点の方針

* HarmoNet は個人開発プロダクトであり、以下を前提とする。

  * システム停止や障害が発生しても、即時復旧は必須ではない。
  * 1〜2 日程度の停止が発生しても、重大な業務影響は想定しない。
* 上記前提により、専用の監視サービス（Sentry / UptimeRobot 等）やアラート通知（メール・Slack 等）は導入しない。
* 障害検知は、利用者または開発者が画面の異常・レスポンス異常に気づいたタイミングで、Vercel / Supabase のログを手動確認する運用とする。

### 4.9.2 将来の監視方式（候補）

将来的に監視・アラートが必要になった場合に備え、候補のみを記載する。

* 監視対象（例）

  * Web フロントエンドの稼働状況（HTTP 5xx / レイテンシ）
  * Supabase（DB / Auth）の稼働状況
* 監視方式（例）

  * Vercel / Supabase が提供するメトリクス・ログを用いたダッシュボード
  * 外部監視サービスによる HTTP ヘルスチェック（別途契約が必要なため現時点では導入しない）
* アラート（例）

  * 一定期間 5xx が継続した場合のメール通知
  * 応答遅延が閾値を超えた際の通知

> 注記：本バージョンでは上記はあくまで将来の候補とし、
> 監視・アラートの具体的な実装はスコープ外とする。

---

**Document ID:** HARMONET-REQ-NFR-V1.4

**Version:** 1.4

**Created:** 2025-11-12

**Updated:** 2025-11-15（現実的な運用方針に合わせて全体を見直し）

**Supersedes:** v1.3

**Author:** Tachikoma / TKD

**Reviewer:** TKD

**Status:** Draft-修正版案（技術スタック v4.2 / 現行運用方針に整合）

**Directory:** /01_docs/01_要件定義/01_機能要件定義/functional-requirements-ch04-nonfunctional-req_v1.4.md
