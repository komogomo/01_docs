# HarmoNet：MagicLink 認証仕様まとめ（非機能要件）_v1.0

## 1. 目的

MagicLink（メール認証）は、HarmoNet における **パスワードレス認証の基盤方式** であり、Passkey と並ぶ主要なログイン手段として採用する。本書は MagicLink の動作原則、UI/UX、非機能要件、サーバ構成上の取り扱いを整理し、HarmoNet の正式仕様として確立することを目的とする。

MagicLink は「誰もが利用可能な、最も確実なバックアップ認証方式」として設計し、Passkey（生体認証）が利用できないユーザー・端末・環境下でも安定してログインできることを重視する。

---

## 2. MagicLink の動作原則

MagicLink は次のステップで成立する。

1. ユーザーがメールアドレスを入力
2. Supabase Auth がワンタイムリンク（OTP）メールを送信
3. ユーザーがメール内の MagicLink をクリック
4. `/auth/callback` でセッションを確立しログイン完了

MagicLink は **登録（サインアップ）とログインを同一操作で兼用**できるため、Passkey と同様に別途「ユーザー登録画面」を必要としない。

---

## 3. MagicLink の役割（HarmoNet 内位置付け）

MagicLink は以下の役割を担う：

### ● 3.1 Primary fallback 認証

* Passkey が利用できない環境（古い端末・PC・会社支給端末など）
* Passkey の登録を行わないユーザー
* OS側の生体認証が未設定

### ● 3.2 初回ログイン手段としての利用

Passkey が利用できないユーザーにとって、MagicLink は **初回登録／認証手段として必須**。

### ● 3.3 トラブル時のバックアップ経路

* Passkey デバイス紛失
* 生体認証が壊れた
* Corbado 停止など外部サービス障害時

MagicLink は **自力で復旧可能な唯一の認証経路**となる。

---

## 4. サーバ構成上の位置づけ

HarmoNet の MagicLink は **Supabase Auth のネイティブ機能**をそのまま利用する。

### ● 4.1 必要な構成要素

* Supabase Auth（MagicLink）
* Vercel フロントエンド

### ● 4.2 MagicLink がサーバレスで運用できる理由

MagicLink の実装は Supabase 側で完結し、以下が不要：

* 常時稼働する API サーバ
* 署名鍵管理
* RP ID / WebAuthn チャレンジ管理

**HarmoNet のサーバレス方針を崩さずに運用できる。**

---

## 5. UI / UX 仕様

MagicLink は HarmoNet ログイン画面で **左側のカードタイル UI（A-01）** として提供する。

### ● 5.1 UI 要素

* メールアイコン
* タイトル（例："メールでログイン"）
* 説明文
* メールアドレス入力フィールド
* 「ログイン」ボタン
* 結果メッセージ領域

### ● 5.2 状態遷移（A-01 設計書と一致）

* `idle`（初期）
* `sending`（MagicLink送信中）
* `sent`（送信完了）
* `error_input`（入力不備）
* `error_network`（通信エラー）
* `error_auth`（認証エラー）
* `error_unexpected`（想定外エラー）

### ● 5.3 UX 重視ポイント

* 入力欄は E メールのみに限定
* ボタン連打時に二重送信防止
* 成功後の案内は控えめに（A1 基本設計の UI トーンを踏襲）

---

## 6. セキュリティ / 非機能要件

MagicLink は純粋なパスワードレスであり、以下の非機能要件を満たす。

### ● 6.1 セキュリティ

* MagicLink の有効期限は Supabase 標準設定を採用（短時間）
* トークン露出防止のため HTTP Only Cookie ベースセッションを利用
* Redirect URL は HarmoNet の認証用エンドポイントに限定
* Supabase Auth のレートリミットを活用（過剰試行対策）

### ● 6.2 可用性

* Supabase がサービス提供しているため、MagicLink は外部 API 障害の影響を受けにくい
* Passkey 停止時の唯一のバックアップとして利用可能

### ● 6.3 運用性

* Supabase Auth に完全依存するため、サーバ運用コストはゼロ
* メールテンプレートは Supabase 側でデフォルト利用（必要に応じて後日カスタム）

---

## 7. Passkey との棲み分け

MagicLink は Passkey に比べて手順は多いが、万能性が高い。

| 項目        | MagicLink | Passkey      |
| --------- | --------- | ------------ |
| 初回ログイン    | ◎         | ◎            |
| 2回目以降ログイン | ○         | ◎（最速）        |
| デバイス依存    | なし        | あり（デバイスごと登録） |
| サーバレス運用   | ◎         | △（専用RPが必要）   |
| トラブル復旧    | ◎         | △            |

**結論：MagicLinkは“誰でも必ず利用できる基盤”、Passkeyは“高速で安全な次世代手段”。**

HarmoNet ではこの2方式を並列提供する設計が最も安定する。

---

## 8. 将来展望（Supabase Passkey 対応を見据えて）

Supabase が将来的に WebAuthn / Passkey をネイティブ実装する可能性が高く、MagicLink は引き続きバックアップ認証方式として存在意義が強い。

MagicLink は次の理由で今後も必須：

* Passkey デバイス紛失時の復旧
* 高齢ユーザやガラケーメール利用者への対応
* 端末互換性を問わないユニバーサルアクセス

**MagicLink は HarmoNet の永続的な“保険”として継続運用する。**

---

## 9. 最終結論

MagicLink は HarmoNet において以下の役割を正式に担う：

* 誰でも利用できる普遍的パスワードレス認証
* Passkey と並列で提供する安全な認証方式
* サーバレス構成での実現が可能で、運用負荷が極小
* Passkey 停止時のバックアップラインとして不可欠

現行の A-01 / A-02 / A-00 の仕様と完全整合し、**構造的な変更は不要**。
今後は Passkey の普及度を見つつ、MagicLink は HarmoNet で永続的にサポートする標準方式とする。

---

以上。
