# HarmoNet 開発進捗サマリ（〜 2025-11-21）

本メモは、TKD / 各コードエージェント / Gemini 用の「進捗共有用サマリ」です。  
正式な仕様は各設計書（FR/NFR/技術スタック/画面別基本設計）を正とします。

---

## 1. ホーム画面（HOME）まわり

### 1.1 設計状況

- HOME 画面の役割
  - ログイン後の最初の画面として、各機能へのダッシュボード的な導線を提供。
  - 掲示板／施設予約などの「最新サマリ」をカード形式で表示。
- 設計レベル
  - HOME の詳細な基本設計書（単体）はまだ未作成。
  - 掲示板との関係は `board-design-ch02`（画面一覧と導線）で定義済み。
    - HOME 内掲示板サマリセクション
      - タイトル例: 「掲示板からのお知らせ」
      - タブ: ALL / NOTICE / RULES（表示中タブを強調）
      - 各タブごとの最新投稿 3 件（最大）を表示
      - 「もっと見る」ボタン → `/board?tab=<現在のタブ>` に遷移
    - HOME では閲覧のみ、投稿や詳細操作は `/board` 側に集約する方針。
- 今後の予定
  - HOME 画面単体の基本設計書を作成（ロゴ・共通ヘッダー・カードレイアウト・掲示板以外のカードを整理）。
  - HOME 実装は、ログイン画面／掲示板基本設計が固まった後に着手予定。

### 1.2 実装状況

- AppHeader / AppFooter / LanguageSwitch / StaticI18nProvider は実装済み。
- HOME 専用のコンポーネント構成はまだ本格実装前（骨組みレベル）。
- ログイン → HOME への遷移は動作するが、HOME のコンテンツはこれから詰めていく段階。

---

## 2. 上位仕様（FR/NFR/技術スタック）

### 2.1 要件・技術スタック

- 機能要件：`functional-requirements-all_v1.6.md`
- 非機能要件：`Nonfunctional-requirements_v1.0.md`
- 技術スタック：`harmonet-technical-stack-definition_v4.4.md`
- 掲示板設計決定サマリ：`HarmoNet-bbs-board Design-decision-summary_v1.0.md`

→ 掲示板を含む現行スコープの FR/NFR/Tech は、この組み合わせで確定済み。

### 2.2 共通方針

- 認証：Supabase Auth の MagicLink（メール OTP のみ）。Passkey はペンディング。  
- 多言語：StaticI18nProvider による JA/EN/ZH の静的辞書 + 掲示板投稿時の 3 言語自動翻訳。  
- バックエンド：Next.js App Router + Supabase（PostgreSQL + RLS）構成。

---

## 3. ログイン・共通部品

### 3.1 ログイン・AuthCallback

- ログイン画面 基本設計／詳細設計：完了（MagicLink のみ）。
- MagicLink Backend 基本設計：完了。  
  - `/login` でメールを入力 → マジックリンク発行。
  - `/auth/callback` でセッション確立 → `/` などへ遷移。
  - `redirect` パラメータによる遷移制御は設計済み（掲示板ショートカットURLと連携予定）。
- Windsurf によるコードチェック済み（重大な問題なし）。

### 3.2 共通コンポーネント

- AppHeader / AppFooter：
  - 基本・詳細設計あり。実装済み（UIトーンは HarmoNet 共通ルール）。
- LanguageSwitch / StaticI18nProvider：
  - 基本・詳細設計あり。
  - 3 言語（JA/EN/ZH）の切り替え動作確認済み。
- 共通ログ／共通メッセージ：
  - ロガー基本・詳細設計あり（Supabase / Vercel ログ出力）。
  - メッセージキー仕様は掲示板を含めた共通方針として設計進行中。

---

## 4. 掲示板 基本設計（BoardTop / Detail / 投稿 / 共通）

### 4.1 掲示板 index（ch00）

- `board-design-ch00-index_v2.2`：
  - 旧セキュレアシティ版を廃止し、HarmoNet 版 index を再作成。
  - 掲示板に関する画面仕様の「唯一の正」は ch01〜07 と定義。
  - 上位仕様（FR v1.6 / NFR v1.0 / TechStack v4.4 / BBS Design-decision-summary v1.0）との関係を明示。

### 4.2 第1〜7章（v2.x）

- **ch01 概要・方針**：
  - 掲示板の目的・背景（安心感・管理負担軽減・多文化共生）。
  - AIモデレーションは「付加価値」、翻訳は「3言語自動翻訳＋キャッシュ」を前提とする方針を整理。

- **ch02 画面一覧と導線**：
  - HOME／BoardTop／BoardDetail の役割と遷移。  
  - HOMEの掲示板サマリ（タブ付き最新3件表示＋「もっと見る」→`/board?tab=...`）。
  - タブ（ALL/NOTICE/RULES）＋範囲（GLOBAL/GROUP）の基本定義。

- **ch03 BoardTop 一覧**：
  - カード構造（タグバッジ／タイトル／メタ情報／本文サマリ／添付アイコン／ピン留め／回覧板ステータス）。
  - タブ仕様：
    - ALL：全投稿。
    - NOTICE：管理組合ロールの「お知らせ」投稿（回覧板含む）。
    - RULES：長期参照されるルール類。
  - 範囲（GLOBAL/GROUP）とデフォルト表示（GLOBAL＋所属グループ）。
  - ソート（ピン留め → 投稿日時降順）とページネーション。  
  - 空状態・エラー状態の表示方針。

- **ch04 BoardDetail（投稿詳細）**：
  - タイトル／カテゴリ／メタ情報／本文の構造。
  - 添付ファイル表示エリアと PDF モーダルプレビュー（掲示板詳細限定）。
  - コメント一覧（1階層）、コメント入力エリアの基本方針。  
  - 管理投稿向け既読エリア（「既読にする」ボタン＋既読率表示）。
  - 掲示板画面限定の音声読み上げ（TTS）と翻訳表示の扱い。

- **ch05 投稿作成（新規・編集）**：
  - カテゴリ／タイトル／本文／公開範囲（GLOBAL/GROUP）／添付／回覧板フラグ等の入力仕様。
  - 文字数上限：
    - システム絶対上限 5000 文字。
    - テナント上限 1〜5000（管理画面から設定可、未設定時 2000）。
  - 添付上限：
    - 絶対上限：1投稿 10 個・1ファイル 5MB。
    - テナント上限：1〜10 個（デフォ 5）、1〜5MB（デフォ 5MB）。
  - 保存時に 3 言語自動翻訳をトリガし、translation_cache を更新。
  - 回覧板フラグ／管理投稿フラグを扱う設計（管理投稿の既読管理と連動）。

- **ch06 共通仕様（翻訳・音声・モデレーション）**：
  - 3 言語自動翻訳：
    - 投稿保存時（新規／編集）にタイトル＋本文を JA/EN/ZH に自動翻訳し、translation_cache に保存。
    - BoardTop／Detail／HOME 掲示板サマリは、LanguageSwitch のアクティブ言語のキャッシュ済み訳文を表示。
    - 原文ボタンは設けず、言語切替は LanguageSwitch に統一。  
  - TTS：
    - 掲示板画面（主に投稿本文）限定で音声読み上げを提供。
    - tts_cache（投稿ID＋言語＋本文ハッシュ）で音声をキャッシュし、再利用。
  - AI モデレーション：
    - 任意導入の付加価値機能として位置づけ（デフォルトOFF）。
    - `moderation_enabled`（ON/OFF）＋ `moderation_level`（LV1/LV2）をテナント設定で制御。  
    - エラー時は投稿をブロックせず、「モデレーション無し」で投稿を通す方針。

- **ch07 補助機能（既読・通報・アンケート拡張）**：
  - 既読管理：
    - 管理組合ロール投稿だけを対象に、「既読にする」ボタン＋既読率（既読世帯数／対象世帯数）を表示。
    - BoardTop には自分の既読／未読バッジを控えめに表示。
    - 個票レベル（誰が既読か）はテナント管理者画面でのみ閲覧可能。
  - 通報機能：
    - 投稿／コメントに対する通報（理由選択＋任意コメント）を詳細画面から送信。
    - 通報はメール通知＋管理画面の通報一覧で処理する想定。
  - アンケート／議決機能（将来拡張）：
    - 管理投稿にひも付くアンケートをテナント設定 `survey_enabled` に応じて ON/OFF。
    - 住民側には集計のみ表示、個票は管理画面のみで閲覧。

---

## 5. 掲示板 詳細設計インプット

- BoardDetail 機能ルール（ch05–07 functional）：
  - コメント／PDFモーダル／トースト等の細かいルール集。  
  - 基本設計に吸収済みだが、今後の詳細設計時のインプットとして保持。
- リッチテキスト詳細設計：
  - `board-richtext-integration_v1.0.md`  
    - TipTap構成／content_json/html／サニタイズ／翻訳・TTS連携に関する詳細。

---

## 6. 実装状況（ざっくり）

### 6.1 共通・ログインまわり

- MagicLink 認証フロー（Supabase Auth）：
  - 実装：完了  
  - `/login` → メール送信（OTP）  
  - `/auth/callback` → セッション確立 → HOME  
  - Windsurf によるコードチェック済（致命的問題なし）。
- ログイン画面 UI：
  - 実装：完了  
  - MagicLinkForm・Header・LanguageSwitch 結合済。
- 共通部品：
  - AppHeader / AppFooter：実装完了。  
  - LanguageSwitch / StaticI18nProvider：実装完了（3言語切替済）。

### 6.2 ホーム画面

- HOME ページ：
  - ルーティング／遷移：ログイン後に HOME 表示は可能。  
  - UI／カード構成：掲示板サマリ含め本実装はこれから（骨組み段階）。

### 6.3 掲示板

- DB スキーマ：
  - 掲示板関連テーブル（post・translation_cache・tts_cache・承認系など）：追加済。  
  - 最新 schema.prisma に反映済。
- フロントエンド：
  - BoardTop（/board）：未実装（これから）。  
  - BoardDetail（/board/[id]）：未実装（これから）。  
  - 投稿フォーム：未実装（これから）。
- バックエンド（掲示板専用処理）：
  - 投稿CRUD／翻訳連携／TTS連携／既読／通報／アンケートAPI：未実装（これから）。

---

## 7. 一行まとめ（現状の立ち位置）

- 要件定義・技術スタック・ログイン・共通部品の設計と実装はほぼ固まっている。  
- 掲示板は ch00〜07 の基本設計が完了し、翻訳・TTS・モデレーション・既読・通報・アンケートまで仕様が一通り揃った段階。  
- DB スキーマは掲示板用テーブルを追加済みだが、BoardTop/Detail/投稿フォームのフロント実装と掲示板バックエンドはこれから本格着手。
