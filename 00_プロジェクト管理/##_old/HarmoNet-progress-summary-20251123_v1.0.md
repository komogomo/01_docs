本日の進捗を「進捗管理表」に追記する前提でまとめます。
（WS からの作業レポートは別途として、タチコマ側の整理です）

---

### 本日の進捗サマリ（2025-11-23）

| 区分          | 内容                                                                                                                                                                                                                                                            |
| ----------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| DB設計        | `tenant_residents` テーブルを追加する方針を決定。`schema.prisma` に「住民基本情報」モデルとして定義し、`tenant_id / user_id? / residence_code / real_name / real_name_kana / phone_number? / status` を持たせる構成で確定。`users` は「ユーザ認証情報＋ニックネーム(display_name)」専用とし、実名系は `tenant_residents` に集約する設計で整理。 |
| DB反映        | `prisma migrate dev` は既存 Supabase スキーマとのドリフトにより採用せず、開発フェーズでは引き続き `npx prisma db push` を用いてスキーマ追従のみ行う方針を再確認。将来スキーマが完全に固まった段階で、初期 migration を切って Prisma Migrate を本格導入する、という二段階戦略を再確認。                                                                           |
| 運用設計        | 商用環境でのスキーマ変更方針を整理：小さな変更はバックアップ＋通常 migration / SQL、大掛かりな変更はミラーDB（Blue-Green）切替でリスク回避する方針を言語化。TKD のこれまでの考え方が実務的に妥当であることを確認。                                                                                                                                     |
| 掲示板投稿API不具合 | `/api/board/posts` の 500（RLSエラー）について、WSの調査結果をレビュー。原因が `board_posts` への Supabase 経由 INSERT が RLS (`board_posts_insert` の WITH CHECK) を満たさないためであることを確認。RLS／スキーマ変更禁止の前提のもと、「認可チェックは `user_tenants`、INSERT は Prisma 直挿し」に統一する方針を受け入れ。                             |
| WSの修正内容確認   | WS が実施した以下の修正内容を確認：① サーバ共通 `prisma` クライアントの追加、② `moderationService` を共通クライアント利用に変更、③ `/api/board/posts` でリクエスト `tenantId` は信用せず `user_tenants` から `tenantId` を確定、④ `board_posts` の INSERT を Supabase→Prisma に変更し、RLS をバイパスしつつ認可は維持する構成に変更。                    |
| 動作確認（管理組合）  | 管理組合ロールで `/board/new` からテスト投稿。`board_posts` に `status = 'published'` で1件登録され、author_id / tenant_id / category_id が期待どおりであることを Supabase Studio で確認。投稿後は遷移先ページ未実装のため 404 になる状態を確認（仕様上、掲示板TOP実装後に解消予定）。添付ファイルは現時点で保存されていないことも確認。                                 |
| 動作確認（一般利用者） | 一般利用者ロールでも `/board/new` から投稿が成功し、`board_posts` に2件目のレコードが追加されることを確認。一般利用者画面では投稿区分 UI が非表示になっており、仕様どおりであることを確認。匿名／ニックネーム表示や PDF プレビューは掲示板詳細側の機能であるため、BoardDetail 実装後に再テストする方針とした。                                                                              |
| 今後の方針       | 掲示板投稿画面の基本仕様（フォーム入力→API→DB保存）はひとまず完了とし、次ステップとして掲示板TOP `/board` の実装に進む方針を確定。ログイン→ホーム→掲示板TOP→掲示板投稿→掲示板TOP の1ルートを完成させ、その後に掲示板詳細 `/board/[postId]` と「詳細から返信 → 自分の返信が見える」フローを第二段階として実装する方針で合意。                                                                     |

この内容を、TKD ローカルの進捗管理表の「2025-11-23」の行（または本日の欄）に転記してもらえれば、本日のタチコマ分の更新としては完了です。
