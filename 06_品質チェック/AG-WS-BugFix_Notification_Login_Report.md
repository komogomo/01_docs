# 不具合修正・機能復旧作業報告書

**作成日:** 2025年11月27日
**作成者:** Antigravity
**対象システム:** HarmoNet

## 1. 概要
本レポートは、以下の2点の不具合修正および機能復旧作業に関する報告です。
1.  **掲示板通知バッジの挙動不具合**（消えない、他ユーザーと同期してしまう、古い記事で消えてしまう等の問題）
2.  **ログイン時の未登録メールアドレスに対するエラー表示の復旧**

## 2. 対応内容詳細

### 2.1. 掲示板通知バッジ不具合修正

#### 発生していた事象
*   **事象A:** 掲示板詳細画面を開いても通知バッジが消えない（初期状態）。
*   **事象B:** 掲示板投稿画面（`/board/new`）に遷移するとホーム画面にリダイレクトされる。
*   **事象C:** 一人のユーザーが閲覧すると、他のユーザーのバッジも消えてしまう（状態の共有）。
*   **事象D:** 新規投稿以外の（古い）記事を閲覧しただけで、最新の投稿に対する通知まで消えてしまう。

#### 原因と対策
| 事象 | 原因 | 対策 |
| :--- | :--- | :--- |
| **A** | `user_tenants` テーブルから削除された `status` カラムへの参照がAPIに残っており、500エラーが発生していた。また、Prisma Clientの同期ズレにより `joined_at` カラムエラーも発生。 | API内の不要な `status` チェックを削除。Prisma Clientの再生成を実施。 |
| **B** | `board_categories` テーブルの参照用RLSポリシー（SELECT）が欠落しており、カテゴリ取得に失敗していた。 | `board_categories` に対する正しいRLSポリシー（所属テナントのカテゴリのみ参照可）を再作成。 |
| **C** | Next.js の仕様により、APIレスポンス（「未読なし」の状態）がサーバー側でキャッシュされ、他ユーザーにもそのキャッシュが返されていた。 | 通知関連API（`has-unread`, `mark-seen`）に `export const dynamic = 'force-dynamic'` を追加し、キャッシュを無効化。 |
| **D** | 既読更新ロジックが「閲覧時の現在時刻」で更新する仕様だったため、過去の記事を見ても「現在までの全記事を既読」として処理されていた。 | 既読更新ロジックを「閲覧した投稿の作成日時」で更新するように変更（ただし、既にそれより新しい日時が記録されている場合は更新しない）。 |

### 2.2. ログイン時の未登録メールアドレスチェック復旧

#### 発生していた事象
*   未登録のメールアドレスを入力してログインボタンを押してもエラーにならず、「メールを送信しました」と表示される（実際には送信されない）。

#### 原因
*   Supabaseのセキュリティ仕様（ユーザー列挙防止）または以前のチェック機構（`user_profiles` 等）の削除により、フロントエンドでの事前チェックが行われなくなっていた。

#### 対策
*   **専用APIの作成:** 管理者権限で `users` テーブルを検索し、メールアドレスの登録有無を返すAPI (`/api/auth/check-email`) を新規作成。
*   **フロントエンド修正:** `MagicLinkForm` コンポーネントにて、ログイン処理の前に上記APIを呼び出し、未登録の場合はエラーを表示して処理を中断するよう修正。
*   **多言語対応:** 日・英・中の各言語ファイルにエラーメッセージを追加。

## 3. 修正ファイル一覧

### バックエンド (API/DB)
*   `app/api/board/notifications/has-unread/route.ts` (キャッシュ無効化)
*   `app/api/board/notifications/mark-seen/route.ts` (キャッシュ無効化、ロジック変更)
*   `app/api/auth/check-email/route.ts` (**新規作成**)
*   `prisma/schema.prisma` (確認のみ)
*   (DB操作) `board_categories` RLSポリシー作成

### フロントエンド
*   `src/components/board/BoardTop/BoardTopPage.tsx` (一時的な変更をロールバック)
*   `src/components/auth/MagicLinkForm/MagicLinkForm.tsx` (存在チェック追加)
*   `public/locales/ja/common.json` (メッセージ追加)
*   `public/locales/en/common.json` (メッセージ追加)
*   `public/locales/zh/common.json` (メッセージ追加)

## 4. 検証結果

*   **通知バッジ:**
    *   [x] 未読記事がある状態でバッジが点灯することを確認。
    *   [x] 該当記事の詳細画面を開くとバッジが消灯することを確認。
    *   [x] 古い記事を開いても、新しい未読記事のバッジは消えないことを確認。
    *   [x] 複数ユーザー（ブラウザ）で操作しても、互いの既読状態が干渉しないことを確認。
*   **ログイン:**
    *   [x] 未登録メールアドレス入力時に「メールアドレスが登録されていません」とエラー表示されることを確認。
    *   [x] 登録済みメールアドレス入力時には正常に送信完了メッセージが表示されることを確認。

以上
