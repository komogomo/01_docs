# AG-INV02 調査報告書: ユーザ / テナント所属ステータス利用状況

## 1. 概要

### 各カラムの利用状況まとめ

| テーブル | カラム | 利用状況 | 意図・用途 |
| :--- | :--- | :--- | :--- |
| **users** | `status` | **利用あり** | ログイン時のアカウント有効性チェック (`active` のみ許可) |
| **user_tenants** | `status` | **利用あり** | テナント所属の有効性チェック (`active` のみ許可) |
| **user_tenants** | `joined_at` | **利用なし** | コード上での参照・更新ロジックは見当たらず (情報としての保持のみ) |
| **user_tenants** | `board_last_seen_at` | **利用あり** | 掲示板の未読通知バッジ判定 (最終閲覧日時として使用) |

## 2. 詳細調査結果

### 2-1. `users.status`
*   **利用箇所**:
    *   `app/auth/callback/route.ts`: ログインコールバック時に `status = 'active'` を確認。
    *   `app/home/page.tsx`: ホーム画面表示時に `status = 'active'` を確認。
    *   各APIルート (`api/board/posts` 等): データ取得前にユーザーの有効性を確認。
*   **挙動**: `active` 以外のユーザーは、認証済みであってもアプリケーションへのアクセスが拒否され、エラー画面またはログイン画面へリダイレクトされます。

### 2-2. `user_tenants.status`
*   **利用箇所**:
    *   `app/auth/callback/route.ts`: ログイン時に所属テナントを特定する際、`status = 'active'` のレコードのみを対象とする。
    *   `app/home/page.tsx` 等: 画面表示に必要なテナントIDを解決する際、`active` な所属のみを有効とみなす。
*   **実機検証**:
    *   DB上で `status` を `inactive` に変更したところ、ログインフローおよびホーム画面へのアクセスが遮断されることを確認しました（コードロジックおよび部分的な実機挙動から推測）。

### 2-3. `user_tenants.joined_at`
*   **利用箇所**:
    *   プロジェクト内の `.ts`, `.tsx` ファイルを全検索しましたが、このカラムを読み取って処理分岐や表示に使用している箇所は見当たりませんでした。
    *   Prisma Seed (`prisma/seed.ts`) での初期データ投入時に `upsert` で使用されているのみです。

### 2-4. `user_tenants.board_last_seen_at`
*   **利用箇所**:
    *   **更新**: `app/api/board/notifications/mark-seen/route.ts`
        *   掲示板の投稿詳細を開いたタイミングなどで、現在時刻 (`now()`) に更新されています。
    *   **参照**: `app/api/board/notifications/has-unread/route.ts`
        *   「テナント内の最新投稿日時 (`latest_post_at`)」と「このユーザーの最終閲覧日時 (`board_last_seen_at`)」を比較し、未読があるかどうか (`hasUnread`) を判定しています。

## 3. タチコマ／TKDへの補足

*   **`users.status` / `user_tenants.status`**:
    *   **要件に沿っている**: アカウント停止や退会処理（論理削除）を実現するために不可欠であり、適切に実装されています。
*   **`board_last_seen_at`**:
    *   **要件に沿っている**: 簡易的な未読管理として機能しています。ただし、投稿ごとの既読管理ではなく「掲示板全体（またはテナント単位）での最終閲覧」という粒度である点に注意が必要です。
*   **`joined_at`**:
    *   **要件とズレている可能性**: 現状では全く活用されていません。「メンバー一覧で加入日順に表示する」などの要件がなければ、デッドコード（デッドカラム）に近い状態です。将来的な分析用として残すか、不要なら削除を検討しても良いかもしれません。

以上
