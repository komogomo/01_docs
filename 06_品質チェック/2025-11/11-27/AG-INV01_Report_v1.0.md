# AG-INV01 調査報告書: テナントID／掲示板カテゴリ動作検証

## 1. 概要
**結論: 正常 (OK)**

ログインから掲示板投稿に至る一連のフローにおいて、**テナントIDは正しく引き継がれ、サーバーサイドでも厳格に検証されている**ことを確認しました。
特に、URLやAPIパラメータでテナントIDを改ざんしても、サーバー側で `user_tenants` テーブルに基づいた所属チェックが行われており、他テナントのデータ参照や不正投稿はブロックされる安全な設計となっています。
また、掲示板カテゴリもDBマスタ (`board_categories`) と正しく連動しており、投稿データも適切な `tenant_id` と `category_id` で保存されています。

## 2. 詳細調査結果

### 2-1. ログイン〜Home 画面
*   **操作**: `admin@gmail.com` でログインし、Home画面へ遷移。
*   **観測結果**:
    *   ログイン後のセッション（JWT）には `tenant_id` は含まれていませんが、アプリケーションは `user_tenants` テーブルを参照して正しいテナントID (`ab3d5d5f...`) を特定しています。
    *   Home画面の表示要素は、特定されたテナントIDに基づいてフィルタリングされています。

### 2-2. Home → 掲示板遷移と改ざん検知
*   **操作**:
    *   正規のテナントIDでのAPIアクセス: `/api/board/posts?tenantId=ab3d5d5f...`
    *   不正なテナントIDでのAPIアクセス: `/api/board/posts?tenantId=fake-tenant-id`
*   **観測結果**:
    *   **正規ID**: ステータス `200 OK`。投稿リストが返却される。
    *   **不正ID**: ステータス `403 Forbidden`。エラーコード `unauthorized` が返却される。
*   **評価**: サーバーサイド (`app/api/board/posts/route.ts`) で `user_tenants` テーブルを用いた所属チェックが機能しており、パラメータ改ざんに対して堅牢です。

### 2-3. 掲示板カテゴリ／グループ／お気に入り
*   **操作**: 掲示板TOP画面でのカテゴリ表示確認。
*   **観測結果**:
    *   画面上のカテゴリ「重要なお知らせ」等は、DBの `board_categories` テーブルから取得されたデータに基づいています。
    *   ソースコード (`BoardTopPage.tsx`) 上で `CATEGORY_TAGS` 定数が定義されていますが、これはラベル（多言語対応キー）のマッピング用であり、実際のカテゴリ選択肢はサーバーから取得した `categories` データと照合されています。

### 2-4. 掲示板投稿／返信時の保存内容
*   **操作**:
    *   ブラウザから新規投稿を作成（タイトル: "Confirmed Test Post", カテゴリ: "重要なお知らせ"）。
    *   確認モーダルを経て投稿を完了。
*   **DB確認結果**:
    *   `board_posts` テーブルの該当レコードを確認。
    *   `tenant_id`: `ab3d5d5f-027b-4108-b6aa-2a31941d88eb` (ログインユーザーの所属テナントと一致)
    *   `category_id`: `e49214af-f16f-4935-8c2b-fd037ae6795f`
    *   `board_categories` テーブル照合: 上記 `category_id` は `category_key = 'important'` (`tenant_id` = `ab3d5d5f...`) のレコードと一致。
*   **評価**: フロントエンドで選択したカテゴリが、正しいテナントコンテキストの下で適切な外部キーとして保存されています。

## 3. 気づいたリスク・改善提案

*   **現状のリスクは低い**: 今回の調査範囲において、セキュリティやデータ整合性に関する重大なリスクは見当たりませんでした。
*   **改善提案 (Minor)**:
    *   `BoardPostForm.tsx` 内で `ATTACHMENT_SETTINGS` がハードコード (`BOARD_ATTACHMENT_DEFAULTS`) されています。TODOコメントにもある通り、将来的に `tenant_settings` から動的に取得するように改修することで、テナントごとの柔軟な設定が可能になります。
    *   JWTに `tenant_id` が含まれていないため、すべてのリクエストで `user_tenants` を検索するオーバーヘッドがあります（現状は許容範囲ですが、将来的なパフォーマンスチューニングのポイントになり得ます）。

以上
