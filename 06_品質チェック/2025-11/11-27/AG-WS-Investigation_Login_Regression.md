# ログイン挙動変化に関する調査報告書

**作成日:** 2025年11月27日
**作成者:** Antigravity

## 1. 過去の「未登録メールエラー」発生源の特定

### Facts (事実)
*   **フロントエンド実装 (`MagicLinkForm.tsx`):**
    *   バックアップ (`D:\Projects\HarmoNet.bk\...\MagicLinkForm.tsx`) と現行ファイルは、**完全に同一**でした。
    *   どちらも `supabase.auth.signInWithOtp` を直接呼び出しており、独自の事前チェックロジック（`users` テーブル参照など）は実装されていませんでした。
    *   `shouldCreateUser: false` オプションが指定されています。
*   **エラー発生源:**
    *   コードが同一であるため、以前表示されていたエラーは、`signInWithOtp` 関数の戻り値（`error` オブジェクト）に由来するものです。
    *   つまり、**Supabase Auth API が「ユーザーが見つかりません」というエラーを返していた**ことが確定します。

## 2. 「以前」と「現在」の差分の事実列挙

### Facts (事実)
HarmoNet側で行われた変更（バックアップと現行の比較）は以下の通りです。

1.  **`package.json` (ライブラリバージョン):**
    *   **差分なし**。`@supabase/supabase-js` は `^2.79.0` で同一です。
2.  **`prisma/schema.prisma` (DBスキーマ):**
    *   **差分あり**。現行では `user_profiles` モデル（テーブル）が削除されています。
    *   `users` モデル等は同一です。
3.  **`src/lib/supabaseClient.ts` (クライアント初期化):**
    *   **差分なし**。初期化オプションに変更はありません。

### Hypotheses (推論)
*   **`user_profiles` 削除の影響:**
    *   `signInWithOtp` (with `shouldCreateUser: false`) は、未登録メールアドレスの場合、DBへの書き込み（INSERT）を行わず、単にユーザー検索を行います。
    *   したがって、DBトリガー（`handle_new_auth_user` 等）は発火しません。
    *   このため、`user_profiles` テーブルの削除が、未登録メールアドレスに対する `signInWithOtp` の挙動（エラーか成功か）に直接影響を与えた可能性は **極めて低い** と考えられます。

## 3. 今回の「バックアップ調査」結果の修正

### 修正内容
以前の報告で「Supabaseの仕様変更や設定変更が原因」と述べましたが、Supabaseコンテナがアップデートされていないという事実に基づき、以下の通り訂正・整理します。

*   **分かったこと（事実）:**
    *   アプリケーションコード（フロントエンド、ライブラリ）には、挙動を変えるような変更は行われていない。
    *   以前は Supabase Auth がエラーを返していたが、現在は成功（ダミー成功）を返している。
*   **分からなかったこと（原因）:**
    *   Supabaseコンテナが同一であるにもかかわらず、なぜ Supabase Auth の応答挙動（User Enumeration Protection の状態）が変化したのか、その具体的なトリガー（設定ファイルの再読み込み、環境変数の反映タイミング、あるいは予期せぬ内部状態の変化など）については、アプリケーション側の調査からは特定できませんでした。

## 4. 結論

*   **原因:** HarmoNet側のコード変更（`user_profiles` 削除含む）が、この挙動変化の直接的な原因であるという証拠は見つかりませんでした。
*   **対策:** 原因が何であれ（Supabase側の挙動がどう変わろうとも）、アプリケーションとして「未登録メールアドレスを弾く」という要件を満たすためには、今回実装した **「明示的な事前チェック（`/api/auth/check-email`）」** が必要不可欠かつ最も堅牢な解決策となります。

以上
