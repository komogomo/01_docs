# HarmoNet 通知バッジ不具合 レポート（2025-11-26）

## 1. 概要

- **現象**  
  ヘッダーの通知バッジ（ベルアイコン横の赤バッジ）が、掲示板詳細画面で管理組合からの新規投稿を閲覧しても消灯しない。
- **対象画面**  
  - HOME 画面ヘッダー
  - 掲示板 TOP（/board）
  - 掲示板詳細（/board/[postId]）
- **対象ユーザー**  
  - 管理組合: `admin@gmail.com`（tenant_admin）
  - 一般利用者: `user01@gmail.com`（general_user）

---

## 2. 本来の仕様

- 通知バッジは、**管理組合（tenant_admin）が新規投稿した掲示板記事**についてのみ点灯する。
- **掲示板 TOP（/board）に来ただけでは既読にしない。**
- **管理組合の新規投稿の「掲示板詳細画面（/board/[postId]）」にアクセスした時点で既読とし、通知バッジを消灯する。**

---

## 3. 原因

### 3.1 既読タイムスタンプの扱い

- 既読更新 API: `POST /api/board/notifications/mark-seen`
- 未読判定 API: `GET /api/board/notifications/has-unread`

**当初の実装**

1. `mark-seen` 側
   - `user_tenants.board_last_seen_at` に **対象投稿の `created_at`** を書き込んでいた。

2. `has-unread` 側
   - Supabase の `from('user_tenants')` 結果に含まれる `board_last_seen_at`（文字列）を `new Date(...)` でパースして使用していた。
   - `mark-seen` が Prisma 経由で DB を更新している一方で、`has-unread` は Supabase 経由の値を見ており、
     **「書く場所」と「読む場所」が揃っていない状態** となっていた。

**結果として**

- DB では `board_last_seen_at` が更新されていても、`has-unread` 側で古い値／不正な値を参照し続け、
  `latestPostAt > boardLastSeenAt` が常に true となり、`{"hasUnread": true}` が返り続けていた。

---

## 4. 修正内容

### 4.1 既読更新 API（mark-seen）の修正

**ファイル**: `app/api/board/notifications/mark-seen/route.ts`

- 条件: 以下をすべて満たす場合のみ既読更新
  - 対象投稿が `status = 'published'`
  - 投稿者が同一テナントの `tenant_admin` ロールを持つユーザ
- 変更点:
  - 既読タイムスタンプを **投稿の `created_at` ではなく、詳細画面にアクセスした時点の `now`** に変更。
  - 既存の `board_last_seen_at` が存在する場合は、`max(既存値, now)` を取る。

> 意味: 「この時刻以降に作成された管理組合投稿だけが未読」とみなし、詳細閲覧時点までの投稿はすべて既読になる。

### 4.2 未読判定 API（has-unread）の修正

**ファイル**: `app/api/board/notifications/has-unread/route.ts`

- Supabase での処理:
  - `users` テーブルから `appUser.id` を取得。
  - `user_tenants` から `tenant_id` のみ取得（`board_last_seen_at` は取得しない）。
- Prisma での処理:
  - `prisma.user_tenants.findUnique` を用いて、`board_last_seen_at` を **DB から直接取得**。
- 未読判定ロジック:

```ts
const hasUnread = !boardLastSeenAt
  ? true
  : latestPostAt.getTime() > boardLastSeenAt.getTime();
```

- `latestPostAt`: テナント内の「管理組合（tenant_admin）による `published` 投稿」の最大 `created_at`。
- `board_last_seen_at` が `null` の場合は常に未読あり（初回ログインなど）。

---

## 5. 動作確認結果

### 5.1 テスト前提

- 掲示板投稿をすべて削除し、クリーンな状態から開始。
- テナントは 1 つ、ユーザは主に以下を使用。
  - `admin@gmail.com`（tenant_admin）
  - `user01@gmail.com`（general_user）

### 5.2 シナリオ1: admin 自身での確認

1. admin でログインし、掲示板カテゴリ「重要なお知らせ」で新規投稿（`published`）を 1 件作成。
2. 投稿作成後、HOME 画面のヘッダベルにバッジが点灯。
3. admin が自分の新規投稿の詳細画面（/board/[postId]）を開く。
4. 詳細画面アクセス後、HOME に戻ると、`GET /api/board/notifications/has-unread` が `{"hasUnread": false}` を返却し、
   ベルバッジも消灯することを確認。

### 5.3 シナリオ2: user01（一般利用者）での確認

1. admin で新規投稿（管理組合投稿）を 1 件作成。
2. user01 でログインし、HOME を表示。
   - `GET /api/board/notifications/has-unread` → `{"hasUnread": true}`
   - ヘッダベルにバッジが点灯。
3. user01 が掲示板 TOP（/board）へ遷移。
   - この時点では `mark-seen` は呼ばれず、`hasUnread` は引き続き true。
4. user01 が対象投稿の **掲示板詳細画面（/board/[postId]）** を開く。
   - `POST /api/board/notifications/mark-seen` が 200 / `{"ok": true}` を返却。
   - `user_tenants.board_last_seen_at` が `now`（アクセス時刻）に更新される。
5. user01 が HOME に戻る。
   - `GET /api/board/notifications/has-unread` → `{"hasUnread": false}`
   - ヘッダベルのバッジが消灯することを確認。

---

## 6. 結論

- 不具合の本質的な原因は、
  1. 既読時刻として `post.created_at` を使用していた点（仕様とのズレ）、
  2. 既読更新（Prisma）と未読判定（Supabase）の参照経路が異なり、**同じ `board_last_seen_at` を見ていなかったこと**、
  の 2 点にあった。
- 既読更新と未読判定の両方で、`user_tenants.board_last_seen_at` を Prisma 経由で一貫して扱うように修正し、
  既読タイムスタンプを `now` ベースに変更したことで、
  **「管理組合の新規投稿の詳細画面にアクセスした瞬間に通知バッジが消灯する」** という仕様どおりの動作を達成した。

以上。
