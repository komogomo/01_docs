# 2025-11-24 掲示板投稿画面 & AIモデレーション 実装レポート

## 1. 全体サマリ

### 目的
掲示板新規投稿機能において、WS 指示書どおりの UI と AI モデレーション仕様（mask / block）を実装し、危険・不適切な投稿を伏字化またはブロックできるようにすること。

### 成果
- 掲示板新規投稿画面 (`BoardPostForm`) を実装し、
  - 投稿者種別
  - 表示名ルール
  - カテゴリ選択
  - タイトル / 本文 / 添付ファイル
  の UI とバリデーションを構築。
- `/api/board/posts` に AI モデレーション（OpenAI + ローカル NG ワード）ロジックを実装し、
  - allow / mask / block の判定
  - マスク時の伏字テキスト返却
  - 伏字済み内容での再投稿フロー
  を実現。
- `tenant_settings.config_json` のパースおよび Supabase RLS 設定の問題を解消し、
  - テナントごとのモデレーションレベル (`level=0/1/2`) が正しく反映されるように改善。
- NG ワードを含む投稿で、実際に
  - マスク警告 + 伏字表示 + 「伏字済みの内容で投稿」ボタン
  が動作することを手動確認済み。

---

## 2. 掲示板投稿画面 (BoardPostForm / board/new)

### 2-1. 関連ファイル
- `app/board/new/page.tsx`
  - Next.js App Router の Server Component。
  - Supabase 経由でログインユーザー、テナント所属情報、掲示板カテゴリ一覧を取得し、`BoardPostForm` に渡す。
- `src/components/board/BoardPostForm/BoardPostForm.tsx`
  - 掲示板新規投稿画面のメイン UI コンポーネント（Client Component）。
  - 入力フォーム、バリデーション、添付ファイル UI、送信フロー、AI モデレーション結果の UI まで担当。
- `src/components/board/BoardPostForm/__tests__/BoardPostForm.test.tsx`
  - 上記フォームのユニットテスト（Jest + React Testing Library）。

### 2-2. 画面構成・入力項目

- 投稿者の種別 (posterType)
  - ラジオボタンで「管理委員会として投稿」「一般住民として投稿」を切り替え。
  - viewerRole に応じて選択肢を制御（管理者でない場合、管理委員会投稿は選べない等）。

- 表示名 (displayNameMode)
  - 管理委員会投稿:
    - 表示名はシステム固定の管理委員会名を使用し、ユーザーが変更できないように制御。
  - 一般住民投稿:
    - 匿名 / ニックネーム等の表示名モードを選択可能。
    - 指示書ルールに従い、不正な組み合わせの場合はエラーメッセージを表示。

- カテゴリ選択
  - `board_categories` から取得したカテゴリをプルダウン表示。
  - viewerRole と posterType に応じて選択可能なカテゴリをフィルタリング。
  - サーバー側でも、指定外カテゴリを弾くため `invalid_category` エラーを返す実装に合わせている。

- タイトル / 本文
  - いずれも必須入力。
  - 未入力・空白のみの場合は i18n メッセージを用いたエラー表示。
  - 本文は複数行テキストエリア。

- 添付ファイル
  - ファイル選択ボタンと、PDF / その他ファイルの扱いに関する注意書きを表示（i18n キー `board.postForm.note.attachmentAllowed` 等）。
  - サイズや拡張子の基本的なチェックを実装。

### 2-3. バリデーションとエラー表示

- クライアントサイドバリデーション
  - posterType / displayNameMode の組み合わせ、カテゴリ選択、タイトル / 本文の必須チェックを実装。
  - エラーはフィールド周辺またはフォーム上部に i18n メッセージで表示。

- サーバーエラーの扱い
  - `/api/board/posts` からのエラーコードに応じて UI を分岐:
    - `auth_error` / `unauthorized` → 認証・権限エラー文言。
    - `invalid_category` → カテゴリ選択エラー。
    - `ai_moderation_masked` → モデレーション警告 + 伏字表示 + 再投稿ボタン。
    - `ai_moderation_blocked` → ブロック警告のみ。
    - その他 → 一般的なサーバーエラーメッセージ。

### 2-4. 送信フロー

- 通常送信
  - フォーム入力値を `/api/board/posts` に POST。
  - 成功時は投稿完了メッセージ表示や一覧画面遷移など、既存仕様に準拠。

- AI モデレーション連携
  - 1回目送信: サーバー側で AI モデレーション実行。
    - `ai_moderation_masked` の場合:
      - サーバーから返却された `maskedTitle` / `maskedContent` をフォームに反映。
      - 画面上部に「不適切な表現を含む可能性」の警告を表示。
      - 「伏字済みの内容で投稿する」ボタンを表示。
    - `ai_moderation_blocked` の場合:
      - 警告表示のみで、投稿は行われない。
  - 2回目送信（伏字で投稿）:
    - `forceMasked: true` を付与して `/api/board/posts` に再送。
    - 正常登録されれば通常フローに合流。

### 2-5. テスト観点

- レンダリングテスト
  - ロールや posterType に応じて表示される項目・カテゴリが変わることを確認。

- バリデーションテスト
  - 必須項目未入力時に適切なエラーメッセージが表示されること。

- 送信フローテスト
  - 正常系で `/api/board/posts` が1回だけ呼ばれ、成功レスポンスを処理できること。
  - `ai_moderation_masked` の場合に、警告 + 伏字表示 + 再投稿ボタンが出ること。
  - 再投稿ボタン押下で `forceMasked: true` が付いたリクエストが送信されること。
  - `ai_moderation_blocked` の場合に投稿されないこと。

---

## 3. サーバー側 AI モデレーション実装

### 3-1. モデレーションサービス

**ファイル:** `src/server/services/moderationService.ts`

- OpenAI モデレーション API 呼び出し (`callOpenAiModeration`) を実装。
- `decideModeration` で OpenAI 結果 + テナント設定 (`level`) から `allow` / `mask` / `block` を判定。
  - スコア閾値だけでなく OpenAI の `flagged` ブール値も使用。
- `maskSensitiveText` を実装し、強い NG ワード（例: 「死ね」「殺す」「SEX」など）を正規表現で検出して伏字化。
- モデレーション結果を `moderation_logs` テーブルに保存する `saveModerationLog` を利用。

### 3-2. 掲示板投稿 API ルート

**ファイル:** `app/api/board/posts/route.ts`

1. リクエスト DTO 拡張

- `UpsertBoardPostRequest` に `forceMasked?: boolean` を追加。
- マスク後の再投稿時に `true` を送ることで、伏字済み内容の登録を許可。

2. テナント設定 `config_json` のパース強化

- 実際のデータ構造:

  ```json
  {"board":{"moderation":{"level":1,"enabled":true}}}
  ```

- 以下のケースをすべて吸収できるようにパースロジックを実装:
  - `config_json` が JSON 文字列 / JSON 型どちらでもOK。
  - `config.board` がオブジェクト / JSON 文字列どちらでもOK。
  - `board.moderation` がオブジェクト / JSON 文字列どちらでもOK。
  - `moderation.level` が `"1"` / `"2"` の文字列、または `1` / `2` の数値どちらでもOK。
- 最終的に `normalizedLevel` を `0 | 1 | 2` に正規化し、`TenantModerationConfig` に格納。

3. ローカル NG ワードとの組み合わせ

- OpenAI モデレーションの結果 (`baseDecision`) に加え、`maskSensitiveText` によるローカル NG ワード検知を実施。
- `hasLocalSensitive === true` の場合、テナント設定 `level` に応じて最終判定を上書き:
  - `level=1` → 強制 `mask`
  - `level=2` → 強制 `block`

4. マスク / ブロック時のレスポンス

- `decision === 'block'` の場合:
  - モデレーションログを書き出し、`400` + `errorCode: 'ai_moderation_blocked'` を返却。

- `decision === 'mask' && !forceMasked` の場合:
  - `title` / `content` を `maskSensitiveText` で伏字化し、`maskedTitle` / `maskedContent` として返却。
  - `400` + `errorCode: 'ai_moderation_masked'` を返却し、フロントで再投稿フローを促す。

- `decision === 'mask' && forceMasked === true` の場合:
  - 伏字済みテキストを `effectiveTitle` / `effectiveContent` として DB 登録。
  - 正常系として `201` + `postId` を返却。

5. ログ出力

- OpenAI モデレーション成功時: `moderation.openai.success`。
- 判定結果ログ: `board.post.moderation_decision` に
  - `level`, `enabled`, `hasLocalSensitive`, `baseDecision`, `finalDecision`, `aiScore`, `flaggedReason`
  を出力。
- 一時的に `board.post.moderation_config_debug` ログで `config_json` 構造を出力し、問題特定後に削除済み。

---

## 4. RLS (Row Level Security) による問題と解消

### 4-1. 発生していた問題

- NG ワードを含む投稿でも、`board.post.moderation_decision` のログ上で
  - `level: 0`
  - `finalDecision: "allow"`
  となり、投稿がそのまま登録されていた。
- 詳細ログ (`board.post.moderation_config_debug`) を追加したところ、
  - `rawConfigValueType: "undefined"`
  - `boardSectionType: "undefined"`
  となり、Supabase 経由の `select('config_json')` では `tenant_settings` の行が 0 件扱いになっていることが判明。

### 4-2. 原因

- Supabase の `tenant_settings` テーブルで RLS が有効になっており、
  - `authenticated` ロール向けの SELECT ポリシーが不十分だった。
- その結果、SQL エディタ（オーナー権限）では `config_json` が見えるが、
  アプリからのクエリでは `data: []` となり、`level` が常に 0 扱いになっていた。

### 4-3. 対応

- `tenant_settings` に対して、認証済みユーザー（もしくはテナント所属ユーザー）が SELECT できるようポリシーを緩和。
- ポリシー調整後、再度ログを確認したところ、
  - `rawConfigValueType: "object" or "string"`
  - `normalizedLevel: 1`
  となり、
  `board.post.moderation_decision` も `level: 1`, `finalDecision: "mask"` へと変化。

---

## 5. 動作確認結果

- テナント設定: `{"board":{"moderation":{"level":1,"enabled":true}}}` を設定した状態で、
  - 「死ね」「殺す」などの NG ワードを含む投稿を行うと、
    - 初回送信時: マスク警告 + タイトル / 本文の伏字表示 + 「伏字済みの内容で投稿」ボタン。
    - 再送信時: 伏字済みテキストで正常登録されることを確認。
- モデレーション関連ログ:
  - `moderation.openai.success` が出力されていること。
  - `board.post.moderation_decision` で
    - `level: 1`
    - `hasLocalSensitive: true`
    - `finalDecision: "mask"`
    が出力されていることを確認。
- UI:
  - 中国語 UI においても、モデレーション警告メッセージと伏字表示が正しく表示されることをスクリーンショットで確認。

---

## 6. 残課題・今後の改善アイデア

- NG ワード辞書の拡張・テナント別カスタマイズ。
- 管理画面から `board.moderation.level` / `enabled` を編集できる設定 UI の追加。
- `moderation_logs` をもとにしたモデレーションレビュー画面（人手チェック用）の実装検討。

以上。
