# Windsurf 作業指示書: 施設予約機能 実装修正 (WS-FB02)

**Document ID**: WS-FB02_FixFacilityBooking_v1.0
**Date**: 2025-12-02
**Target**: Windsurf (AI Agent)
**Priority**: High (Recovery)

## 1. 概要
前回の実装（WS-FB01）において、設計意図と大きく異なる実装が行われたため、緊急修正を行う。
特に「駐車場予約画面 (FB-03)」の品質が著しく低く、ユーザから強いクレームが発生している。
本指示書に基づき、**モックアップ v1.3 と同じレイアウト・UX** へ作り直すこと。
スタイル（色・角丸・影など）は **HarmoNet UI Design Guide v1.1** を唯一の基準とすること。

## 2. 修正対象と原因分析

### 2.1 駐車場予約画面 (FB-03) の不備
*   **配置図欠落**: 設計書で指示した「参照画像＋グリッド」が実装されず、ただのリストになっている。
*   **入力項目間違い**: 「参加人数」「備品」など、集会所用の項目が駐車場画面に表示されている（コピーミス）。
*   **デザイン品質**: `rounded-2xl` が過剰適用され、幼稚な見た目になっている。
*   **データ不備**: 本来「無料」または「100円/回」であるべき料金が「300円/時間」などと表示されている。

### 2.2 共通UIの不備
*   **過度な角丸**: UIガイドの `rounded-2xl` はあくまで「親しみやすさ」の指針であり、全ての要素に適用するとバランスが崩れる。`rounded-lg` 程度に抑えること。

## 3. 修正指示 (Action Items)

### 3.1 デザイン方針 (Design Strategy)
*   **レイアウト・挙動**: **モックアップ (v1.3)** に忠実に従うこと。
*   **スタイル (配色・形状)**: **HarmoNet UI Design Guide (v1.1)** の定義を厳守する。
    *   **カード**: `rounded-lg`, `border-2`, `border-gray-200`, `shadow-sm`
    *   **ボタン/入力**: `rounded-md`, `border-2` (Primary: `bg-blue-600`, Secondary: `border-blue-200`)
    *   ※「なんとなく」でスタイルを決めず、ガイドに記載されたクラス名をそのまま使用すること。

### 3.2 駐車場予約画面 (FB-03) の再実装
**参照**: `D:\AIDriven\01_docs\04_詳細設計\05_施設予約画面\facility-booking-detail-design-fb03.md` (更新済み)

1.  **配置図の表示**:
    *   `facilities.image_url` が指定されていればそれを使用する。
    *   もしくは `facilities.meta.parkingMapImageUrl` に保存された画像URLがあればそれを使用する（本機能専用キー）。
    *   画像はテナントごとに異なるため、ハードコードせずDBから取得すること。
2.  **区画選択グリッド**:
    *   `facility_slots` テーブルから取得したレコード数分だけボタンを生成する。
    *   **重要**: 「全8区画」などと決め打ちしないこと。テナントによって区画数は増減する。
    *   **状態色（ボタンカード共通）**:
        *   **空き（未選択）**: グレー系カード（`bg-white border-gray-300 text-gray-800`）
        *   **選択中（アクティブ）**: 青系カード（`bg-blue-600 border-blue-600 text-white`）
        *   **予約済**: グレーアウト（`bg-gray-100 border-gray-200 text-gray-400`）
    *   **凡例**: グリッドの下に「空き」「予約済」「選択中」の凡例を表示する。
3.  **入力フォームの適正化**:
    *   **削除**: 「参加人数」「備品利用」
    *   **維持**: 「利用目的」（必須）、「車両情報」（任意）
4.  **料金・ルール表示**:
    *   **重要**: 画面上部の「施設備考」エリアには、`facilities.description` の内容をそのまま表示すること。
    *   ※「100円/回」「最大10回/月」などのルールはテナントごとに異なるため、ハードコードされたテキストを表示してはならない。

### 3.3 施設予約TOP画面 (FB-01) の再実装
**参照**: `D:\AIDriven\01_docs\04_詳細設計\05_施設予約画面\facility-booking-detail-design-fb01.md` (更新済み)

1.  **レイアウト刷新**:
    *   既存の「施設カード一覧 (FacilityList)」は**全削除**する。
    *   モックアップ通り、**「施設選択ドロップダウン」＋「施設情報カード」＋「カレンダー」** の構成に作り直す。
2.  **カレンダー実装**:
    *   TOP画面内に月カレンダー (`CalendarView`) を配置する。
    *   **モバイルファースト**: スマホでの操作を最優先する。
        *   **幅**: 画面幅いっぱい (`w-full`) に表示。
        *   **タップ領域**: 日付セルは指で押しやすいサイズ（最低 44x44px）を確保する。
        *   **スタイル**: デスクトップ用の小さなウィジェットではなく、モックアップのような大きく見やすいカレンダーとする。
    *   日付をクリックすると、その日付の予約フォームへ遷移する。
3.  **状態管理**:
    *   ドロップダウンで施設を切り替えると、下の情報カードとカレンダーが連動して更新されるようにする。

### 3.4 予約確認画面 (FB-04) の修正
*   駐車場予約の場合、確認画面にも「参加人数」「備品」を表示しないこと。
*   「注意事項」エリアを、モックアップ（黄色い背景のカード等）のように目立たせ、同意チェックボックスを配置する。

### 3.5 データモデル拡張とバリデーション (Schema & Logic)
1.  **スキーマ拡張**: (Antigravityにより実施済み)
    *   `facility_settings` テーブルに `cancel_restriction_days` (Int, default: 1) を追加済み。
    *   ※Windsurfはマイグレーションを実行せず、このカラムが存在する前提で実装を進めること。
2.  **ダブルブッキング防止 (Critical)**:
    *   予約作成API (`POST /api/facilities/reservations`) にて、**厳密な重複チェック**を実装する。
    *   `start_at` / `end_at` の範囲が、既存の有効な予約と1ミリ秒でも重なればエラーとする。
3.  **キャンセル制限**:
    *   予約キャンセルAPIにて、`cancel_restriction_days` を確認し、期限を過ぎている場合はエラーとする。

### 3.6 ログ出力 (Logging)
*   **共通ロガーの利用必須**: `console.log` や `console.error` の直接使用は禁止する。
*   **利用モジュール**: `src/lib/logging/log.util.ts`
    *   `import { logInfo, logError } from "@/src/lib/logging/log.util";`
*   **出力方針**:
    *   APIのエラーハンドリング時には必ず `logError` を呼び出し、エラー内容とコンテキスト（テナントID、ユーザーID等）を記録すること。
    *   正常終了時や重要な分岐点では `logInfo` を使用すること。

## 4. 作業手順
1.  **DBバックアップ**: `pg_dump` 等で現状のデータを保存。（※人間オペレーション。Windsurf はコマンドを自動実行しない）
2.  **スキーマ変更**: Antigravity により完了済み。Windsurf は `cancel_restriction_days` カラムが既に存在する前提で実装のみ行う。
3.  **デザイン修正**: `globals.css` やコンポーネントのクラスを調整。
4.  **FB-03再実装**: `ParkingSlotSelector.tsx` を動的データ駆動で作り直す。
5.  **ロジック実装**: APIに重複チェックとキャンセル制限を追加。
6.  **動作確認**: モックアップ通りの見た目・挙動になっているか確認する。

## 5. 完了報告
*   修正後の画面スクリーンショットを撮影し、レポートに添付すること。
*   出力先: `D:\AIDriven\01_docs\06_品質チェック\Report_WS-FB02_Recovery.md`

以上
