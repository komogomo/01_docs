# AG-INV02 ユーザ / テナント所属ステータス利用状況調査指示書 v1.0

## 1. 目的

`users` / `user_tenants` 周りの以下カラムについて、

* `users.status`
* `user_tenants.status`
* `user_tenants.joined_at`
* `user_tenants.board_last_seen_at`

が **実際のコードとランタイムで「どこで」「何のために」使われているか** を、
ブラウザ実機＋ログ＋コード参照の組み合わせで調査する。

この結果をもとに、

* 「要件に沿った正しい意味を定義して残す」か、
* 「意味がない／要件とズレているので削除＋コード側も整理」するか

を決めるための材料とする。

---

## 2. 調査対象テーブル・カラム

### 2.1 users テーブル

* `users.status`

### 2.2 user_tenants テーブル

* `user_tenants.status`
* `user_tenants.joined_at`
* `user_tenants.board_last_seen_at`

---

## 3. 調査観点

### 3.1 コード上の利用箇所調査

以下のいずれか／すべてを用いて、プロジェクト内での利用箇所を洗い出してください。

* Prisma クエリ (`prisma.user_tenants.findMany` 等) における `status` / `joined_at` / `board_last_seen_at` の参照
* Supabase SQL / RLS ポリシーでの参照
* API Route / Server Action / Repository 層での参照

最低限、次の点を確認してレポートしてください。

1. `user_tenants.status`

   * どのクエリで `status = 'active'` 条件を使っているか
   * `active` 以外の値（`inactive` 等）を実際にセットしているコードが存在するか
   * 「退去」の扱いを `status` で表現している箇所があるか

2. `users.status`

   * どこかで `status = 'active'` などを条件にログイン可否や表示可否を判定しているか
   * 値を更新しているコード（`update` / `upsert`）が存在するか

3. `joined_at`

   * 表示・ソート・フィルタ条件などに利用している箇所があるか
   * 更新しているコードがあるか（初期登録以外で書き換えているか）

4. `board_last_seen_at`

   * BoardTop / HOME の通知バッジ・未読管理などで利用しているか
   * どのタイミングで更新しているか（BoardTop表示時／詳細表示時 等）

> 重要: 「grep でヒットしない＝未使用」とは限らないので、Prisma スキーマと SQL、RLS ポリシーも含めて確認してください。

---

### 3.2 実機動作（ブラウザ）での確認

コードだけでは意図が読み取りにくい部分については、
ブラウザ操作＋DevTools＋ログを組み合わせて調査してください。

特に次を確認してください。

1. ログイン〜Home〜掲示板の一連の操作で、

   * `user_tenants.status` が `'active'` 以外の場合にどう振る舞う想定か

     * もしテスト用に `inactive` 等へ書き換え可能なら、その状態で挙動を確認（可能な範囲で）。

2. BoardTop / HOME の通知バッジ（未読／新着）に関連して、

   * `board_last_seen_at` が更新されているログ／SQL が存在するか

> もし DB を直接書き換えるテストが難しい場合は、可能な範囲での推測＋「実際にはこう検証したい」という案レベルで構いません。

---

## 4. レポート形式

調査完了後、以下の形式で Markdown レポートをお願いします。

1. 概要

   * 各カラムごとに、

     * 「どこで使っているか／使っていないか」
     * 「現状の使い方の意図（推測でなく、コード・挙動から読み取れる範囲）」
       を簡潔にまとめてください。

2. 詳細

   * 3.1〜3.2 の観点ごとに、

     * 対象ファイル名・関数名・コード抜粋
     * 実行したブラウザ操作と観測した挙動
     * 関連するログや SQL があれば、その内容（必要なら匿名化）

3. タチコマ／TKDへの補足

   * カラムごとに、

     * 「要件に沿っていると思う」「要件とズレている可能性が高い」
       と感じた点があれば、その理由を短くコメントしてください。

---

## 5. この調査の前提

* 今回の目的は「カラムの削除・変更方針を決めるための事実確認」です。
* 実装の修正やリファクタリングは、この調査レポートを受け取ってから別途指示します。
* 調査中に明らかなバグやセキュリティリスクを見つけた場合は、

  * レポート内にコメントとして残してもらえると助かります（ただし修正はまだ行わなくて大丈夫です）。
