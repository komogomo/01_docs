
---

# AG-INV01 テナントID／掲示板カテゴリ動作調査指示書 v1.0

## 1. 調査目的

* ログイン認証リファクタ後の「正規 tenant_id フロー」が

  * Home 画面
  * 掲示板一式（BoardTop / BoardDetail / BoardPostForm など）
    で正しく貫通しているかを、**実際のブラウザ操作ベースで**確認する。
* 掲示板カテゴリ・グループ・お気に入り等が、
  想定どおりのマスタ／フィルタ動作になっているかを確認する。
* その結果をもとに、後続の管理画面実装や設計修正の材料にする。

## 2. 調査範囲

1. ログイン〜Home の tenant_id 取り扱い
2. Home → 掲示板への遷移時の tenant_id 引き継ぎ
3. 掲示板カテゴリ／グループ／お気に入りフィルタの実際の挙動
4. 掲示板投稿・返信時の tenant_id・カテゴリ・グループの保存内容

## 3. 調査観点（やってほしいこと）

以下はすべて「ブラウザ実操作＋DevTools＋バックエンドログ」で確認してください。
コード読みだけでの推測は不要です。

### 3-1. ログイン〜Home 画面

1. ログイン直後に、ブラウザの Network / Console / Application を使って：

   * フロント側が参照している「現在の tenant_id」がどこから来ているか

     * Supabase Auth → user → `user_tenants` から決定されているか
     * `users.tenant_id` を直接信頼していないか
2. Home で参照しているデータ（ショートカットメニュー等）が、

   * すべて「その tenant_id」で絞り込まれているか
   * 別テナントのデータが混入する余地がないか

### 3-2. Home → 掲示板遷移

1. Home から掲示板 TOP（BoardTop）へ遷移したとき、

   * URL / クエリパラメータ / API リクエストのどこに tenant 情報が載っているか
   * サーバ側で **必ず `user_tenants` による所属チェック** をしているか

     * クエリの `tenantId` が改ざんされても、他テナントのデータが取れないことを確認してください。

### 3-3. 掲示板カテゴリ／グループ／お気に入り

1. 掲示板 TOP で：

   * カテゴリフィルタの一覧内容

     * どこから取得しているか（DB の `board_categories` か、ハードコードか）
     * 現状、**ラベル扱いになっていないか**（テーブル無視していないか）
   * グループフィルタ（あれば）の挙動

     * どのテーブル／カラムを基準にフィルタしているか
   * お気に入りフィルタ（☆）の挙動

     * どのテーブル／フラグで管理されているか
2. 上記フィルタを操作しながら、実際に表示される投稿一覧が

   * 想定どおりに OR / AND 条件で絞られているか
   * カテゴリ・グループ・お気に入りが複合したときに不自然な動きをしていないか

### 3-4. 掲示板投稿／返信時の保存内容

1. 掲示板に新規投稿を 2〜3 件行い、

   * 異なるカテゴリ／グループ／お気に入りフラグを使って保存
2. そのうえで DB（または Prisma / Supabase Studio）を確認し、
   各投稿について：

   * `tenant_id` に何が入っているか（ログインユーザの正しい tenant と一致するか）
   * カテゴリ／グループが

     * どのテーブルのどのカラムに保存されているか
     * 本来のマスタ構造（board_categories 等）と合っているか
   * お気に入りフラグがどこに保存されているか（ユーザ別に管理されているか）

## 4. レポート形式

調査完了後、以下の形式で Markdown レポートを返してください。

1. 概要

   * 「tenant_id フローは問題ない／ここが問題」など、結論を先頭に 5 行程度で。
2. 詳細

   * 3-1〜3-4 の観点ごとに

     * 実際にやった操作手順
     * 観測した挙動（スクリーンショットやログ抜粋があればなお良い）
     * 想定仕様とのズレがあれば、その内容
3. 気づいたリスク・改善提案

   * 仕様が曖昧／ドメインモデルとズレていると思った点
   * 今後の設計・実装で先に直しておいた方がいい箇所

以上の調査をお願いします。
