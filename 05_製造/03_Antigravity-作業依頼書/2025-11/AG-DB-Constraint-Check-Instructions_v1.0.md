# AG 作業指示書: DB 制約変更と全画面整合チェック

## 1. タスク概要

### 1.1 タスク名

DB 制約変更（PK/UNIQUE/FK/INDEX）とアプリケーション全画面の整合チェック

### 1.2 ゴール

2025-12-02 時点の DB スキーマ（`schema.prisma` および Supabase 実 DB）について、

1. 直近で変更した **PK / UNIQUE / FK / INDEX** が、HarmoNet の最新仕様（DB 基本設計・画面仕様）と矛盾していないこと
2. それらに関連する **全ての実装済み画面・API** において、主要な CRUD 操作（INSERT / UPDATE / DELETE）がエラーなく実行できること
3. もし矛盾やリスクがある場合は、その内容と「DB 側を正とすべきか / 画面仕様側を正とすべきか」を整理した提案を出すこと

をゴールとする。

---

## 2. 対象範囲

### 2.1 対象リポジトリ・環境

* リポジトリ: `D:\Projects\HarmoNet`（GitHub: `Projects-HarmoNet`）
* DB: ローカル Supabase HarmoNet 環境（最新状態）
* Prisma スキーマ: 2025-12-02 時点の `schema.prisma`
* DB 設計書: `HarmoNet-DB-Basic-Design_v2.0.md`

### 2.2 対象テーブル（例示）

※ 実際には **直近で制約を変更したすべてのテーブル** を対象とすること。

* 認証・ユーザ関連

  * `users`
  * `tenant_residents`
  * `user_tenants`
  * `user_roles`
* 掲示板関連

  * `board_posts`
  * `board_comments`
  * `board_post_translations`
  * `board_comment_translations`
  * `board_favorites`
  * `board_post_attachments`（変更があれば）
* お知らせ・既読管理

  * `announcements`
  * `announcement_reads`
* ログ・監査系

  * `audit_logs` ほか、今回制約・インデックスを見直したテーブル

### 2.3 対象画面・API

**「実装済みの全画面・全 API」** を対象とする。

特に次のカテゴリは必ず含めること。

* システム管理画面

  * システム管理者によるテナント・ユーザ・ロール管理の全フロー
* テナント管理画面

  * テナント管理者による住民登録・ユーザ登録・ロール紐付け・無効化／削除の全フロー
* 掲示板関連

  * BoardTop / BoardDetail / BoardPostForm / コメント・お気に入り / 翻訳 / 既読・承認系の全フロー
* お知らせ関連

  * お知らせ作成・更新・削除・既読管理
* 監査・ログ系（画面があれば）

---

## 3. 作業内容

### Step 1: 制約変更の一覧化

1. 直近の作業で変更した **PK / UNIQUE / FK / INDEX** をすべて洗い出すこと。
2. 可能な限り Git 履歴やバックアップ・作業メモを参照し、「変更前」と「変更後」を次の形式で一覧化する。

| table         | 種別 (PK/UNIQUE/FK/INDEX) | before               | after                         | 目的     | 想定影響 (画面/API)         |
| ------------- | ----------------------- | -------------------- | ----------------------------- | ------ | --------------------- |
| 例: user_roles | UNIQUE                  | (tenant_id, user_id) | (tenant_id, user_id, role_id) | 多ロール対応 | システム管理/テナント管理のロール付与画面 |

3. 変更前の情報が不明な場合は、`before` に「不明」と記載し、その理由を備考に書くこと。

---

### Step 2: Prisma モデルとの整合チェック

1. `schema.prisma` が Supabase 実 DB と整合しているかを確認する。

   * `npx prisma validate`
   * `npx prisma generate`

2. エラーまたは警告が発生した場合は、次を整理する。

   * どのモデル／フィールドに対するものか
   * 原因（推定でよいが、根拠も記載すること）
   * DB 側を修正すべきか / Prisma 側を修正すべきかの方針

3. 結果は表形式でまとめる。

| 種別 (validate/generate) | 対象モデル | 内容 | 対応方針 (DB修正/Prisma修正/保留) |

---

### Step 3: 制約ごとの影響画面/API の特定

1. Step 1 で洗い出した各テーブルについて、

   * どの画面 / API が **INSERT / UPDATE / DELETE** を実行しているか
   * どの Prisma モデル・サービス層ファイルが関与しているか
     を調査する。

2. 次の形式で一覧化する。

| table | 操作 (INSERT/UPDATE/DELETE) | 画面/API 名 | 関連ソースファイル (例: `src/app/...`) | 備考 |

3. ここでは **実装済みの全画面** を対象にすること。

   * 例：

     * システム管理: システム管理者用ユーザ/テナント/ロール管理画面
     * テナント管理: 住民登録・ユーザ登録・ユーザ無効化/削除・ロール設定
     * 掲示板: 投稿作成・編集・削除・コメント・お気に入り ON/OFF・翻訳保存 など
     * お知らせ: 作成・更新・削除・既読処理

---

### Step 4: 全画面での CRUD 動作確認

> ポイント: 「制約変更に関係しそうなテーブルを触る **全ての実装済み画面/API**」で、最低限の CRUD 操作を実機確認する。

1. Step 3 で特定した各画面/API について、以下の操作を実行する。

   * 新規登録 (INSERT)
   * 更新 (UPDATE)
   * 削除 または 無効化 (DELETE 相当の操作がある場合)

2. 操作時に、次の点を必ず確認し、結果を記録する。

   * PK/UNIQUE 制約違反エラーが出ないか
   * FK 制約違反エラーが出ないか
   * 想定外のカスケード削除や副作用が発生していないか
   * UI 上のエラー表示が仕様どおりになっているか（あれば）

3. 画面/API 単位で表にまとめる。

| 画面/API | 対象テーブル | 操作 | 結果 (OK/NG) | エラー内容 or 気付いたこと |

4. エラーが出た場合は、**必ず再現条件を明記** すること。

---

### Step 5: 懸念点・提案の整理

1. Step 1〜4 の結果を踏まえて、次の観点で懸念点を整理する。

   * DB 基本設計 (`HarmoNet-DB-Basic-Design_v2.0`) と実 DB/Prisma の不整合
   * 画面仕様・API 仕様と、現在の制約（PK/UNIQUE/FK）の不整合
   * 将来バグになりそうな設計（例：複合キーが弱い、または強すぎて運用上つらい 等）

2. 各懸念点について、「どちらを正とすべきか」の提案を書いてください。

   * DB 側を正として画面/API 仕様を修正した方がよいのか
   * 画面/業務仕様を優先して DB 制約を見直した方がよいのか

3. 次のような表でまとめるとよい。

| No. | 事象/懸念 | 関連テーブル/画面 | 原因の整理 | 提案 (DB優先/画面優先/別案) | メモ |

---

## 4. 成果物

1. レポート形式

   * Markdown 1ファイルで作成すること（ファイル名は TKD 指示に従う）。
   * 構成例:

     1. 概要（前提・対象・実施日）
     2. Step 1 結果（制約変更一覧）
     3. Step 2 結果（Prisma 整合チェック）
     4. Step 3 結果（影響画面/API 一覧）
     5. Step 4 結果（全画面 CRUD 動作確認）
     6. Step 5 結果（懸念点と提案）
     7. 結論と「次に実施すべきこと」

2. 観点

   * あくまで **現状の実装を壊していないか** を確認する目的。
   * 「ついでに改善したくなる箇所」があっても、実際の修正は TKD の判断待ちとし、提案レベルに留めること。

以上を本タスクの完了条件とする。
