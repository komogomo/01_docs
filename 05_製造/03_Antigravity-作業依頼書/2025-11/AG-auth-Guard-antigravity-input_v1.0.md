# Antigravity 用インプットパック（認証ガード改善タスク）

## [Task]

HarmoNet 管理者コンソール（`/t-admin` 配下）の認証・ロールチェックを整理し、
Next.js App Router / Supabase Auth / RLS 前提で「抜け漏れのない最小構成」にリファクタリングするための作業指示書（Windsurf 用 WS）を作成すること。

## [Scope]

* 対象 URL / ルート

  * `/t-admin` 配下のすべてのページ（App Router / Server Components）
  * `/t-admin` 配下で呼ばれる Route Handlers（`route.ts`）
* 対象技術要素

  * Next.js 16 App Router
  * Supabase Auth（セッション取得）
  * `user_tenants` / `user_roles` などロール判定に使用しているテーブル
  * RLS は既存方針どおり「tenant_id ベースのデータガード」として変更しない

## [Background]

* HarmoNet の要件

  * 個人サブスクは存在しない。管理組合がテナント単位で導入し、全住民が利用する団体契約モデル。
  * 監査ログ・操作履歴・行動追跡は要件外。ログは障害解析・運用確認のための最小限のみ。
* 現状の実装（Gemini レポート観点）

  * Antigravity (Gemini 3 Pro high) のレポート上、認証・ロールチェックがページや API ごとにバラバラに書かれており、

    * ある画面はサーバコンポーネント内でセッションチェック
    * 別の画面はクライアント側のフックで疑似的に制御
    * 一部ではチェック自体が弱い／見当たらないように見える
  * その結果として、「たまたま動いているが、将来の画面追加時にチェック漏れが発生しやすい」構造になっている懸念がある、という指摘が挙がっている。

## [Goal]

Antigravity には、以下を満たす Windsurf 用 WS 指示書（v1.0）を作成してほしい。

1. サーバ側の単一エントリポイント

   * `getAuthContext`（仮称）のようなサーバヘルパーを 1 箇所に定義し、

     * Supabase セッション取得
     * `user_tenants` からの `tenant_id` 決定
     * `user_roles` からロール判定（例: `isTenantAdmin`）
       をこのヘルパーに集約する方針を明記する。
   * すべての `/t-admin` のページ・Route Handler は、処理の冒頭でこのヘルパーを必ず呼び出すように指示する。

2. `/t-admin` 配下を対象にした middleware ガード

   * `middleware.ts` にて `matcher` を `/t-admin/:path*` に限定し、

     * 未ログイン → `/login` へ 302 リダイレクト
     * tenant_admin ロールでない → `/`（または既存仕様に合わせたトップページ）へ 302 リダイレクト
       を行う最小限のガードを実装させる。
   * middleware 内では重い DB アクセスや複雑な権限判定をさせないように設計する（必要に応じて Supabase Auth の軽量な判定範囲に留める）。

3. クライアント側ロジックの整理

   * クライアント側の `useAuth` 的なフックは「UI の出し分け」に限定し、

     * ボタンの表示／非表示
     * 文言の切り替え
       のみに使用させる。
   * アクセス制御（入れる／入れない）の責務は 100% サーバ側（middleware + Server Components + Route Handlers + RLS）で完結させる方針を明示する。

4. 既存コードとの整合

   * 既存の `/t-admin` 画面・API で行っているセッションチェック／ロールチェックのうち、

     * ロジックが二重になっている箇所
     * もはや不要になる `if (!session) redirect('/login')` など
       は、Windsurf による改修時に整理・削除してよいことを指示書内で明記する。
   * ただし、現時点での挙動（画面遷移・エラーメッセージ表示など）を変えないことを前提とし、「挙動が変わる可能性がある変更」は必ずコメントとともに限定的に指示する。

## [Constraints]

* 禁止事項

  * DB スキーマ（`schema.prisma`）の変更は禁止。
  * RLS ポリシーの追加・変更は禁止。
  * ディレクトリ構成の変更（フォルダ移動・ファイル名変更）は禁止。
  * 新しいロール概念やステータス（`active/inactive/archived` などサブスク想定ステータス）の追加は禁止。
  * 監査ログ・操作履歴テーブルの追加は禁止。
* 制約

  * 既存の設計書・WS 指示書に書かれている仕様を変更しないこと。
  * 今回は `/t-admin` 配下の認証・ロールチェック構造の整理に範囲を限定し、
    一般ユーザ向け画面（掲示板など）には手を入れない。

## [Non-goals]

* 今回のタスクでは、以下は明示的に「やらない」:

  * 一般ユーザ向け画面（`/board` など）のガード方式変更。
  * テナント／ユーザのライフサイクル（物理削除 vs 論理削除）の仕様変更。
  * ログ設計の見直し（監査ログの導入など）。

## [Deliverable from Antigravity]

* Windsurf 用作業指示書（例: `WS-T01_TenantAdminAuthGuard_v1.0.md`）の Markdown 一式。
* 指示書内には、少なくとも以下を含めること:

  * 対象ファイル一覧（相対パス）
  * 追加／修正が必要な関数・ヘルパーの概要
  * 既存コードからの主な変更点（差分の観点）
  * 想定されるリスクと、リスクを低減するための確認ポイント（簡易テスト観点）
