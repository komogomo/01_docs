# HarmoNet Phase 9 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹ç¯‰ä½œæ¥­å ±å‘Šæ›¸

**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå**: HarmoNetï¼ˆãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå‹ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£OSï¼‰  
**ä½œæ¥­ãƒ•ã‚§ãƒ¼ã‚º**: Phase 9 - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç’°å¢ƒæ§‹ç¯‰  
**ä½œæ¥­æ—¥**: 2025å¹´11æœˆ6æ—¥  
**ä½œæ¥­è€…**: Claude (AI Development Assistant) + TKD (Project Owner)  
**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³**: v1.0

---

## ğŸ“‹ ç›®æ¬¡

1. [ä½œæ¥­æ¦‚è¦](#ä½œæ¥­æ¦‚è¦)
2. [ä½œæ¥­ç¯„å›²](#ä½œæ¥­ç¯„å›²)
3. [å®Ÿæ–½å†…å®¹](#å®Ÿæ–½å†…å®¹)
4. [æˆæœç‰©](#æˆæœç‰©)
5. [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹æˆ](#ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹æˆ)
6. [ç™ºç”Ÿã—ãŸå•é¡Œã¨å¯¾å¿œ](#ç™ºç”Ÿã—ãŸå•é¡Œã¨å¯¾å¿œ)
7. [æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—](#æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—)
8. [ä»˜éŒ²](#ä»˜éŒ²)

---

## 1. ä½œæ¥­æ¦‚è¦

### 1.1 ç›®çš„

Phase 9ã®é–‹å§‹ã«ã‚ãŸã‚Šã€ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ã‚¯ãƒªãƒ¼ãƒ³ãªçŠ¶æ…‹ã‹ã‚‰å†æ§‹ç¯‰ã™ã‚‹ã€‚Prisma ORMã¨Supabase PostgreSQLã‚’ä½¿ç”¨ã—ã€Row Level Security (RLS)ã‚’å«ã‚€å®Œå…¨ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã‚’æ§‹ç¯‰ã™ã‚‹ã€‚

### 1.2 èƒŒæ™¯

- å‰ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆPhase 5ï¼‰ã§ä½œæˆã•ã‚ŒãŸã‚¹ã‚­ãƒ¼ãƒã‚’ãƒ™ãƒ¼ã‚¹ã«ã€Phase 9ç”¨ã«æœ€é©åŒ–
- ENUMå‹ã®å‘½åè¦å‰‡ã‚’çµ±ä¸€ï¼ˆsnake_caseï¼‰
- RLSãƒãƒªã‚·ãƒ¼ã‚’å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã«é©ç”¨ã—ã¦ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢ã‚’å®Ÿç¾

### 1.3 ä½œæ¥­ç’°å¢ƒ

| é …ç›® | è©³ç´° |
|------|------|
| OS | Windows 11 |
| ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‘ã‚¹ | `D:\Projects\HarmoNet` |
| Node.js | LTS v20.x |
| Prisma | 6.19.0 |
| Supabase CLI | 2.54.11 |
| Docker Desktop | æœ€æ–°ç‰ˆï¼ˆSupabaseã‚³ãƒ³ãƒ†ãƒŠå®Ÿè¡Œç”¨ï¼‰ |

---

## 2. ä½œæ¥­ç¯„å›²

### 2.1 å¯¾è±¡ç¯„å›²

âœ… **å®Ÿæ–½å¯¾è±¡**
- Prisma schema.prismaã®æœ€çµ‚ç‰ˆä½œæˆ
- Supabaseãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ
- Row Level Security (RLS) ãƒãƒªã‚·ãƒ¼é©ç”¨
- Seedãƒ‡ãƒ¼ã‚¿æŠ•å…¥
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ æ¤œè¨¼

âŒ **å¯¾è±¡å¤–**
- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æ§‹ç¯‰
- APIé–‹ç™º

### 2.2 å‰ææ¡ä»¶

- Docker DesktopãŒèµ·å‹•ã—ã¦ã„ã‚‹
- Supabaseãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒãŒç¨¼åƒä¸­
- Node.jsç’°å¢ƒãŒæ§‹ç¯‰æ¸ˆã¿
- å¿…è¦ãªnpmãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿

---

## 3. å®Ÿæ–½å†…å®¹

### 3.1 ä½œæ¥­ãƒ•ãƒ­ãƒ¼

```
1. schema.prismaç¢ºèªãƒ»èª¿æ•´
2. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ
3. BOMå‰Šé™¤ï¼ˆUTF-8ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¿®æ­£ï¼‰
4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒªã‚»ãƒƒãƒˆãƒ»ã‚¹ã‚­ãƒ¼ãƒé©ç”¨
5. RLSãƒãƒªã‚·ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
6. RLSãƒãƒªã‚·ãƒ¼é©ç”¨
7. Prisma Clientç”Ÿæˆ
8. Seedãƒ‡ãƒ¼ã‚¿æŠ•å…¥
9. å‹•ä½œæ¤œè¨¼
```

### 3.2 è©³ç´°æ‰‹é †

#### Step 1: schema.prismaæ¤œè¨¼

**å®Ÿæ–½å†…å®¹:**
- ENUMå‹ã®å‘½åè¦å‰‡ã‚’snake_caseã«çµ±ä¸€
- é‡è¤‡ENUMã‚’å‰Šé™¤ï¼ˆ11å€‹ã«é›†ç´„ï¼‰
- ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã®æœ€çµ‚ç¢ºèª

**çµæœ:**
- 31ãƒ†ãƒ¼ãƒ–ãƒ«ã€11 ENUMå‹ã§ç¢ºå®š

#### Step 2: åˆæœŸãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”Ÿæˆ

**ã‚³ãƒãƒ³ãƒ‰:**
```powershell
npx prisma migrate dev --name initial_schema --create-only
```

**çµæœ:**
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ: `20251107000000_initial_schema.sql`

#### Step 3: BOMå‰Šé™¤å¯¾å¿œ

**å•é¡Œ:**
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã«BOM (Byte Order Mark)ãŒå«ã¾ã‚Œã¦ã„ãŸ
- SupabaseãŒã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™

**å¯¾å¿œ:**
- ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ã§ã€ŒBOMãªã—UTF-8ã€ã¨ã—ã¦å†ä¿å­˜

#### Step 4: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒªã‚»ãƒƒãƒˆ

**ã‚³ãƒãƒ³ãƒ‰:**
```powershell
npx supabase db reset
```

**çµæœ:**
- âœ… åˆæœŸã‚¹ã‚­ãƒ¼ãƒé©ç”¨æˆåŠŸ
- 31ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆå®Œäº†

#### Step 5: RLSãƒãƒªã‚·ãƒ¼ä½œæˆ

**å®Ÿæ–½å†…å®¹:**
- å…¨31ãƒ†ãƒ¼ãƒ–ãƒ«ã«å¯¾ã—ã¦RLSãƒãƒªã‚·ãƒ¼SQLã‚’ä½œæˆ
- ãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢ãƒãƒªã‚·ãƒ¼: `tenant_id`ãƒ™ãƒ¼ã‚¹
- ãƒ­ãƒ¼ãƒ«/æ¨©é™ãƒ†ãƒ¼ãƒ–ãƒ«: ã‚°ãƒ­ãƒ¼ãƒãƒ«å‚ç…§å¯èƒ½
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«: `tenant_id`ãŒnullableã«å¯¾å¿œ

**ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«:**
- `supabase/migrations/20251107000001_enable_rls_policies.sql`

**ãƒãƒªã‚·ãƒ¼æ•°:**
- 104ãƒãƒªã‚·ãƒ¼ï¼ˆå…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã§SELECT/INSERT/UPDATE/DELETEï¼‰

#### Step 6: å‹å¤‰æ›ã‚¨ãƒ©ãƒ¼ä¿®æ­£

**å•é¡Œ:**
```
ERROR: operator does not exist: text = uuid
```

**åŸå› :**
- `auth.jwt() ->> 'xxx'`ã¯æ—¢ã«TEXTå‹
- `::uuid`ã‚„`::text`ã®å‹ã‚­ãƒ£ã‚¹ãƒˆãŒä¸è¦ã ã£ãŸ

**å¯¾å¿œ:**
- RLSãƒãƒªã‚·ãƒ¼SQLã‹ã‚‰å…¨ã¦ã®`::uuid`ã¨`::text`ã‚’å‰Šé™¤

#### Step 7: RLSé©ç”¨å®Œäº†

**ã‚³ãƒãƒ³ãƒ‰:**
```powershell
npx supabase db reset
```

**çµæœ:**
- âœ… RLSãƒãƒªã‚·ãƒ¼104å€‹é©ç”¨æˆåŠŸ

#### Step 8: Prisma Clientç”Ÿæˆ

**ã‚³ãƒãƒ³ãƒ‰:**
```powershell
npx prisma generate
```

**çµæœ:**
- âœ… Prisma Clientç”Ÿæˆå®Œäº†
- `node_modules/@prisma/client`ã«é…ç½®

#### Step 9: Seedãƒ‡ãƒ¼ã‚¿æŠ•å…¥

**å®Ÿæ–½å†…å®¹:**
- `prisma/seed.ts`ã‚’ä½œæˆ
- TKDã®Gmailã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’ä½¿ç”¨
  - `ttakeda43+sysadmin@gmail.com` (ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…)
  - `ttakeda43+admin@gmail.com` (ãƒ†ãƒŠãƒ³ãƒˆç®¡ç†è€…)
  - `ttakeda43+user1@gmail.com` (ä¸€èˆ¬åˆ©ç”¨è€…)

**ã‚³ãƒãƒ³ãƒ‰:**
```powershell
npx prisma db seed
```

**çµæœ:**
- âœ… SeedæŠ•å…¥æˆåŠŸï¼ˆè©³ç´°ã¯å¾Œè¿°ï¼‰

---

## 4. æˆæœç‰©

### 4.1 ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

| ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ | èª¬æ˜ |
|-------------|------|
| `prisma/schema.prisma` | Prismaã‚¹ã‚­ãƒ¼ãƒå®šç¾©ï¼ˆv1.7ï¼‰ |
| `supabase/migrations/20251107000000_initial_schema.sql` | åˆæœŸã‚¹ã‚­ãƒ¼ãƒãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ |
| `supabase/migrations/20251107000001_enable_rls_policies.sql` | RLSãƒãƒªã‚·ãƒ¼å®šç¾© |
| `prisma/seed.ts` | Seedãƒ‡ãƒ¼ã‚¿æŠ•å…¥ã‚¹ã‚¯ãƒªãƒ—ãƒˆ |
| `node_modules/@prisma/client/` | Prisma Clientï¼ˆç”Ÿæˆæ¸ˆã¿ï¼‰ |

### 4.2 ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«

| ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª | å†…å®¹ |
|-------------|------|
| `backup_phase9_lowercase/` | æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã‚¹ã‚­ãƒ¼ãƒã¨ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ |

---

## 5. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹æˆ

### 5.1 ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ï¼ˆ31ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰

#### ãƒ†ãƒŠãƒ³ãƒˆç®¡ç†ï¼ˆ3ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
1. `tenants` - ãƒ†ãƒŠãƒ³ãƒˆåŸºæœ¬æƒ…å ±
2. `tenant_settings` - ãƒ†ãƒŠãƒ³ãƒˆè¨­å®š
3. `tenant_features` - æ©Ÿèƒ½ãƒ•ãƒ©ã‚°

#### ãƒ¦ãƒ¼ã‚¶ãƒ¼/èªè¨¼ï¼ˆ4ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
4. `users` - ãƒ¦ãƒ¼ã‚¶ãƒ¼åŸºæœ¬æƒ…å ±
5. `user_tenants` - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ãƒ†ãƒŠãƒ³ãƒˆã®ç´ä»˜ã‘
6. `user_roles` - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ãƒ¼ãƒ«å‰²å½“
7. `user_profiles` - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«

#### ãƒ­ãƒ¼ãƒ«/æ¨©é™ï¼ˆ4ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
8. `roles` - ãƒ­ãƒ¼ãƒ«ãƒã‚¹ã‚¿
9. `role_inheritances` - ãƒ­ãƒ¼ãƒ«ç¶™æ‰¿é–¢ä¿‚
10. `permissions` - æ¨©é™ãƒã‚¹ã‚¿
11. `role_permissions` - ãƒ­ãƒ¼ãƒ«ã¨æ¨©é™ã®ç´ä»˜ã‘

#### æ²ç¤ºæ¿/ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ï¼ˆ7ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
12. `board_categories` - æ²ç¤ºæ¿ã‚«ãƒ†ã‚´ãƒª
13. `board_posts` - æŠ•ç¨¿
14. `board_comments` - ã‚³ãƒ¡ãƒ³ãƒˆ
15. `board_reactions` - ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã„ã„ã­ãƒ»é€šå ±ï¼‰
16. `board_attachments` - æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«
17. `board_approval_logs` - æ‰¿èªå±¥æ­´

#### ãŠçŸ¥ã‚‰ã›ï¼ˆ3ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
18. `announcements` - ãŠçŸ¥ã‚‰ã›
19. `announcement_reads` - æ—¢èª­ç®¡ç†
20. `announcement_targets` - é…ä¿¡å¯¾è±¡

#### æ–½è¨­/äºˆç´„ï¼ˆ5ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
21. `facilities` - æ–½è¨­ãƒã‚¹ã‚¿
22. `facility_settings` - æ–½è¨­è¨­å®š
23. `facility_slots` - æ–½è¨­åŒºç”»
24. `facility_reservations` - äºˆç´„
25. `facility_blocked_ranges` - äºˆç´„ä¸å¯æœŸé–“

#### ç¿»è¨³/ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆ2ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
26. `translation_cache` - ç¿»è¨³ã‚­ãƒ£ãƒƒã‚·ãƒ¥
27. `tts_cache` - éŸ³å£°èª­ã¿ä¸Šã’ã‚­ãƒ£ãƒƒã‚·ãƒ¥

#### é€šçŸ¥ï¼ˆ2ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
28. `notifications` - é€šçŸ¥å±¥æ­´
29. `user_notification_settings` - é€šçŸ¥è¨­å®š

#### ç›£æŸ»/ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ2ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
30. `audit_logs` - ç›£æŸ»ãƒ­ã‚°
31. `moderation_logs` - AIãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°

### 5.2 ENUMå‹å®šç¾©ï¼ˆ11ç¨®é¡ï¼‰

| ENUMå | å€¤ | ç”¨é€” |
|--------|---|------|
| `status` | active, inactive, archived | å…±é€šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
| `role_scope` | system_admin, tenant_admin, general_user | ãƒ­ãƒ¼ãƒ«ã‚¹ã‚³ãƒ¼ãƒ— |
| `board_post_status` | draft, pending, published, archived | æŠ•ç¨¿ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
| `board_reaction_type` | like, report, bookmark | ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç¨®åˆ¥ |
| `approval_action` | approve, reconsider | æ‰¿èªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ |
| `announcement_target_mode` | all, group, role, user | é…ä¿¡å¯¾è±¡ãƒ¢ãƒ¼ãƒ‰ |
| `fee_unit` | day, hour | åˆ©ç”¨æ–™é‡‘å˜ä½ |
| `facility_slot_status` | active, inactive | æ–½è¨­åŒºç”»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
| `reservation_status` | pending, confirmed, canceled | äºˆç´„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
| `moderation_decision` | allow, mask, block | ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åˆ¤å®š |
| `decision_source` | system, human | åˆ¤å®šå®Ÿæ–½è€… |

### 5.3 RLSãƒãƒªã‚·ãƒ¼

**é©ç”¨æ–¹é‡:**
- **ãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢**: `tenant_id`ã«ã‚ˆã‚‹å®Œå…¨åˆ†é›¢
- **ãƒ­ãƒ¼ãƒ«åˆ¶å¾¡**: `auth.jwt() ->> 'role'`ã«ã‚ˆã‚‹æ¨©é™ãƒã‚§ãƒƒã‚¯
- **ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿**: roles/permissionsç³»ã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«å‚ç…§å¯èƒ½

**ãƒãƒªã‚·ãƒ¼ç·æ•°**: 104ãƒãƒªã‚·ãƒ¼

### 5.4 Seedãƒ‡ãƒ¼ã‚¿

#### ãƒ†ãƒŠãƒ³ãƒˆ
- `harmonet-demo` - HarmoNet Demo

#### ãƒ­ãƒ¼ãƒ«ï¼ˆ3ä»¶ï¼‰
| ãƒ­ãƒ¼ãƒ«ã‚­ãƒ¼ | åç§° | ã‚¹ã‚³ãƒ¼ãƒ— |
|-----------|------|----------|
| `system_admin` | ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€… | `system_admin` |
| `tenant_admin` | ãƒ†ãƒŠãƒ³ãƒˆç®¡ç†è€…ï¼ˆç®¡ç†çµ„åˆï¼‰ | `tenant_admin` |
| `general_user` | ä¸€èˆ¬åˆ©ç”¨è€…ï¼ˆä½æ°‘ï¼‰ | `general_user` |

#### ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆ3ä»¶ï¼‰
| ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ | è¡¨ç¤ºå | ãƒ­ãƒ¼ãƒ« |
|---------------|--------|--------|
| `ttakeda43+sysadmin@gmail.com` | ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ï¼ˆç«¹ç”°ï¼‰ | `system_admin` |
| `ttakeda43+admin@gmail.com` | ç®¡ç†çµ„åˆç†äº‹é•· | `tenant_admin` |
| `ttakeda43+user1@gmail.com` | å±±ç”°å¤ªéƒ | `general_user` |

#### æ²ç¤ºæ¿ã‚«ãƒ†ã‚´ãƒªï¼ˆ4ä»¶ï¼‰
1. é‡è¦ãªãŠçŸ¥ã‚‰ã›
2. è³ªå•ãƒ»ç›¸è«‡
3. å›è¦§æ¿
4. ãƒ«ãƒ¼ãƒ«ãƒ»è¦ç´„

#### æ–½è¨­ï¼ˆ2ä»¶ï¼‰
| æ–½è¨­å | ç¨®åˆ¥ | æ–™é‡‘ |
|--------|------|------|
| é›†ä¼šå®¤ | room | 1,000å††/æ—¥ |
| ã‚²ã‚¹ãƒˆé§è»Šå ´ | parking | 300å††/æ™‚é–“ |

#### é§è»Šå ´åŒºç”»ï¼ˆ12ä»¶ï¼‰
- è¡¨: F1ï½F6
- è£: B1ï½B6

---

## 6. ç™ºç”Ÿã—ãŸå•é¡Œã¨å¯¾å¿œ

### å•é¡Œ1: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®BOM

**ç™ºç”Ÿã‚¿ã‚¤ãƒŸãƒ³ã‚°**: åˆå›ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œæ™‚

**ã‚¨ãƒ©ãƒ¼å†…å®¹:**
```
error running container: exit 1
```

**åŸå› :**
- PrismaãŒç”Ÿæˆã—ãŸSQLãƒ•ã‚¡ã‚¤ãƒ«ã«BOM (Byte Order Mark)ãŒå«ã¾ã‚Œã¦ã„ãŸ
- SupabaseãŒBOMä»˜ãUTF-8ã‚’æ­£ã—ãå‡¦ç†ã§ããªã‹ã£ãŸ

**å¯¾å¿œ:**
1. PowerShellã§BOMå‰Šé™¤ã‚’è©¦ã¿ã‚‹ â†’ å¤±æ•—
2. ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ã§ã€ŒBOMãªã—UTF-8ã€ã¨ã—ã¦å†ä¿å­˜ â†’ æˆåŠŸ

**æ•™è¨“:**
- Supabaseãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã¯å¿…ãšBOMãªã—UTF-8ã§ä¿å­˜ã™ã‚‹

### å•é¡Œ2: RLSãƒãƒªã‚·ãƒ¼ã®å‹å¤‰æ›ã‚¨ãƒ©ãƒ¼

**ç™ºç”Ÿã‚¿ã‚¤ãƒŸãƒ³ã‚°**: RLSé©ç”¨æ™‚

**ã‚¨ãƒ©ãƒ¼å†…å®¹:**
```
ERROR: operator does not exist: text = uuid (SQLSTATE 42883)
```

**åŸå› :**
- `auth.jwt() ->> 'tenant_id'`ã¯TEXTå‹ã‚’è¿”ã™
- `tenant_id`ã‚«ãƒ©ãƒ ã‚‚TEXTå‹
- ä¸è¦ãªå‹ã‚­ãƒ£ã‚¹ãƒˆï¼ˆ`::uuid`ï¼‰ãŒåŸå› 

**å¯¾å¿œ:**
1. RLSãƒãƒªã‚·ãƒ¼SQLå†…ã®å…¨ã¦ã®`::uuid`ã‚’å‰Šé™¤
2. å…¨ã¦ã®`::text`ã‚‚å‰Šé™¤

**æ•™è¨“:**
- JWTã‹ã‚‰å–å¾—ã—ãŸå€¤ã¯æ—¢ã«TEXTå‹
- ã‚¹ã‚­ãƒ¼ãƒã®id/tenant_id/user_idã‚‚å…¨ã¦TEXTå‹
- å‹å¤‰æ›ã¯ä¸è¦

### å•é¡Œ3: Seedãƒ‡ãƒ¼ã‚¿ã®ã‚¹ã‚­ãƒ¼ãƒä¸æ•´åˆ

**ç™ºç”Ÿã‚¿ã‚¤ãƒŸãƒ³ã‚°**: Seedä½œæˆæ™‚

**ã‚¨ãƒ©ãƒ¼å†…å®¹:**
- role.scopeã®å€¤ãŒä¸æ­£ï¼ˆ`'global'`, `'tenant'`ï¼‰
- user_rolesã®upsertã‚­ãƒ¼ãŒå­˜åœ¨ã—ãªã„
- facility_settingsã®é‡è¤‡ã‚¨ãƒ©ãƒ¼

**å¯¾å¿œ:**
1. scopeã‚’ENUMå®šç¾©ã«åˆã‚ã›ã‚‹ï¼ˆ`system_admin`, `tenant_admin`, `general_user`ï¼‰
2. user_rolesã¯`deleteMany` + `create`ã«å¤‰æ›´
3. facility_settingsã¯å€‹åˆ¥`upsert`ã«å¤‰æ›´

**æ•™è¨“:**
- Seedãƒ‡ãƒ¼ã‚¿ã¯schema.prismaã¨å®Œå…¨ã«æ•´åˆã•ã›ã‚‹
- ENUMå€¤ã¯å¿…ãšå®šç¾©é€šã‚Šã«ä½¿ç”¨ã™ã‚‹

---

## 7. æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

### 7.1 Phase 9 å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚º

#### å„ªå…ˆåº¦: é«˜
1. **NestJS APIå®Ÿè£…**
   - èªè¨¼ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†API
   - æ²ç¤ºæ¿APIï¼ˆCRUDï¼‰

2. **Next.js ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…**
   - ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢
   - ãƒ›ãƒ¼ãƒ ç”»é¢
   - æ²ç¤ºæ¿ä¸€è¦§ãƒ»è©³ç´°ç”»é¢

3. **Supabase Authçµ±åˆ**
   - Magic Linkèªè¨¼
   - JWTç®¡ç†
   - RLSé€£æº

#### å„ªå…ˆåº¦: ä¸­
4. **æ–½è¨­äºˆç´„æ©Ÿèƒ½å®Ÿè£…**
   - äºˆç´„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
   - åŒºç”»é¸æŠUI
   - äºˆç´„ç®¡ç†

5. **ãŠçŸ¥ã‚‰ã›æ©Ÿèƒ½å®Ÿè£…**
   - é…ä¿¡æ©Ÿèƒ½
   - æ—¢èª­ç®¡ç†
   - ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥é€£æºï¼ˆPhase 2ï¼‰

#### å„ªå…ˆåº¦: ä½
6. **ç®¡ç†ç”»é¢å®Ÿè£…**
   - ãƒ†ãƒŠãƒ³ãƒˆè¨­å®š
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
   - çµ±è¨ˆãƒ»ãƒ¬ãƒãƒ¼ãƒˆ

### 7.2 ç’°å¢ƒæ•´å‚™

- [ ] CI/CDæ§‹ç¯‰ï¼ˆGitHub Actionsï¼‰
- [ ] ãƒ†ã‚¹ãƒˆç’°å¢ƒæ§‹ç¯‰
- [ ] ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤

---

## 8. ä»˜éŒ²

### 8.1 ä½¿ç”¨ã—ãŸã‚³ãƒãƒ³ãƒ‰ä¸€è¦§

```powershell
# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”Ÿæˆ
npx prisma migrate dev --name initial_schema --create-only

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒªã‚»ãƒƒãƒˆ
npx supabase db reset

# Prisma Clientç”Ÿæˆ
npx prisma generate

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ ç¢ºèª
npx supabase db dump --local --data-only=false | Select-String -Pattern "CREATE TYPE"

# Prisma Studioèµ·å‹•
npx prisma studio

# SeedæŠ•å…¥
npx prisma db seed

# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ç¢ºèª
npx supabase migration list
```

### 8.2 ç’°å¢ƒå¤‰æ•°ï¼ˆ.envï¼‰

```env
# Supabase Local
DATABASE_URL="postgresql://postgres:postgres@localhost:54322/postgres"
DIRECT_URL="postgresql://postgres:postgres@localhost:54322/postgres"

# Supabase Auth
NEXT_PUBLIC_SUPABASE_URL="http://localhost:54321"
NEXT_PUBLIC_SUPABASE_ANON_KEY="eyJhbGc..."
```

### 8.3 ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
D:\Projects\HarmoNet\
â”œâ”€â”€ prisma/
â”‚   â”œâ”€â”€ schema.prisma           # Prismaã‚¹ã‚­ãƒ¼ãƒå®šç¾©
â”‚   â”œâ”€â”€ seed.ts                 # Seedãƒ‡ãƒ¼ã‚¿ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â”‚   â””â”€â”€ migrations/             # (Prismaãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´)
â”œâ”€â”€ supabase/
â”‚   â”œâ”€â”€ config.toml             # Supabaseè¨­å®š
â”‚   â””â”€â”€ migrations/
â”‚       â”œâ”€â”€ 20251107000000_initial_schema.sql
â”‚       â””â”€â”€ 20251107000001_enable_rls_policies.sql
â”œâ”€â”€ app/                        # Next.js App Router
â”œâ”€â”€ node_modules/               # ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
â”œâ”€â”€ backup/                     # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
â”œâ”€â”€ backup_phase9_lowercase/    # Phase 9æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³
â”œâ”€â”€ .env                        # ç’°å¢ƒå¤‰æ•°
â”œâ”€â”€ package.json                # npmè¨­å®š
â””â”€â”€ tsconfig.json               # TypeScriptè¨­å®š
```

### 8.4 å‚è€ƒè³‡æ–™

- [Prismaå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://www.prisma.io/docs/)
- [Supabaseå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://supabase.com/docs)
- [HarmoNet Functional Requirements v1.3](ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒŠãƒ¬ãƒƒã‚¸å‚ç…§)
- [HarmoNet DB Table Definition v1.0](ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒŠãƒ¬ãƒƒã‚¸å‚ç…§)

---

## ä½œæ¥­å®Œäº†ç¢ºèª

âœ… **Phase 9 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç’°å¢ƒæ§‹ç¯‰ å®Œäº†**

| é …ç›® | çŠ¶æ…‹ |
|------|------|
| Prisma schema.prisma | âœ… å®Œæˆï¼ˆv1.7ï¼‰ |
| ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ« | âœ… ç”Ÿæˆå®Œäº† |
| RLSãƒãƒªã‚·ãƒ¼ | âœ… 104ãƒãƒªã‚·ãƒ¼é©ç”¨å®Œäº† |
| Prisma Client | âœ… ç”Ÿæˆå®Œäº† |
| Seedãƒ‡ãƒ¼ã‚¿ | âœ… æŠ•å…¥å®Œäº† |
| ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€  | âœ… æ¤œè¨¼å®Œäº† |

---

**å ±å‘Šæ›¸ä½œæˆæ—¥**: 2025å¹´11æœˆ6æ—¥  
**æœ€çµ‚æ›´æ–°**: 2025å¹´11æœˆ6æ—¥  
**æ‰¿èªè€…**: TKD (Project Owner)  
**æ–‡æ›¸ç®¡ç†ç•ªå·**: HNM-REPORT-PHASE9-DB-001

---

**End of Document**
