# HarmoNet 共通ロガー基本設計書

| ドキュメントID  | HNM-COMMON-LOGGER-001       |
| --------- | --------------------------- |
| **バージョン** | **v1.0**                    |
| **作成日**   | 2025-11-15                  |
| **最終更新日** | 2025-11-15                  |
| **作成者**   | TKD                         |
| **更新協力**  | Tachikoma (GPT-5.1)         |
| **関連仕様**  | harmonet-log-design_v1.1.md |
| **承認者**   | （未定）                        |

---

## 1. 目的

本書は、HarmoNet フロントエンド全体で利用する **共通ロガー（Common Logger）** の「基本設計」を定義する。

* どの層に、どのような責務を持つロガーを置くのかを明確にする。
* 何を・なぜログとして残すのか／残さないのかという **考え方とルール** を共有する。
* ログレベル・カテゴリ・コンテキストなどの **用語と分類の定義** を行う。

本書は「なぜ・何を・どこまでやるか」を記載するものであり、具体的な TypeScript の型・ファイルパス・API の実装方式などは詳細設計で扱う。

---

## 2. 位置づけと適用範囲

### 2.1 アーキテクチャ上の位置づけ

共通ロガーは、HarmoNet フロントエンドの **アプリケーション層に属する共通部品** とする。

* UI コンポーネント（画面・共通部品）やアプリケーションロジックからの「ログ出力要求」を受け取る窓口。
* ログ出力前に、ポリシー違反やノイズとなるログをふるい落とす **ゲート** の役割を持つ。
* 「最終的にどこに、どのフォーマットで保存されるか」は、`harmonet-log-design_v1.1` およびバックエンド側実装の責務とする。

### 2.2 適用範囲

* 対象

  * 画面コンポーネント：LoginPage、Board、施設予約など
  * 共通UI部品：AppHeader、AppFooter、ErrorAlert など
  * アプリケーションロジック：カスタムフック、サービス層
* 非対象

  * バックエンドのログ基盤構成（DB、ストレージ、外部サービス等）
  * インフラレベルのログ（Web サーバーログ、ネットワークログなど）

---

## 3. ログの考え方（ポリシー）

### 3.1 ログを残す目的

HarmoNet におけるフロントエンドログの主目的は以下とする。

1. **障害調査・原因分析**

   * 予期しない例外や API 障害が発生した際に、再現や原因追跡を容易にする。

2. **利用状況の把握（最小限）**

   * ログイン／ログアウト、重要な操作（施設予約の確定など）の成功・失敗状況を把握する。

3. **システムの健全性確認**

   * エラーや警告の発生傾向から、設計・実装上の問題を検知する。

### 3.2 ログとして残さないもの

以下は原則としてログ出力の対象外とする。

* 入力フィールドの変更ごとのイベント（`onChange` など高頻度なもの）
* 単純な画面表示開始・終了など、障害調査に寄与しにくいイベント
* デバッグ目的の一時的な出力（開発中のみ有効とし、本番には残さない）

### 3.3 個人情報・機密情報の扱い

* メールアドレス、氏名、住所などの個人情報は、原則としてログ出力しない。
* やむを得ずユーザー識別が必要な場合は、

  * ユーザーID・テナントIDなどの内部IDで識別する。
  * 文字列としてのメールアドレス等を直接残さない（マスク・トークン化を検討）。

---

## 4. ログレベルの定義

ログレベルは、`harmonet-log-design_v1.1` に基づき、フロントエンドでは以下の 3 種類を用いる。

* **INFO**

  * 想定どおりの正常なイベント。例：ログイン成功、予約完了、ログアウト完了。

* **WARN**

  * 想定内の失敗・注意が必要な状態。例：ログイン失敗（入力誤り）、バリデーションエラーの多発、再試行可能な API エラー。

* **ERROR**

  * 想定外の例外・重大な障害。例：JavaScript 例外、API サーバーの 5xx 連発、フロントエンドから回復できない状態。

呼び出し側は、上記の定義に従ってレベルを選択する。
レベルの最終判断は共通ロガー側で補正してもよいが、原則は呼び出し時に正しいレベルを選ぶことを求める。

---

## 5. ログカテゴリとコンテキスト

### 5.1 ログカテゴリ（概念）

ログを分類するため、カテゴリを以下のように定義する。

* **auth**: 認証・認可に関するイベント（ログイン／ログアウト、トークン更新など）
* **ui**: UI操作・表示切替に関するイベント（重要なボタン押下、画面遷移など）
* **api**: API 呼び出しに関するイベント（エラー、特定エンドポイントの失敗など）
* **domain**: 業務ロジックに関するイベント（施設予約、掲示板投稿など）
* **system**: その他システム全体に関わるイベント（設定読み込み失敗など）

カテゴリは `harmonet-log-design_v1.1` の分類に整合させる。
基本設計の段階では名前と意味だけを定義し、実際の列挙型定義等は詳細設計にて行う。

### 5.2 コンテキスト情報

ログには、状況を再現するためのコンテキスト情報を必要に応じて付与する。

* **tenantId**: テナント（マンション／団地）を識別するID
* **userId**: ログインユーザーを識別するID
* **screenId**: 画面単位の識別子（例：`LOGIN`, `HOME`, `BOARD_LIST`, `FACILITY_BOOKING`）
* **componentId**: コンポーネント単位の識別子（例：`A-00`, `A-01`, `C-13`）
* **requestId**: バックエンドとの相関ID（API 呼び出し単位のID）

どの項目をどのログで必須とするかは、`harmonet-log-design_v1.1` 側の設計と合わせて詳細設計で定義する。
本書では「こうしたコンテキストを持てる」という枠組みを示すにとどめる。

---

## 6. 出力先と方式（標準出力を使う理由）

### 6.1 初期フェーズの方針

HarmoNet の初期段階では、フロントエンドからのログは **標準出力** を主な出力先とする。

* Next.js / Vercel の実行環境では、`console.*` に出力された内容が Vercel のログとして収集される。
* 専用のログ基盤を構築しなくても、最低限のログ閲覧・検索が可能である。

### 6.2 標準出力を選択する理由

* **追加インフラが不要**
  初期コストを抑えつつ、障害調査に耐えうるログを確保できる。

* **挙動の透明性**
  開発者がブラウザコンソールや Vercel ログを直接確認でき、挙動を追いやすい。

* **将来拡張への足場**
  後から専用ログAPIや別基盤を導入する場合でも、共通ロガーが出口を一元管理していれば、呼び出し側のコードを変更せずに済む。

### 6.3 共通ロガーが出力前に行うべき確認

標準出力に直接書き込むのではなく、共通ロガーを経由することで、以下を統一的にチェックする。

* レベル・カテゴリが定義に沿っているか
* ログとして残す価値があるイベントか（高頻度イベントではないか）
* 個人情報や不要な詳細データを含んでいないか
* フォーマット（タイムスタンプ・コンテキスト）が `harmonet-log-design_v1.1` に沿っているか

これらのチェックロジックの記述方法は詳細設計に委ねるが、「出力前にこの観点で必ず確認する」という方針を本書で定める。

---

## 7. 共通ロガーの役割とインタフェース方針

### 7.1 役割のまとめ

共通ロガーは、アプリケーション層において次の役割を持つ。

1. ログエントリを一定の構造に正規化する（レベル・カテゴリ・コンテキストを含む）。
2. 出力対象かどうかをポリシーに基づいて判断する（頻度・情報量・機密性）。
3. 適切な出力先（初期は標準出力）へ渡す。

### 7.2 API 仕様との関係（詳細設計 v1.1 の尊重）

共通ロガーの **具体的な関数シグネチャ** は、すでに「共通ログユーティリティ 詳細設計書 v1.1」にて以下のように確定しているものを正とする。

```ts
logInfo(event: string, context?: Record<string, unknown>)
```

* `event`: `auth.login.start` のような **ドメインを含んだイベントキー** を渡す。

  * 例: `auth.login.success`, `auth.login.failed`, `facility.booking.created` など。
* `context`: そのイベントに紐づく追加情報をキー／値ペアで渡す。

  * tenantId, userId, screenId, componentId, requestId などのコンテキストを含める。

> 本基本設計書は、この API 仕様を**変更・再定義しない**。
> なぜ `event` キー方式を採用するのか、その考え方と利用ルールのみを記載する。

#### 7.2.1 なぜ `event` キー方式なのか

* ログの検索性を高めるため

  * `auth.login.*` のようにプレフィックスで絞り込みやすく、障害調査時のフィルタリングに適している。
* メッセージ文言をログ基盤側で柔軟に扱えるため

  * 人間向けのメッセージと機械向けのキーを分離できる。
* 将来の多言語化や集計処理に対応しやすいため

  * `event` は変えずに、ビュー側でラベルや説明文を切り替えることができる。

#### 7.2.2 `context` に含める情報の考え方

* 再現に必要な **最小限の情報** にとどめる。
* 個人情報は原則として含めない（userId など内部IDで代替する）。
* 頻繁に変化する全データをそのまま入れず、必要なフィールドだけ抽出する。

> 具体的な `event` 名称の一覧や `context` のキー定義は、共通ログユーティリティ詳細設計 v1.1 および各機能の詳細設計書で定義する。本書では「キー方式で管理する」という方針を示すにとどめる。

---

## 8. 典型的な利用パターン（概念レベル）

### 8.1 ログイン成功・失敗

* 成功時

  * レベル: INFO
  * カテゴリ: auth
  * 例: 「Login succeeded」

* 失敗時（入力誤りなど想定内）

  * レベル: WARN
  * カテゴリ: auth
  * 例: 「Login failed: invalid credentials」

* 予期しない例外（通信障害など）

  * レベル: ERROR
  * カテゴリ: auth or api

### 8.2 API エラー

* 対象: 重要な API 呼び出し（認証、施設予約、掲示板投稿など）
* レベル: WARN または ERROR（エラー内容に応じて）
* カテゴリ: api
* details には、エンドポイント名、HTTP ステータス、簡易エラーメッセージなどを含める（個人情報は含めない）。

### 8.3 重要な UI 操作

* 例: ログアウト、施設予約の確定、掲示板投稿の送信など
* レベル: INFO
* カテゴリ: ui または domain
* screenId / componentId を付与し、どの画面・コンポーネントからの操作かを識別できるようにする。

---

## 9. 今後の拡張方針

本書は、あくまで初期フェーズの基本設計であり、以下のような拡張を想定する。

* バックエンド側ログ基盤との連携強化（専用ログAPI・認証方式など）
* 特定種類のエラーのサンプリング（すべて出すのではなく、一部を間引く）
* テナントごとのログ閲覧・エクスポート機能との連携

これらを実現する際も、「画面・機能側は必ず共通ロガーを経由する」という前提を維持し、
呼び出し側のコード変更を最小限に抑える方針とする。

---

## 10. 関連ドキュメント

* `harmonet-log-design_v1.1.md`
  HarmoNet ログ出力設計（フォーマット・レベル・保持方針）。本書はこのポリシーを前提とし、フロントエンド側の利用方法を定義する。
* `共通エラーハンドリング仕様書 v1.2`
  ErrorAlert / InlineFieldError / AppErrorBoundary の設計。必要に応じて共通ロガーを利用してエラー情報を記録する。
* `A-00LoginPage-detail-design_v1.1.md`
  ログイン画面詳細設計。ログイン成功・失敗時のログ出力パターンを詳細に定義する。
* `MagicLinkForm-detail-design_v1.1.md`
  MagicLink フォーム詳細設計。
* `PasskeyAuthTrigger-detail-design_v1.1.md`
  Passkey 認証トリガ詳細設計。

---

## 11. 改訂履歴

| バージョン | 日付         | 更新者             | 更新内容                                                                                        |
| ----- | ---------- | --------------- | ------------------------------------------------------------------------------------------- |
| v1.0  | 2025-11-15 | TKD + Tachikoma | HarmoNet 共通ロガーの基本設計を新規作成。アプリケーション層におけるロガーの位置づけ、ログポリシー、レベル・カテゴリ・コンテキストの定義、および標準出力を選択する理由を整理。 |
