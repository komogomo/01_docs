# 共通エラーハンドリング仕様書

| ドキュメントID  | SEC-APP-COMMON-ERROR-001 |
| --------- | ------------------------ |
| **バージョン** | **v1.2**                 |
| **作成日**   | 2025年10月28日              |
| **最終更新日** | 2025年11月15日              |
| **作成者**   | TKD                      |
| **更新協力**  | Tachikoma (GPT-5.1)      |
| **承認者**   | (未定)                     |

---

## 1. 本書の位置づけ

本書は、HarmoNet フロントエンドにおける **画面内のエラー表示方式** を定義する「共通エラーハンドリングの基本設計」である。

* 対象コンポーネント（機能コンポーネント一覧 v1.3 準拠）

  * C-13: AppErrorBoundary
  * C-14: ErrorAlert
  * C-15: InlineFieldError
* C-16, C-17, C-18, C-19 で検討していた **複雑なエラー通知・監視・集中管理の仕組みはすべて削除済み** とし、本書では扱わない。
* 監視サービスやアラート通知（SaaS / 自前実装ともに）は **非機能要件 v1.4 に従い導入しない**。
* ログ出力ポリシーは別紙 `harmonet-log-design_v1.1.md` を正とし、本書では **ログの有無のみ**に触れる。

本書は「LoginPage 詳細設計書（A-00/A-01/A-02）」で利用する共通仕様であり、

* 画面上部のエラー表示
* 入力欄直下のエラー表示
* 予期しない例外時のフェイルセーフ
  に限定して設計する。

---

## 2. エラー種別と表示方針

### 2.1 エラー種別（UI観点）

UI上で扱うエラーは、以下の 3 区分に簡略化する。

1. **入力エラー（ValidationError）**

   * 例: メールアドレス形式不正、必須入力漏れ。
   * 表示: 対象フィールド直下に `InlineFieldError`（C-15）。
   * ログ: 原則なし。

2. **画面レベルエラー（ScreenError）**

   * 例: ログイン失敗、通信エラー、Passkey 認証失敗など、画面全体に関わるエラー。
   * 表示: 画面上部に `ErrorAlert`（C-14）。
   * ログ: 必要に応じて別紙ログ設計に従い出力するが、本書では詳細を規定しない。

3. **予期しない例外（UnexpectedError）**

   * 例: 想定外の JavaScript 例外。
   * 表示: `AppErrorBoundary`（C-13）によるフェイルセーフ画面。
   * ログ: 別紙ログ設計に従う（本書では扱わない）。

### 2.2 非機能要件との整合

* 通知用のトースト、バナー、SNS/メール連携など、**エラーを「ユーザー以外に知らせる」機能は一切実装しない**。
* 本書でいう「ErrorAlert」は、あくまで **画面内の単純なエラーバナー** であり、「監視・通知システム」ではない。

---

## 3. C-13: AppErrorBoundary（画面全体のフェイルセーフ）

### 3.1 目的

* React コンポーネントツリー内で発生した予期しない例外を捕捉し、

  * アプリ全体のクラッシュを防ぐ
  * ユーザーに簡潔なメッセージを表示する
    ためのエラー境界コンポーネントを提供する。

### 3.2 適用範囲

* Login 関連画面では、以下の単位で AppErrorBoundary を適用する。

  * `app/login/page.tsx` … LoginPage 全体
  * 必要に応じて、将来の他画面にも再利用可能な設計とする。

### 3.3 表示仕様（概要）

* 予期しない例外が発生した場合、次の要素を含む簡易画面を表示する。

  * 見出し: 「エラーが発生しました」
  * 説明: 「再読み込みしても解決しない場合は、管理者にお問い合わせください。」
  * ボタン: 「再読み込み」ボタン（ブラウザリロード）
* 技術的な詳細（スタックトレースなど）は画面に表示しない（開発モードのみ表示してもよい）。

> 詳細な props / ファイル構成 / 疑似コードは、各コンポーネントの詳細設計書（C-13 詳細設計）で定義する。

---

## 4. C-14: ErrorAlert（画面上部エラーバナー）

### 4.1 目的

* LoginPage を含む各画面で、**画面全体レベルのエラーをユーザーに知らせるための単純なバナー**を提供する。

### 4.2 表示位置

* LoginPage の場合

  * 画面タイトルおよび説明テキストの直下に表示する（MagicLink / Passkey フォームの上）。

### 4.3 表示仕様

* 構成要素

  * アイコン（例: Alert アイコン、色はブランドガイドラインに従う）
  * メッセージ（i18n キーから取得）
* アクセシビリティ

  * `role="alert"` を付与する。
  * `aria-live="assertive"` を指定し、スクリーンリーダーが即座に読み上げられるようにする。
* 挙動

  * 初期状態では非表示。
  * 親コンポーネント（LoginPage 等）が状態管理し、「エラー発生時のみ」1件のメッセージを表示するシンプルな設計とする。

> 本書では、ErrorAlert の props とイベント詳細は定義せず、別途「C-14 ErrorAlert 詳細設計」で定義する。

---

## 5. C-15: InlineFieldError（フィールド直下のエラー）

### 5.1 目的

* 入力フォームの各フィールド直下に、**バリデーションエラーを表示するための最小限のコンポーネント**を提供する。

### 5.2 表示仕様

* 構成

  * 短いテキストメッセージ（i18n）。
  * 必要に応じて小さなアイコンを付与してもよいが、視認性を優先する。
* アクセシビリティ

  * InlineFieldError は一意の `id` を持つ。
  * 対応する入力フィールド側で `aria-describedby` にこの `id` を設定する。

### 5.3 使用ルール

* 1 フィールドにエラーメッセージは 1 件のみ表示する。
* 入力中はできるだけ即時にエラーが更新されるようにするが、細かいタイミング（onBlur / onChange）は各機能詳細設計に委ねる。

---

## 6. LoginPage 系への適用方針

### 6.1 MagicLinkForm (A-01)

* メールアドレス入力欄

  * バリデーションエラー: `InlineFieldError` を使用。
* Supabase からのエラー（OTP 発行失敗など）

  * 画面上部の `ErrorAlert` で 1 件のメッセージを表示。

### 6.2 PasskeyAuthTrigger (A-02)

* Passkey 認証失敗

  * `ErrorAlert` に「認証に失敗した」旨の汎用メッセージを表示。
  * エラー理由の詳細（存在しない Passkey 等）はユーザーに見せない。

### 6.3 LoginPage (A-00)

* 上記 2 コンポーネント（MagicLink / Passkey）からのエラー状態をまとめて管理し、

  * 画面上部の ErrorAlert に「代表エラー」1件を表示するシンプルな実装とする。

---

---

## Appendix A: 関連ドキュメント

* 機能コンポーネント一覧_v1.3.md
* 非機能要件定義書_v1.4.md
* harmonet-log-design_v1.1.md
* MagicLinkForm-detail-design_v1.1.md
* PasskeyAuthTrigger-detail-design_v1.1.md
* A-00LoginPage-detail-design_v1.1.md

---

## Appendix B: 改訂履歴

| バージョン | 日付         | 更新者             | 更新内容                                                                                                  |
| ----- | ---------- | --------------- | ----------------------------------------------------------------------------------------------------- |
| v1.2  | 2025-11-15 | Tachikoma       | 非機能v1.4および機能コンポーネント一覧 v1.3 に整合。C-16〜C-19 を設計対象から完全除外し、C-13〜C-15 に限定したシンプルなエラー表示方針に縮小。監視・通知系の記述をすべて削除。 |
| v1.1  | 2025-11-15 | TKD + Tachikoma | C-13〜C-20 による共通エラー設計として拡張（※非採用方針）。                                                                    |
| v1.0  | 2025-10-28 | TKD + Gemini    | 新規作成。                                                                                                 |
