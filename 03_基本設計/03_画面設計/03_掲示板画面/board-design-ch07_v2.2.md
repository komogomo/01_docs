# 第7章: 補助機能（既読・通報・アンケート拡張）

**掲示板機能 基本設計書 v2.2（HarmoNet準拠）**

[← 第6章](board-design-ch06_latest.md) | [目次に戻る](board-design-ch00-index_latest.md)

---

## 🆕 ChangeLog (v2.2 / 2025-11-21)

* 章タイトルを「補助機能」とし、既読管理・通報・将来のアンケート拡張にフォーカス
* 既読管理の対象を「管理組合ロールの投稿全般」に拡大（回覧板に限定しない）
* 既読管理を「通知到達の証跡」として定義し、議決そのものはアンケート機能と連携する方針を明示
* 通報機能は ch06 の AI モデレーションとは独立した安全装置として位置づけを整理
* 翻訳機能は ch06 の共通仕様に統合し、本章から削除
* 将来拡張として「アンケート／議決機能」「テナント単位の ON/OFF 設定」を追加

---

## 7.1 既読管理（管理投稿向け）

### 7.1.1 目的

* 管理組合ロールの投稿（お知らせ・回覧板・議案など）について、

  * 住民が「内容を確認したか」をシンプルに記録する。
  * 管理組合が「どの程度読まれているか」を数値で把握できるようにする。
* 既読管理はあくまで「通知到達の指標」であり、議決の賛否は別途アンケート機能で扱う。

### 7.1.2 対象

* 対象投稿:

  * 投稿者ロールが「管理組合／管理会社」に属するアカウントの投稿すべて。
  * 回覧板はその一部として扱うが、既読管理は回覧板に限定しない。
* 対象ユーザ:

  * 対象投稿の閲覧権限を持つすべての住民（GLOBAL / GROUP を問わず）。

### 7.1.3 UI 概要

#### BoardDetail（/board/[id]）

* 管理投稿の場合のみ、本文エリアの下部に既読ブロックを表示する。

例:

```text
👁 既読状況
既読: 12 / 30 世帯（40%）
[既読にする]
```

* 住民側の挙動:

  * 未読状態では「既読にする」ボタンを表示。
  * 押下後は「✅ 既読済み」ラベルに切り替え、ボタンは表示しない。
  * 既読操作は 1 回のみを想定し、再度未読に戻す UI は提供しない。

* 管理側の用途:

  * 既読率（既読世帯数 / 対象世帯数）を把握し、未読が多い場合は追加の周知手段（PUSH 通知・紙配布等）を検討する。

#### BoardTop（/board）

* 管理投稿のカードにのみ、住民ごとの既読状態を示すバッジを表示する。

  * 自分が未読: 「👁 未読」バッジ。
  * 自分が既読: バッジ非表示、または「✅ 既読」等の控えめな表示。
* 一般住民投稿には既読バッジを表示しない。

### 7.1.4 データおよび集計

* 既読情報は、テナント単位で分離された既読テーブル（例: `post_read_receipts`）に保存する前提とする。

  * `tenant_id`
  * `post_id`
  * `user_id` または「世帯を一意に識別するキー」
  * `read_at`
* 既読率の分母（対象世帯数）は、テナント設定またはグループ設定側で定義し、本章では「対象世帯数として外部から与えられる」前提に留める。

### 7.1.5 管理画面での利用（将来拡張）

* 管理者向けには、次のような一覧画面を将来拡張として想定する。

  * 管理投稿一覧: タイトル／掲載日／対象範囲／既読率／締切日 など。
  * 個別画面: 既読者数・未読者数・既読率推移など。
* 個票レベル（誰が既読か）の情報は、テナント管理者画面でのみ閲覧可能とし、掲示板画面には表示しない。

---

## 7.2 通報機能

### 7.2.1 目的と位置づけ

* 通報機能は、住民が不適切な投稿・コメントを管理者に知らせるための仕組みである。
* ch06 で定義した AI モデレーションが「投稿前のチェック」であるのに対し、

  * 通報機能は「投稿後の安全維持」を担う人間中心の仕組みとする。

### 7.2.2 通報対象

* 投稿本文
* コメント本文

### 7.2.3 通報理由

代表的な通報理由を選択式で提供し、必要に応じて自由入力を受け付ける。

| 理由      | 説明              |
| ------- | --------------- |
| 不適切な内容  | 暴言、誹謗中傷など       |
| スパム・宣伝  | 営利目的の投稿         |
| 個人情報の漏洩 | 氏名や住所などの公開      |
| 差別的表現   | 国籍・性別・宗教などによる差別 |
| その他     | 自由記述            |

### 7.2.4 通報フロー（利用者側）

1. 投稿詳細画面のメニューから「通報する」を選択。
2. 通報理由を選択し、補足説明を入力（任意、最大 200 文字程度）。
3. 「送信」ボタンで管理者に通知する。
4. 完了メッセージを静かに表示する。

   * 例: 「✅ 通報しました。管理者が確認します。」

### 7.2.5 管理者対応（概要）

* 通報一覧

  * 未対応／対応中／完了などのステータス別に一覧表示。
* 通報詳細

  * 理由・対象投稿・通報者情報・通報日時を確認できる画面を提供。
* 対応結果記録

  * 「削除」「警告」「対応不要」などの対応結果を記録する。
* 重複通報制御

  * 同一ユーザによる同一投稿への過剰通報を判別し、一覧上のノイズを減らす。

### 7.2.6 悪用防止

* 通報履歴を保存し、過剰通報ユーザを把握できるようにする。
* 悪質な場合は、投稿制限や警告などの措置を取れるような設計を将来的に検討する。

---

## 7.3 アンケート／議決機能（将来拡張）

### 7.3.1 位置づけ

* 「既読管理」はあくまで「通知が届いているかどうか」の指標であり、

  * 実際に議決や同意を得るためには、明確な意思表示（賛成／反対等）を集計するアンケート機能が必要となる。
* 本機能は、管理組合ロールの投稿に対して付与できる **プレミアム機能** として位置づける。

### 7.3.2 テナント設定（ON/OFF）

* アンケート機能の利用可否は、テナント設定で制御できるようにする。

  * `survey_enabled`: true / false
  * デフォルト: false（無効）
* `survey_enabled = true` のテナントのみ、管理投稿作成時に「アンケートを作成」セクションが表示される。

### 7.3.3 住民向け UI（概要）

* 管理投稿（`survey_enabled` が有効なテナント）に対して、本文下部にアンケートブロックを表示する想定とする。

  * 例: 「この議案に賛成しますか？」
  * 選択肢例: 「賛成」「反対」「どちらでもよい」など。
* 住民は 1 回だけ回答でき、回答後は選択結果のみが自分に見える。
* 他の住民の個別回答は表示せず、集計結果（人数・割合）のみを共有する。

  * 例: 「賛成 25 / 40（62.5%）、反対 10 / 40（25%）、未回答 5 / 40（12.5%）」

### 7.3.4 管理者向け UI（概要）

* 管理者画面では、次の情報を閲覧できる設計を想定する。

  * 投稿単位の集計: 賛成／反対／未回答の人数・割合、締切、対象世帯数など。
  * 個票一覧: 名前（または世帯名）・部屋番号・所属グループ・回答内容・回答日時。
* これにより、4/5 同意などの議決条件に対して、

  * 現在どの程度まで到達しているか
  * どの世帯／エリアに未回答が多いか
    を把握できる。

### 7.3.5 掲示板との関係

* 掲示板側では、アンケート結果の集計（賛成数・反対数・未回答数）を、

  * すべての住民が閲覧可能な情報として表示する。
* 個別回答（誰がどう答えたか）は掲示板には表示せず、

  * テナント管理者画面のみで閲覧可能とする。
* 既読管理とアンケートは連携しつつも役割を分け、

  * 既読: 「見たかどうか」
  * アンケート: 「どう判断したか」
    を別々に扱う。

---

## 7.4 設計意図まとめ

1. **既読管理は「通知到達」の証跡**

   * 管理投稿がどれだけ読まれているかを可視化し、未読が多い場合の追加対応（PUSH・紙配布等）を判断しやすくする。

2. **通報機能は AI とは独立した安全装置**

   * AI モデレーションが停止していても、住民の判断で不適切な投稿を管理組合に知らせることができるようにする。

3. **アンケート／議決機能はプレミアム拡張**

   * タワーマンションなど議決ハードルの高い物件向けに、
     管理投稿にアンケートを紐づけて賛否を数値で把握できる機能を、テナント単位のオプションとして設計する。

4. **公開される情報と管理者だけが見る情報を分離**

   * 住民向けには集計情報のみを共有し、個人単位の既読／回答の詳細はテナント管理者画面だけで扱うことで、
     プライバシーと運営上の実効性のバランスを取る。

---

**Document ID:** SEC-APP-BOARD-DESIGN-002-CH07
**Version:** 2.2
**Created:** 2025-10-27
**Last Updated:** 2025-11-21
**Author:** TKD + GPT (HarmoNet PMO)


いまの仕様（記事番号＋ショートカットURL＋マジックリンク連携）を、掲示板側の設計書にだけ反映する、という方針はその通りでよいと思います。

こちらでやろうとしたことと現状を共有します。

やろうとした更新

board-design-ch07_v2.2 に、次の2点を追記しようとしました。

「記事番号」の節

内部ID（UUID）とは別に、テナント内で一意な表示用記事番号（例: #B-2025-000123）を持つ

管理画面・通報一覧・メール通知でこの番号を使って照会・検索する

住民向け UI では常時大きくは出さず、必要なときだけメニュー等で確認できる

「ショートカットURLとマジックリンク」の節

各投稿に /board/[id] のショートカットURLを持たせる

未ログインでアクセスされたら /login?redirect=<記事パス> にリダイレクトする前提

マジックリンク認証完了後に redirect 先（= /board/[id]）へ自動遷移する

通報メールやお知らせメールには「記事番号＋ショートカットURL」を必ず含める

失敗したこと

canmore 側の部分更新で、既存の見出しパターンをうまくマッチできず、テキスト置換がエラーで弾かれました。

そのため、現時点では ch07 の内容は表示上まだ変わっていません。

設計内容としての合意
仕様そのものは以下のように固めておいて問題ないと考えます。

記事番号

テナント内で一意な人間可読ID（例: B-2025-000123）を付与する

管理者UI・通報一覧・メールでの検索キーにする

住民向けUIでは、常時表示ではなく「記事情報」などの補助表示に留める

ショートカットURL＋マジックリンク

投稿ごとに /board/[id] のショートカットURLを持つ

未ログイン時アクセス → /login?redirect=/board/[id] にリダイレクト

マジックリンク認証完了後、redirect に従って /board/[id] に遷移

通報メール／お知らせメールには記事番号＋ショートカットURLを両方記載する

今後の進め方（提案）

ch07 については、次回タイミングで「全文差し替え」で v2.3 として出し直す形にした方が安全です。
（部分置換が不安定なので、次は最初から ch07 全文をまとめて提示します。）

ログイン／バックエンド側の設計書は、TKDの言う通り「掲示板実装が終わり、redirect の動作を実機確認してから」追記する、でよいと思います。

設計内容自体は上記のとおり整合していますので、

「記事番号＋ショートカットURL＋マジックリンク redirect 前提」は合意済み仕様

ch07 は次のターンで全文更新（v2.3）として整理

という状態で扱っておいてください。
