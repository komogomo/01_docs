# 第6章: 掲示板共通仕様（翻訳・音声・モデレーション）

**掲示板機能 基本設計書 v2.3（HarmoNet準拠）**

[← 第5章](board-design-ch05_latest.md) | [目次に戻る](board-design-ch00-index_latest.md)

---

## 🆕 ChangeLog (v2.3 / 2025-11-21)

* 章タイトルを「主要機能」から「共通仕様（翻訳・音声・モデレーション）」に変更
* ch01〜ch05 / Design-decision-summary v1.0 / 機能要件 v1.6 / 技術スタック v4.4 に整合するよう、構成を再定義
* 投稿・コメント・添付の個別仕様は ch03〜ch05 に委譲し、本章では「共通ルール」として要点のみを集約
* 記事投稿時の 3 言語自動翻訳＋キャッシュ仕様を正式に定義
* 掲示板画面に限定した音声読み上げ（TTS）の適用範囲・キャッシュ方針を定義
* AI モデレーションは「任意導入の付加価値機能」として位置づけを整理し、3 段階レベル等の実装詳細は別紙に切り出し
* エラーハンドリングを「翻訳・TTS・モデレーションが止まっても投稿／閲覧は継続できる」方針に一本化

---

## 6.1 本章の目的

本章は、掲示板機能における **共通の横断仕様** を定義する。

* 投稿本文の 3 言語自動翻訳とキャッシュ
* 掲示板画面に限定した音声読み上げ（TTS）
* 一般利用者投稿に対する AI モデレーション（任意導入の付加価値）
* これらが停止・失敗した場合のエラーハンドリング

個々の画面の UI や入力項目は、以下の章で定義済みとし、本章では「共通ルール」と「横断的なデータの流れ」に絞って記述する。

* BoardTop 一覧: ch03
* 投稿詳細（BoardDetail）: ch04
* 投稿作成・編集: ch05

---

## 6.2 投稿・コメント・添付の共通ルール

### 6.2.1 投稿

* 投稿の基本構造（タイトル／本文／カテゴリ／公開範囲／添付／回覧板フラグ等）は ch05 に従う。
* 投稿本文の最大文字数は次の二段階で管理する（ch05 で詳細定義）。

  * システム絶対上限: 5000 文字
  * テナント上限: テナント管理者画面から 1〜5000 の範囲で設定可能（未設定時は 2000 文字）
* バリデーションはフロントエンド／バックエンド双方で行い、どちらもテナント上限と絶対上限を満たさない場合はエラーとする。

### 6.2.2 コメント

* コメントは、対象投稿に 1 階層で紐づく「本文のみ」のシンプルな構造とする（タイトルなし）。
* コメントには添付ファイルを許可しない（MVP）。
* コメントの編集・削除権限および表示順は ch04（BoardDetail）に従う。

### 6.2.3 添付ファイル

* 添付ファイルは PDF／画像を基本対象とし、Office 等は原則として対象外（MVP）。
* 制限値は ch05 に定義された次の方針に従う。

  * システム絶対上限

    * 1 投稿あたり添付数: 最大 10 個
    * 1 ファイルあたりサイズ: 最大 5MB
  * テナント上限（テナント管理者が設定可能）

    * 添付数: 1〜10、未設定時は 5 個
    * ファイルサイズ: 1〜5MB、未設定時は 5MB
* BoardTop では「添付あり」アイコンのみ表示し、実際のプレビューは BoardDetail の責務とする。

---

## 6.3 投稿本文の 3 言語自動翻訳とキャッシュ

### 6.3.1 目的

* 住民は「自分が書きやすい言語」で投稿できるようにしつつ、

  * 日本語・英語・中国語（簡体字）の 3 言語で閲覧できる環境を提供する。
* ユーザに「翻訳操作」を強いることなく、LanguageSwitch のアクティブ言語に応じて自然に表示言語が切り替わる体験を実現する。

### 6.3.2 翻訳タイミング

* 新規投稿／編集保存時（本文に変更がある場合）、次の処理を行う。

  1. 投稿者が入力した元本文（タイトル＋本文）を保持する。
  2. 元本文を基準に、JA / EN / ZH の 3 言語へ自動翻訳を実行する。
  3. 翻訳結果を translation_cache 等のテーブルに保存する。
* 翻訳は保存処理の一部として同期的に行うか、キューを介した非同期処理とするかは詳細設計で決定するが、

  * ユーザ体験としては「保存完了後、通常はすぐに 3 言語分が利用可能」となる状態を目標とする。

### 6.3.3 表示ルール（LanguageSwitch との連携）

* HOME 掲示板サマリ / BoardTop / BoardDetail はすべて、

  * LanguageSwitch のアクティブ言語に対応する **キャッシュ済み訳文** をタイトル・本文として表示する。
* 元の投稿言語を個別に表示する「原文ボタン」は設けず、

  * 「見たい言語で見る」体験はすべて LanguageSwitch に統一する。
* 一時的に翻訳が利用できない場合（エラー・未翻訳）は、

  * フォールバックとして元本文を表示するか、簡易メッセージを表示するかは詳細設計で定義する。

### 6.3.4 翻訳キャッシュの更新（翻訳ボタン）

* 翻訳キャッシュには有効期限またはバージョン管理を設け、

  * 期限切れ・翻訳エラー・翻訳エンジン変更などの場合に再翻訳を許容する。
* 再翻訳は、主に BoardDetail 画面から次のようにトリガされる想定とする。

  * 「翻訳を更新」ボタン（または同等 UI）は、権限のあるユーザ（管理者／投稿者）にのみ表示する案を基本とする。
  * 押下時にバックエンドで 3 言語すべてを再翻訳し、translation_cache を更新する。
* 一般閲覧ユーザは通常このボタンを意識する必要はなく、翻訳ボタンは「キャッシュ維持のための管理用ツール」として扱う。

---

## 6.4 音声読み上げ（TTS）とキャッシュ

### 6.4.1 適用範囲

* 音声読み上げの対象は、掲示板機能における以下の内容に限定する。

  * 投稿本文（BoardDetail）
  * 必要に応じて BoardTop の一覧カードから選択した投稿の本文
* 静的 UI テキストや、HOME 画面全体などへの一括適用は行わない。

### 6.4.2 UI 方針

* BoardDetail の本文付近に「音声で聞く」ボタン（またはリンク）を配置する。
* 押下時の挙動:

  * アクティブ言語の本文を音声合成し再生する。
  * 再生中に一時停止／停止が行えるシンプルな UI とする。
* ボタンの表示は控えめにし、「読み上げが必要な人が迷わず見つけられる」位置に置く。

### 6.4.3 TTS キャッシュ

* 一定長の投稿本文については、TTS 生成結果を tts_cache などに保存し、

  * 再生時には可能な限りキャッシュ済み音声を再利用する。
* キャッシュのキー例:

  * 投稿 ID
  * 言語コード（ja/en/zh）
  * 本文のハッシュ値
* 本文が更新された場合は、ハッシュの違いにより自動的に再生成対象となるよう設計する。

### 6.4.4 エラーハンドリング

* TTS の生成や再生に失敗した場合でも、投稿本文の閲覧は継続可能とする。
* 代表的なエラー例:

  * 音声生成 API エラー
  * ネットワークエラー
* ユーザには「現在音声読み上げを利用できません」程度の簡易メッセージを表示し、

  * その場での再試行（リトライ）ボタンを設けるかどうかは詳細設計で定義する。

---

## 6.5 一般利用者投稿の AI モデレーション（任意）

### 6.5.1 位置づけ

* 掲示板はクローズドなコミュニティ向けであり、AI モデレーションは **必須ではない付加価値機能** として扱う。
* 主な目的は次のとおり。

  * 明らかな誹謗中傷・差別的表現の抑止
  * グレーゾーン投稿への注意喚起
  * 管理組合による対応判断の補助
* 次のようなことは目的としない。

  * 完全な検閲・完全防御
  * 大規模 SNS と同等の精度・運用レベルの実現

### 6.5.2 適用範囲

* 対象ユーザ: 一般利用者（居住者）の投稿
* 対象操作: 新規投稿・自分の投稿の編集
* 対象コンテンツ: タイトル＋本文（必要に応じてカテゴリ情報）
* 管理組合アカウントによる公式投稿は、AI モデレーション対象外とする。

### 6.5.3 振る舞い（概要）

* AI モデレーションを有効化するかどうかは、システム全体またはテナント単位の設定とする（詳細は別資料）。
* 有効化されている場合、投稿保存前に LLM 等で内容を解析し、

  * 「問題なし」「要注意」「投稿不可」など、少数の判定カテゴリに分類して UI の挙動を変える。
* 判定カテゴリに応じた具体的な UI（警告ダイアログ／投稿ブロック／通報連携等）は、

  * AI モデレーション専用設計書にて詳細を定義し、本章では「付加価値として挙動を変えられる」というレベルに留める。

### 6.5.4 ログとプライバシー

* AI モデレーションは、長期的な傾向分析やモデル学習を目的とせず、

  * 投稿時の一時的な判定に限定して利用する。
* 専用の永続ログテーブルを設けて全文を保存することは前提とせず、

  * 必要になった場合のみ、統計情報レベルのログを追加設計する。
* ランタイムログ（Vercel / Supabase 等）に残る情報は、障害調査の補助として扱い、掲示板機能の一次情報源とはみなさない。

### 6.5.5 エラーハンドリング

* モデレーション API がエラーとなる場合でも、投稿自体をブロックしない。
* 代表的なエラー例:

  * ネットワークエラー
  * タイムアウト
  * レートリミット
* エラー時の挙動:

  * ユーザに「現在モデレーション機能を利用できません。投稿はそのまま送信されます。」等の情報メッセージを表示する。
  * モデレーション無しで投稿を保存し、通常どおり掲示板に反映する。

---

## 6.6 共通エラーハンドリング方針

翻訳・TTS・AI モデレーションはいずれも「投稿／閲覧の補助機能」であり、以下の共通方針をとる。

1. **投稿と閲覧が最優先**

   * 補助機能の障害により、投稿の保存や本文の閲覧ができなくなる事態は避ける。

2. **ユーザへの通知は簡潔に**

   * 何が使えないのか（翻訳／読み上げ／モデレーション）がわかる程度のメッセージを表示し、
     技術的な詳細はユーザに見せない。

3. **再試行の余地を残す**

   * 必要に応じて「再試行」ボタンや、翻訳／TTS の再生成ボタンを設け、
     一時的な障害からの回復をユーザ操作で促せるようにする。

詳細なメッセージキー・文言・表示位置は、共通メッセージ仕様および各画面の詳細設計書で定義する。

---

## 6.7 本章まとめ

* 投稿・コメント・添付の基本ルールは ch03〜ch05 に委譲し、本章では最大文字数・添付制限などの共通ルールを再確認した。
* 投稿本文は、保存時に JA/EN/ZH の 3 言語へ自動翻訳し、translation_cache を通じて HOME／BoardTop／BoardDetail から共通利用する。
* 音声読み上げは掲示板画面（主に投稿本文）に限定し、必要に応じて TTS キャッシュを用いることで負荷とレスポンスを両立する。
* AI モデレーションは任意導入の付加価値機能として位置づけ、停止時にも投稿行為を妨げないエラーハンドリングとする。
* これにより、掲示板は「まず安心して使えること」を最優先にしつつ、翻訳・音声・AI を段階的に活用できる設計となる。

---

**Document ID:** SEC-APP-BOARD-DESIGN-002-CH06
**Version:** 2.3
**Created:** 2025-10-27
**Last Updated:** 2025-11-21
**Author:** TKD + GPT (HarmoNet PMO)
