# 掲示板 基本設計書 ch06：主要機能（改訂版 v2.2）

**Document:** 掲示板機能 基本設計書 ch06：主要機能
**Version:** v2.2
**Date:** 2025-11-21
**Author:** TKD / Tachikoma
**Status:** Draft（AIモデレーション仕様反映版）
**Supersedes:** board-design-ch06_v2.1.md

---

## 6.1 本章の目的

本章では、掲示板機能における **主要な振る舞い・共通ルール** を整理する。

* 投稿機能（新規投稿・編集）
* コメント機能
* 添付ファイル（PDF）とプレビュー
* 一般利用者投稿に対する AI モデレーション（付加価値機能）

を中心に、BoardTop / BoardDetail / 新規投稿画面に共通する仕様を基本設計レベルで定義する。

※ 回覧板としての既読管理・通報機能・自動翻訳などの補助機能は、別章（ch07 補助機能）で扱う。

---

## 6.2 投稿機能（新規投稿 / 編集）

### 6.2.1 対象画面

* 掲示板新規投稿画面（BoardNew）
* 自分の投稿編集画面（BoardEdit）

管理組合アカウント・一般利用者（居住者）の両方が利用するが、
利用可能な投稿区分・タグ・参照範囲はユーザ種別により制限される。

### 6.2.2 基本フロー（新規投稿）

1. 利用者が BoardNew 画面を開く。
2. タイトル・本文・タグ・参照範囲・添付ファイル（任意）を入力する。
3. 一般利用者の場合は、投稿前に AI モデレーションを実行する（詳細は 6.5 参照）。
4. モデレーション結果に応じて投稿可否・警告を制御したのち、`board_posts` テーブルに保存する。
5. 保存完了後、BoardDetail 画面へ遷移する。

### 6.2.3 投稿項目（概要）

項目の詳細は ch05（新規投稿画面）で定義し、本章では役割のみを整理する。

* タイトル

  * 一覧カードに表示される主文。必須。
* 本文

  * 投稿内容の本文。必須。
* タグ／カテゴリ

  * NOTICE / RULES などのカテゴリタグ。（雑談用途のタグは設けない）
* 参照範囲

  * GLOBAL（全体） / GROUP（特定グループ）など。GROUP の詳細はテナント設定と連携。
* 添付ファイル

  * PDF のみ許可。複数添付可（上限数・サイズは ch06.4 にて定義）。

---

## 6.3 コメント機能（概要）

詳細仕様は BoardDetail 章で扱うため、本章では共通ルールのみ定義する。

* コメントは BoardDetail 画面から、対象投稿に紐づく形で作成する。
* コメントにもタイトルは持たず、本文のみを扱う（シンプルなレス形式）。
* コメントには添付ファイルは許可しない（MVP）。
* コメントの削除・編集権限は以下のとおりとする：

  * 投稿者本人：自分のコメントのみ編集／削除可（時間制限の有無は詳細設計で決定）。
  * 管理組合：すべてのコメントを削除可能。

---

## 6.4 添付ファイル（PDF）

### 6.4.1 対象と前提

* 添付ファイルは **PDF のみ** を許可する。
* 画像・Office ファイル等は、MVP では添付対象外とする。
* 添付 PDF は、BoardDetail 画面での閲覧を前提とし、BoardTop では「クリップアイコン」で添付の有無のみを表示する。

### 6.4.2 アップロード仕様（MVP）

* 1投稿あたりの添付ファイル数上限: 3 ファイル（目安）。
* 1ファイルあたりのサイズ上限: 10MB 程度（インフラ構成に応じて詳細設計で確定）。
* ファイル形式チェック:

  * 拡張子 `.pdf` のみ許可。
  * 必要に応じて MIME タイプもチェックする。

### 6.4.3 閲覧（PDF プレビュー）

* BoardDetail 画面にて、添付ファイル一覧を表示する。
* ユーザが添付 PDF をタップすると、モーダルで PDF.js によるプレビューを表示する。

  * モーダルの UI・操作仕様は BoardDetail 章にて詳細定義済み（本章では再掲しない）。
* BoardTop 画面では、添付がある投稿のカード右上に「クリップアイコン」を表示し、
  詳細画面に遷移した後に添付ファイルを確認できることを示す。

---

## 6.5 一般利用者投稿の AI モデレーション

### 6.5.1 位置づけと目的

本掲示板は、管理組合および一般利用者（居住者）が利用する **クローズドなコミュニティ** 向けであり、
SNS のような不特定多数向けサービスではない。

本アプリでは、機能上の付加価値および差別化要素として、
**一般利用者の投稿に対してのみ** LLM（大規模言語モデル）による AI モデレーションを導入する。

* 目的:

  * 明らかな誹謗中傷・差別的表現・攻撃的投稿の抑止
  * グレーゾーン投稿への注意喚起
  * 管理組合による対応判断の補助
* 非目的:

  * 完全な検閲・完全防御を行うこと
  * 大規模 SNS と同等の精度・運用レベルを目指すこと

管理組合アカウントによる公式投稿は、AI モデレーションの対象外とし、
人によるレビュー（複数担当者での内容確認）を前提とする。

### 6.5.2 適用範囲

AI モデレーションの適用範囲は次のとおりとする。

* 対象ユーザ:

  * 一般利用者（居住者）
* 対象画面:

  * 掲示板 新規投稿画面
  * 掲示板 投稿編集画面（一般利用者が自分の投稿を編集する場合）
* 対象コンテンツ:

  * 投稿タイトル
  * 投稿本文
  * （必要に応じて）タグ／カテゴリ情報

管理組合アカウントによる投稿・編集は、AI モデレーションを **スキップ** する。

### 6.5.3 判定レベルと挙動（3段階）

AI モデレーションは、LLM による解析結果をもとに、内部的に 3 段階のリスクレベルに分類する。

* **Level 0: 問題なし (OK)**
  明確な問題は検出されない。通常通り投稿を保存し、掲示板に反映する。

* **Level 1: 要注意 (Warning)**
  ハラスメント・攻撃的表現などが含まれる可能性はあるが、即時ブロックするほどではない。
  利用者には投稿前に注意メッセージを表示し、「内容を見直す」か「それでも投稿する」かを選択させる。
  利用者が「投稿する」を選択した場合は、そのまま保存する。

* **Level 2: 投稿拒否 (Block)**
  明確な差別表現・暴言など、運営ポリシー上受け入れられない内容が検出された場合。
  投稿を保存せず、「不適切な表現が含まれているため投稿できません」といったエラーメッセージを表示する。

リスクレベルを算出するための閾値や内部スコアリング（例: 0.0〜1.0）は実装内部の詳細とし、
基本設計レベルでは「3段階のレベルに応じて挙動を変える」ことのみ定義する。

### 6.5.4 ログの扱い

AI モデレーションは、あくまで **付加価値機能** として導入し、
高精度なチューニングや長期的な傾向分析を前提としない。

* モデレーションの判定結果および入力テキストは、
  **専用の永続ログテーブルには保存しない**。
* 判定結果は、その場の投稿可否・警告メッセージ制御にのみ利用する。
* 将来、運用上の必要性が生じた場合に限り、
  リスクレベル等の統計情報を保存する専用テーブルの追加を検討する。

Vercel / Supabase などのランタイムログに残る情報は、
開発・障害調査の補助として扱い、掲示板機能としての一次情報源とはしない。

---

## 6.6 エラーハンドリング（概要）

### 6.6.1 投稿時のエラー

* 必須項目未入力・バリデーションエラー

  * 各入力欄の下にエラーメッセージを表示し、投稿処理は行わない。
* 添付ファイルエラー

  * 許可されていない拡張子／サイズ超過時は、アップロード時点でエラー表示を行い、投稿ボタン押下時に再チェックする。
* AI モデレーション API エラー

  * ネットワークエラー・タイムアウト等によりモデレーションが実行できない場合は、
    「現在モデレーション機能を利用できません。投稿はそのまま送信されます。」等の情報メッセージを表示し、
    モデレーション無しで投稿を保存する。
  * これにより、AI モデレーション機能の障害がユーザの投稿行為を阻害しないようにする。

詳細なメッセージ文言および表示位置は、BoardNew/BoardEdit の詳細設計書で定義する。

---

## 6.7 本章まとめ

* 投稿機能は、タイトル／本文／タグ／参照範囲／PDF 添付を基本要素とし、
  BoardNew/BoardEdit から `board_posts` に保存するフローを共通化する。
* コメント機能は BoardDetail に紐づくレスとして扱い、シンプルな本文のみの構造とする（MVP）。
* 添付ファイルは PDF のみに限定し、BoardDetail で PDF.js によるプレビュー、BoardTop ではクリップアイコン表示のみとする。
* 一般利用者投稿には LLM による AI モデレーションを導入し、
  Level 0/1/2 の 3段階で投稿可否・警告を制御するが、モデレーション結果の専用ログは保持しない。
* AI モデレーションはあくまで「付加価値機能」として設計し、
  機能不全時にも投稿自体は継続できるようにエラーハンドリングを定義する。

---

**End of Document**
