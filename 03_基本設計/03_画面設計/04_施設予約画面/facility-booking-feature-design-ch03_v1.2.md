# Chapter 03: 予約フロー・画面構成

**HarmoNet 施設予約機能 基本設計書**

---

## 改訂履歴

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| v1.0 | 2025-10-29 | TKD + Claude | 初版作成 |
| v1.1 | 2025-11-28 | TKD + Claude | 集会所フロー追加、タブ切替UI、料金除外、マイページ遷移明確化 |
| v1.2 | 2025-12-02 | TKD + Claude | UI方針変更（タブ→ドロップダウン）、ヘッダー簡素化、マルチテナント対応 |

---

## 目次

1. [画面一覧](#1-画面一覧)
2. [画面遷移](#2-画面遷移)
3. [施設予約TOP画面](#3-施設予約top画面)
4. [集会所の予約フロー](#4-集会所の予約フロー)
5. [駐車場の予約フロー](#5-駐車場の予約フロー)
6. [予約確認画面](#6-予約確認画面)
7. [予約詳細画面（マイページ）](#7-予約詳細画面マイページ)

---

## 1. 画面一覧

| 画面ID | 画面名 | 役割 | 遷移元 |
|--------|--------|------|--------|
| FB-01 | 施設予約TOP | 施設ドロップダウン選択、カレンダー表示 | フッター「施設予約」 |
| FB-02 | 時間枠選択（集会所系） | 時間枠選択、使用目的入力 | FB-01（日付選択後） |
| FB-03 | 区画選択（駐車場系） | 配置図表示、区画選択 | FB-01（日付選択後） |
| FB-04 | 予約確認 | 内容確認、注意事項同意、確定 | FB-02 または FB-03 |
| FB-05 | 予約完了 | 完了メッセージ、次のアクション | FB-04（確定後） |
| FB-06 | 予約詳細 | 予約内容表示、変更、キャンセル | マイページのみ |

---

## 2. 画面遷移

### 2.1 全体遷移図

```
フッター「施設予約」
    ↓
┌─────────────────────────────────────┐
│ FB-01 施設予約TOP                    │
│                                      │
│ [施設ドロップダウン選択 ▼]            │
│  ├ 🏠 集会所                         │
│  └ 🚗 ゲスト駐車場                   │
│                                      │
│ 施設情報カード                       │
│ 月カレンダー（日付選択）              │
└─────────────────────────────────────┘
    ↓ 日付選択
    ↓
┌──────────────┐    ┌──────────────┐
│ FB-02        │    │ FB-03        │
│ 時間枠選択    │    │ 区画選択     │
│ （集会所系）  │    │ （駐車場系） │
└──────────────┘    └──────────────┘
    ↓                    ↓
    └────────┬───────────┘
             ↓
┌─────────────────────────────────────┐
│ FB-04 予約確認                       │
│ 予約内容サマリ                       │
│ 注意事項表示                         │
│ 同意チェック                         │
│ [戻る] [予約を確定]                  │
└─────────────────────────────────────┘
             ↓ 確定
┌─────────────────────────────────────┐
│ FB-05 予約完了                       │
│ 完了メッセージ                       │
│ [ホームに戻る] [予約履歴を見る]       │
└─────────────────────────────────────┘
```

### 2.2 マイページからの遷移

```
マイページ
    ↓
予約履歴一覧
    ↓ 予約タップ
┌─────────────────────────────────────┐
│ FB-06 予約詳細                       │
│ 予約情報（施設、日時、目的等）        │
│ ステータス                           │
│ [予約を変更] [この予約をキャンセル]   │
└─────────────────────────────────────┘
```

### 2.3 遷移ルール

- 予約詳細画面（FB-06）はマイページからのみアクセス可能
- 施設予約画面から予約詳細への直接遷移は不可
- 予約完了後は「予約履歴を見る」でマイページへ遷移
- 戻る操作はフッターナビゲーションで行う（ヘッダーに戻るボタンは配置しない）

---

## 3. 施設予約TOP画面

### 3.1 画面構成

```
┌─────────────────────────────────────┐
│                     JA | EN | ZH    │
├─────────────────────────────────────┤
│ [🏠 集会所                      ▼]  │
├─────────────────────────────────────┤
│ 📍 セキュレアステーション            │
│ ・使用時間：9:00-19:00（30分単位）   │
│ ・定員：約30名                       │
│ ・設備：テーブル・椅子・プロジェクター │
│ 📄 利用規約を確認                    │
├─────────────────────────────────────┤
│        2025年12月         < >       │
│ 日  月  火  水  木  金  土           │
│  1   2   3   4   5   6   7          │
│  8   9  10  11  12  13  14          │
│ 15  16  17  18  19  20  21          │
│ ...                                  │
├─────────────────────────────────────┤
│ 🏠    📝    📅    👤    🚪          │
│ホーム 掲示板 施設予約 マイページ ログアウト│
└─────────────────────────────────────┘
```

### 3.2 ヘッダー構成

- 言語切替ボタン（JA/EN/ZH）のみ
- 画面タイトル・戻るボタンは不要

### 3.3 施設選択ドロップダウン

- テナントが保有する施設がドロップダウンの選択肢として表示
- 施設名称は `facilities.facility_name` から取得
- 施設が1つのみの場合もドロップダウン形式（将来の拡張性を考慮）

**ドロップダウン表示例（セキュレア研究学園）:**
```
🏠 集会所
🚗 ゲスト駐車場
```

**ドロップダウン表示例（テナントA）:**
```
🏠 集会室A
🏠 集会室B
🏠 パーティールーム
🚗 来客用駐車場
```

### 3.4 施設情報カード

施設情報カードの表示項目は `facility_settings` から取得する。

**集会所系:**
- 施設名称（ドロップダウンで選択済みのため重複表記しない）
- 利用可能時間帯（`available_from_time` 〜 `available_to_time`）
- 予約単位（`slot_duration_minutes` 分単位）
- 「利用規約を確認」リンク → 掲示板投稿へ

**駐車場系:**
- 区画数（`facility_slots` のレコード数）
- 利用料金（`fee_per_day`）※0円の場合は「無料」表示
- 月間制限（`monthly_limit`）※nullの場合は非表示
- 「利用規約を確認」リンク → 掲示板投稿へ（任意）

### 3.5 カレンダー

- 月カレンダー形式
- 当月〜翌月末を表示（`reservable_until_months` で制御）
- 過去日は非活性
- 日付タップで次画面へ遷移

---

## 4. 集会所の予約フロー

### 4.1 フロー概要

```
1. 施設予約TOP → ドロップダウンで集会所を選択
2. カレンダーで日付選択
3. 時間枠選択画面（FB-02）
   - 時間枠選択（slot_duration_minutes 単位）
   - 使用目的入力（必須）
   - 参加人数入力（任意）
4. 予約確認画面（FB-04）
5. 予約確定 → 完了画面（FB-05）
```

### 4.2 時間枠選択画面（FB-02）

```
┌─────────────────────────────────────┐
│                     JA | EN | ZH    │
├─────────────────────────────────────┤
│ 選択した日付： 2025年12月15日（月）   │
├─────────────────────────────────────┤
│ 開始時刻                             │
│ [10:00 ▼]                           │
│                                      │
│ 終了時刻                             │
│ [12:00 ▼]                           │
├─────────────────────────────────────┤
│ この日の予約状況                      │
│ 13:00-15:00 予約済                   │
│ 17:00-19:00 予約済                   │
├─────────────────────────────────────┤
│ 使用目的（必須）                      │
│ ┌─────────────────────────────────┐ │
│ │                                 │ │
│ └─────────────────────────────────┘ │
│                                      │
│ 参加人数（任意）                      │
│ [    ] 名                           │
├─────────────────────────────────────┤
│ [戻る]              [次へ]          │
└─────────────────────────────────────┘
```

### 4.3 入力項目

時間選択の刻みは `facility_settings.slot_duration_minutes` で制御。

| 項目 | 必須 | 形式 |
|------|------|------|
| 開始時刻 | ○ | slot_duration_minutes 刻み |
| 終了時刻 | ○ | slot_duration_minutes 刻み |
| 使用目的 | ○ | テキスト |
| 参加人数 | - | 数値 |

---

## 5. 駐車場の予約フロー

### 5.1 フロー概要

```
1. 施設予約TOP → ドロップダウンで駐車場を選択
2. カレンダーで日付選択
3. 区画選択画面（FB-03）
   - 配置図表示（テナント固有、オプション）
   - 区画ボタンで空き確認・選択
4. 予約確認画面（FB-04）
5. 予約確定 → 完了画面（FB-05）
```

### 5.2 区画選択画面（FB-03）

```
┌─────────────────────────────────────┐
│                     JA | EN | ZH    │
├─────────────────────────────────────┤
│ 選択した日付： 2025年12月15日（月）   │
├─────────────────────────────────────┤
│ 駐車場配置図                         │
│ ┌─────────────────────────────────┐ │
│ │    つくば市学園の森義務教育学校方面  │ │
│ │       ┌───┐ ┌───┐              │ │
│ │       │ ② │ │ ① │              │ │
│ │       └───┘ └───┘              │ │
│ │    ┌─────────────────┐         │ │
│ │    │    集会所        │         │ │
│ │    └─────────────────┘         │ │
│ │    ┌───┐ ┌───┐ ┌───┐          │ │
│ │    │ ⑥ │ │ ⑤ │ │ ④ │          │ │
│ │    └───┘ └───┘ └───┘          │ │
│ │       ┌───┐ ┌───┐              │ │
│ │       │ ⑧ │ │ ⑦ │              │ │
│ │       └───┘ └───┘              │ │
│ │       研究学園駅方面               │ │
│ └─────────────────────────────────┘ │
├─────────────────────────────────────┤
│ 区画を選択                           │
│ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐   │
│ │ ①  │ │ ②  │ │ ③  │ │ ④  │   │
│ │ 空き │ │ 空き │ │予約済│ │ 空き │   │
│ └─────┘ └─────┘ └─────┘ └─────┘   │
│ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐   │
│ │ ⑤  │ │ ⑥  │ │ ⑦  │ │ ⑧  │   │
│ │ 空き │ │予約済│ │予約済│ │ 空き │   │
│ └─────┘ └─────┘ └─────┘ └─────┘   │
├─────────────────────────────────────┤
│ [戻る]              [次へ]          │
└─────────────────────────────────────┘
```

※ 駐車場配置図はテナント固有の表示であり、配置図がないテナントは区画ボタンのみ表示

### 5.3 区画ボタン

区画ボタンは `facility_slots` から動的に生成。

| 状態 | 表示 | 操作 |
|------|------|------|
| 空き | 緑枠 | タップ可能 |
| 予約済み（他） | グレー | タップ不可 |
| 自分の予約 | 青枠 | タップ可能 |
| 管理者ブロック | 黒 | タップ不可 |

---

## 6. 予約確認画面

### 6.1 画面構成（共通）

```
┌─────────────────────────────────────┐
│                     JA | EN | ZH    │
├─────────────────────────────────────┤
│ 予約内容                             │
│ 🚗 施設                              │
│    ゲスト駐車場 ⑧番                  │
│ 📅 予約日時                          │
│    2025年12月15日（月）終日           │
│ 💰 料金                              │
│    100円/回                          │
│ 👤 申込者                            │
│    住戸番号 B-71                     │
│ 📊 今月の利用回数                     │
│    3回 / 10回                        │
├─────────────────────────────────────┤
│ 📌 ご利用にあたって                   │
│ ・使用後は清掃をお願いします          │
│ ・ゴミは各自でお持ち帰りください       │
│ ・設備の破損・汚損があった場合は      │
│   ご連絡ください                     │
│ ・キャンセルの場合は前日までに        │
│   ご連絡ください                     │
├─────────────────────────────────────┤
│ ☐ 上記の注意事項を確認し、同意します  │
├─────────────────────────────────────┤
│ [戻る]          [予約を確定]         │
└─────────────────────────────────────┘
```

### 6.2 表示項目

**共通:**
- 施設名
- 予約日
- 申込者（住戸番号）

**集会所系の場合:**
- 利用時間（開始〜終了）
- 使用目的
- 参加人数

**駐車場系の場合:**
- 区画番号
- 終日表示
- 料金（`fee_per_day` が0より大きい場合）
- 今月の利用回数（`monthly_limit` がnullでない場合）

### 6.3 注意事項

- 施設タイプ毎に異なる注意事項を表示
- 同意チェック必須
- チェックなしで「予約を確定」押下 → エラー表示

---

## 7. 予約詳細画面（マイページ）

### 7.1 アクセス経路

- マイページ → 予約履歴一覧 → 予約タップ → 予約詳細

### 7.2 画面構成

```
┌─────────────────────────────────────┐
│                     JA | EN | ZH    │
├─────────────────────────────────────┤
│ 予約情報                             │
│ 🏠 施設                              │
│    セキュレアステーション             │
│ 📅 予約日                            │
│    2025年12月15日（月）               │
│ 🕐 利用時間                          │
│    10:00-12:00                       │
│ 📝 使用目的                          │
│    住民懇親会                        │
│ 👥 参加人数                          │
│    20名                             │
│ ✅ ステータス                        │
│    予約確定                          │
│ 📅 予約日時                          │
│    2025/12/01                       │
├─────────────────────────────────────┤
│ ┌─────────────────────────────────┐ │
│ │       ✏️ 予約を変更              │ │
│ └─────────────────────────────────┘ │
│                                      │
│        この予約をキャンセル           │
└─────────────────────────────────────┘
```

### 7.3 操作

| ボタン | 動作 |
|--------|------|
| 予約を変更 | 予約内容の変更画面へ遷移 |
| この予約をキャンセル | キャンセル確認モーダル表示 |

### 7.4 キャンセル条件

- 集会所系: 使用開始時間前までキャンセル可能
- 駐車場系: 前日までキャンセル可能
- 期限を過ぎている場合はキャンセルボタン非活性

---

**Document ID**: HARMONET-FACILITY-BOOKING-DESIGN-001-CH03  
**Status**: 確定版  
**Created**: 2025-10-29  
**Last Updated**: 2025-12-02  
**Version**: v1.2  
**Authors**: TKD + Claude  

---

© 2025 HarmoNet Project. All rights reserved.
