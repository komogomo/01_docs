# Chapter 04: 予約制限ルール・検証

**HarmoNet 施設予約機能 基本設計書**

---

## 改訂履歴

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| v1.0 | 2025-10-29 | TKD + Claude | 初版作成 |
| v1.1 | 2025-11-28 | TKD + Claude | 集会所追加、セキュレア仕様反映、料金・連続予約削除 |

---

## 目次

1. [制限ルール概要](#1-制限ルール概要)
2. [駐車場の制限ルール](#2-駐車場の制限ルール)
3. [集会所の制限ルール](#3-集会所の制限ルール)
4. [バリデーション](#4-バリデーション)
5. [排他制御](#5-排他制御)
6. [キャンセルポリシー](#6-キャンセルポリシー)

---

## 1. 制限ルール概要

### 1.1 設計方針

- 制限ルールは施設タイプ毎に異なる
- テナント毎にカスタマイズ可能（facility_rule テーブル）
- 公平性の確保と運用の安定性を重視

### 1.2 施設タイプ別の制限比較

| 項目 | ゲスト駐車場 | 集会所 |
|------|-------------|--------|
| 予約単位 | 日単位（24時間/回） | 時間単位（30分刻み） |
| 予約可能期間 | 2週間前から | 翌月末まで |
| 月間制限 | 10回/月 | なし |
| キャンセル期限 | 前日まで | 使用開始時間前まで |
| 同時予約制限 | 同日に1件まで | なし |

---

## 2. 駐車場の制限ルール

### 2.1 予約可能期間

| 項目 | 値 |
|------|-----|
| 開始 | 当日から |
| 終了 | 2週間先まで |

**検証タイミング:** カレンダー表示時、予約確定時

### 2.2 月間利用制限

| 項目 | 値 |
|------|-----|
| 上限 | 10回/月 |
| カウント対象 | 確定済み予約（キャンセル分は除外） |

**検証タイミング:** 予約確定時

**エラーメッセージ:**
- JA: 「今月の予約上限（10回）に達しています」
- EN: "Monthly booking limit (10) reached"
- ZH: "本月预订已达上限（10次）"

### 2.3 同日複数予約の制限

| 項目 | 値 |
|------|-----|
| 制限 | 同一ユーザーは同日に1件まで |

**目的:** 駐車場利用の公平性確保

**エラーメッセージ:**
- JA: 「同日に既に予約があります」
- EN: "You already have a booking on this date"
- ZH: "您在当天已有预订"

---

## 3. 集会所の制限ルール

### 3.1 予約可能期間

| 項目 | 値 |
|------|-----|
| 開始 | 当日から |
| 終了 | 翌月末まで |

**検証タイミング:** カレンダー表示時、予約確定時

### 3.2 使用可能時間帯

| 項目 | 値 |
|------|-----|
| 開始 | 9:00 |
| 終了 | 19:00 |
| 単位 | 30分刻み |

**検証タイミング:** 時間枠選択時、予約確定時

### 3.3 時間枠の重複チェック

- 同一日時に複数の予約が重ならないことを検証
- 既存予約と新規予約の時間帯が重複する場合はエラー

**エラーメッセージ:**
- JA: 「選択した時間帯は既に予約されています」
- EN: "The selected time slot is already booked"
- ZH: "所选时间段已被预订"

---

## 4. バリデーション

### 4.1 クライアント側

| 検証項目 | 駐車場 | 集会所 | タイミング |
|---------|--------|--------|-----------|
| 過去日選択 | ○ | ○ | 日付選択時 |
| 予約可能期間 | ○ | ○ | 日付選択時 |
| 区画未選択 | ○ | - | 次へボタン時 |
| 時間枠未選択 | - | ○ | 次へボタン時 |
| 使用目的未入力 | - | ○ | 次へボタン時 |
| 同意チェック | ○ | ○ | 確定ボタン時 |

### 4.2 サーバー側

| 検証項目 | 駐車場 | 集会所 | エラーコード |
|---------|--------|--------|-------------|
| 二重予約 | ○ | ○ | 409 Conflict |
| 同日複数予約 | ○ | - | 422 |
| 月間制限 | ○ | - | 422 |
| 時間帯重複 | - | ○ | 409 Conflict |
| 予約可能期間外 | ○ | ○ | 422 |

---

## 5. 排他制御

### 5.1 二重予約防止

同時に複数ユーザーが同じ施設・日時を予約しようとした場合の防止策。

**方式:** 悲観的ロック（Pessimistic Lock）

**処理フロー:**
1. トランザクション開始
2. 対象施設・日時の行ロック取得
3. 既存予約の有無を確認
4. 予約可能であれば INSERT
5. トランザクションコミット

**採用理由:**
- 予約システムでは「確実な二重予約防止」が最優先
- 楽観的ロックではリトライが必要になりUXが低下

### 5.2 タイムアウト

| 項目 | 値 |
|------|-----|
| ロック取得タイムアウト | 5秒 |
| APIリクエストタイムアウト | 30秒 |

---

## 6. キャンセルポリシー

### 6.1 駐車場

| 項目 | 値 |
|------|-----|
| キャンセル可能期限 | 前日まで |
| 当日キャンセル | 不可 |

**エラーメッセージ:**
- JA: 「当日のキャンセルはできません」
- EN: "Same-day cancellation is not allowed"
- ZH: "当天无法取消"

### 6.2 集会所

| 項目 | 値 |
|------|-----|
| キャンセル可能期限 | 使用開始時間前まで |
| 使用開始後 | 不可 |

**エラーメッセージ:**
- JA: 「利用開始後のキャンセルはできません」
- EN: "Cannot cancel after the booking start time"
- ZH: "预订开始后无法取消"

### 6.3 キャンセル処理

1. キャンセル可能期限のチェック
2. 予約ステータスを「キャンセル済み」に更新
3. キャンセル日時を記録
4. キャンセル完了通知（メール）

---

**Document ID**: HARMONET-FACILITY-BOOKING-DESIGN-001-CH04  
**Status**: 確定版  
**Created**: 2025-10-29  
**Last Updated**: 2025-11-28  
**Version**: v1.1  
**Authors**: TKD + Claude  

---

© 2025 HarmoNet Project. All rights reserved.
