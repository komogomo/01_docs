# Chapter 02: 施設構造・データモデル

**HarmoNet 施設予約機能 基本設計書**

---

## 改訂履歴

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| v1.0 | 2025-10-29 | TKD + Claude | 初版作成 |
| v1.1 | 2025-11-28 | TKD + Claude | テナント可変構造明確化、利用規約の掲示板連携追加 |
| v1.2 | 2025-11-29 | TKD + Claude | 予約データ構造にschema.prisma整合カラム追加、料金設定方針明確化 |

---

## 目次

1. [施設マスタ構造](#1-施設マスタ構造)
2. [施設タイプ分類](#2-施設タイプ分類)
3. [ルール定義層](#3-ルール定義層)
4. [予約データ構造](#4-予約データ構造)
5. [利用規約の掲示板連携](#5-利用規約の掲示板連携)
6. [データ関係図](#6-データ関係図)

---

## 1. 施設マスタ構造

### 1.1 テナント毎の施設構成

施設構成はテナント（管理組合）毎に完全に異なる。

**テナント毎に変わる項目:**

| 施設タイプ | 可変項目 |
|-----------|---------|
| 集会所系 | 施設名称、施設数、使用時間帯、予約単位、定員 |
| 駐車場系 | 駐車場名称、台数、区画番号 |

**構成例:**

| テナント | 集会所系 | 駐車場系 |
|---------|---------|---------|
| セキュレア研究学園 | セキュレアステーション 1室 | ゲスト駐車場 8台（①〜⑧） |
| テナントA | 集会室 2室、パーティールーム 1室 | 来客用駐車場 20台（A1〜A10, B1〜B10） |
| テナントB | 多目的室 1室 | ゲスト駐車場 5台（1〜5） |

### 1.2 施設マスタの管理単位

- すべての施設マスタは `tenant_id` で分離
- テナント管理者が自テナントの施設を登録・編集
- 施設名称、区画番号等は自由入力

---

## 2. 施設タイプ分類

### 2.1 大分類

| タイプ | 予約単位 | 特徴 |
|--------|---------|------|
| 集会所系 | 時間単位（30分刻み等） | 使用目的・参加人数の入力あり |
| 駐車場系 | 日単位 | 区画選択のみ |

### 2.2 集会所系の例

- 集会室
- パーティールーム
- 多目的室
- ゲストルーム
- スカイラウンジ

### 2.3 駐車場系の例

- ゲスト用駐車場
- 来客用駐車場
- バイク駐車場

---

## 3. ルール定義層

### 3.1 設計思想

施設タイプ毎の違いは「ルール定義」で吸収する。
コード変更なしで、テナント毎に異なるルールを設定可能。

### 3.2 ルール定義項目

| 項目 | 説明 | 例 |
|------|------|-----|
| 予約単位 | 日単位 / 時間単位 | day / hour |
| 最小予約単位 | 最低予約数 | 30分、1日 |
| 最大予約単位 | 1回あたりの上限 | 4時間、3日 |
| 使用可能時間帯 | 開始〜終了時刻 | 9:00-19:00 |
| 予約可能期間 | 何日先まで予約可能か | 2週間前、翌月末 |
| キャンセル期限 | いつまでキャンセル可能か | 前日、使用開始前 |
| 月間制限 | 月あたりの利用上限 | 10回/月 |
| 承認要否 | 管理者承認が必要か | 不要 / 必要 |
| 利用料金 | 施設利用料（テナント毎に設定） | 無料、100円/日、500円/時間 |
| 料金単位 | 日単位 / 時間単位 | day / hour |

※ 料金設定はテナント毎に可能。決済機能は本フェーズでは対象外。

### 3.3 セキュレア研究学園のルール設定

**ゲスト駐車場:**

| 項目 | 設定値 |
|------|--------|
| 予約単位 | day |
| 使用時間 | 24時間/回 |
| 月間制限 | 10回/月 |
| 予約可能期間 | 2週間前から |
| キャンセル期限 | 前日まで |
| 承認要否 | 不要 |

**集会所:**

| 項目 | 設定値 |
|------|--------|
| 予約単位 | hour（30分刻み） |
| 使用可能時間帯 | 9:00-19:00 |
| 月間制限 | なし |
| 予約可能期間 | 翌月末まで |
| キャンセル期限 | 使用開始時間前まで |
| 承認要否 | 不要 |

---

## 4. 予約データ構造

### 4.1 予約テーブル（facility_reservations）

| カラム | 型 | 説明 | 必須 |
|--------|-----|------|------|
| id | UUID | 予約ID | ○ |
| tenant_id | UUID | テナントID | ○ |
| facility_id | UUID | 施設ID | ○ |
| slot_id | UUID | 区画ID（駐車場の場合） | - |
| user_id | UUID | 予約者ID | ○ |
| start_at | DateTime | 開始日時 | ○ |
| end_at | DateTime | 終了日時 | ○ |
| purpose | String | 使用目的（集会所系は必須） | △ |
| participant_count | Int | 参加人数（集会所系、任意） | - |
| status | Enum | pending / confirmed / canceled | ○ |
| created_at | DateTime | 作成日時 | ○ |
| updated_at | DateTime | 更新日時 | ○ |

※ `purpose`, `participant_count` は schema.prisma に追加が必要

### 4.2 施設タイプ別の入力項目

| 項目 | 駐車場 | 集会所 |
|------|--------|--------|
| 区画選択（slot_id） | ○ | - |
| 開始日時（start_at） | ○（日付のみ） | ○（時刻含む） |
| 終了日時（end_at） | ○（日付のみ） | ○（時刻含む） |
| 使用目的（purpose） | - | ○（必須） |
| 参加人数（participant_count） | - | △（任意） |

### 4.3 ステータス遷移

```
予約作成 → pending → confirmed → (利用完了)
                        ↓
                    canceled
```

| ステータス | 説明 |
|-----------|------|
| pending | 予約申請中（承認待ち、または確定処理中） |
| confirmed | 予約確定 |
| canceled | キャンセル済み |

- 承認フローは現時点では不要（将来実装）
- 承認不要の場合は pending → confirmed を自動遷移

---

## 5. 利用規約の掲示板連携

### 5.1 方針

- 施設予約画面内に詳細な利用規約は持たない
- 掲示板の「ルール・規則」カテゴリに投稿 → 自動で3言語翻訳
- 施設予約画面からはリンクのみ表示

### 5.2 画面表示

**施設情報カード:**
- 施設名称
- 基本情報（使用時間、定員等）
- 「利用規約を確認」リンク → 掲示板の該当投稿へ遷移

### 5.3 メリット

- 利用規約の多言語対応は掲示板の翻訳機能で自動化
- 規約変更時は掲示板投稿を編集するだけ
- 施設予約機能の実装がシンプルになる

---

## 6. データ関係図

### 6.1 主要エンティティ（schema.prisma準拠）

```
tenants (テナント)
  │
  ├── facilities (施設マスタ)
  │     ├── facility_settings (ルール設定: 1:1)
  │     ├── facility_slots (区画: 駐車場の場合)
  │     └── facility_blocked_ranges (ブロック期間)
  │
  └── facility_reservations (予約データ)
        └── users (予約者)
```

### 6.2 関係性

| 関係 | 説明 |
|------|------|
| tenants → facilities | 1テナントは複数の施設を持つ |
| facilities → facility_settings | 1施設は1つのルール設定を持つ（1:1） |
| facilities → facility_slots | 1施設は複数の区画を持つ（駐車場） |
| facilities → facility_blocked_ranges | 1施設は複数のブロック期間を持つ |
| facilities → facility_reservations | 1施設は複数の予約を受ける |
| users → facility_reservations | 1ユーザーは複数の予約を持つ |

---

**Document ID**: HARMONET-FACILITY-BOOKING-DESIGN-001-CH02  
**Status**: 確定版  
**Created**: 2025-10-29  
**Last Updated**: 2025-11-29  
**Version**: v1.2  
**Authors**: TKD + Claude  

---

© 2025 HarmoNet Project. All rights reserved.
