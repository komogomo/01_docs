# システム管理者向けテナント管理・テナント管理者管理 基本設計書（ドラフト）

## 1. 概要

### 1.1 目的

本書は、システム管理者（system_admin）が利用する以下の機能について、画面構成と振る舞いを定義する。

* テナント一覧表示・選択
* テナントの新規作成・更新・削除
* テナント管理者ユーザ一覧表示（テナント単位）
* テナント管理者ユーザの新規登録・更新・削除

本機能は、一般利用者・テナント管理者が利用する t-admin とは独立した「システム管理専用 UI」として提供する。

### 1.2 前提・制約

* 認証は既存の MagicLink 認証を利用する。
* `system_admin` 権限は TKD が DB 上で直接付与する。画面上から付与・削除する機能は実装しない。
* `system_admin` ロールを持つユーザでログインした場合のみ、本書で定義する画面群にアクセスできる。
* システム管理画面で扱う対象は以下に限定する：

  * `tenants` テーブル
  * 対象テナントに紐づくテナント管理者ユーザ（`users` / `user_tenants` / `user_roles`）
* 一般ユーザや通常の t-admin 機能（掲示板・翻訳・その他設定）は本書の対象外とする。

---

## 2. 画面一覧

| 画面ID  | 画面名               | URL（案）                                          | 概要                         |
| ----- | ----------------- | ----------------------------------------------- | -------------------------- |
| SA-01 | システム管理ホーム（テナント一覧） | `/sys-admin/tenants`                            | テナント一覧表示・選択、新規テナント作成入口     |
| SA-02 | テナント詳細・編集         | `/sys-admin/tenants/{tenantId}`                 | 単一テナントの基本情報表示・編集、管理者一覧への遷移 |
| SA-03 | テナント管理者一覧         | `/sys-admin/tenants/{tenantId}/admins`          | 指定テナントに紐づくテナント管理者ユーザの一覧表示  |
| SA-04 | テナント管理者新規登録       | `/sys-admin/tenants/{tenantId}/admins/new`      | 指定テナントの管理者ユーザ新規登録          |
| SA-05 | テナント管理者編集         | `/sys-admin/tenants/{tenantId}/admins/{userId}` | 指定テナントの管理者ユーザの属性・権限編集      |

---

## 3. 画面遷移

1. system_admin 権限を持つユーザがログイン
2. ログイン後遷移：`/sys-admin/tenants`（SA-01）
3. SA-01 からの遷移：

   * 行選択（テナント名クリックなど） → SA-02 `/sys-admin/tenants/{tenantId}`
   * 「新規テナント作成」ボタン → SA-02 を新規モードで表示（`{tenantId}` なし / `new` モード）
4. SA-02 からの遷移：

   * 「管理者一覧へ」ボタン → SA-03 `/sys-admin/tenants/{tenantId}/admins`
   * 「戻る」→ SA-01 `/sys-admin/tenants`
5. SA-03 からの遷移：

   * 「新規管理者登録」ボタン → SA-04 `/sys-admin/tenants/{tenantId}/admins/new`
   * 行の「編集」ボタン → SA-05 `/sys-admin/tenants/{tenantId}/admins/{userId}`
   * 「テナント詳細へ戻る」→ SA-02 `/sys-admin/tenants/{tenantId}`
6. SA-04 / SA-05 からの遷移：

   * 「保存」成功時 → SA-03 に戻る
   * 「キャンセル」→ SA-03 に戻る

---

## 4. 画面要件

### 4.1 共通レイアウト方針

* 既存 HarmoNet の PC 向け管理画面レイアウトに準拠する。
* ヘッダー：アプリ共通 AppHeader を利用。
* コンテンツ：左右余白のある 1 カラムレイアウト。
* フッター：共通フッター（AppFooter）を利用。
* 画面タイトルは左上に論理名称で表示（例：「テナント一覧」「テナント詳細」「テナント管理者一覧」）。
* ボタン類は右寄せ（新規作成・保存・キャンセルなど）。

---

### 4.2 SA-01 システム管理ホーム（テナント一覧）

#### 4.2.1 レイアウト概要

* 画面タイトルエリア

  * タイトル：「テナント一覧」
  * 右側に「新規テナント作成」ボタン
* テーブルエリア

  * テナント一覧テーブル（ページングあり想定）

#### 4.2.2 テーブル列定義（論理名称）

| 表示順 | 論理名称    | 説明                | 備考               |
| --- | ------- | ----------------- | ---------------- |
| 1   | テナントコード | テナントを一意に識別するコード   | クリックでテナント詳細へ遷移   |
| 2   | テナント名   | テナントの論理名称         |                  |
| 3   | タイムゾーン  | テナントの基準タイムゾーン     |                  |
| 4   | 状態      | active / inactive | 表示は「有効」「無効」など日本語 |
| 5   | 作成日時    | テナント作成日時          | 読み取り専用           |

※ 物理カラム名（例：`tenant_code`, `tenant_name` 等）は詳細設計書の項目対応表で定義。

#### 4.2.3 操作

* 「新規テナント作成」ボタン

  * クリックで SA-02 を新規モードで表示。
* テーブル行クリック（テナントコード or テナント名）

  * 対象テナントの SA-02 に遷移。

---

### 4.3 SA-02 テナント詳細・編集

#### 4.3.1 レイアウト概要

* 画面タイトルエリア

  * タイトル：「テナント詳細」
  * 右上ボタン：

    * 「保存」（更新用）
    * 「削除」または「無効化」（仕様確定次第）
* テナント情報フォーム

  * 1 カラム or 2 カラムのフォームレイアウト
* 下部ボタン

  * 「管理者一覧へ」ボタン
  * 「一覧に戻る」ボタン

#### 4.3.2 入力項目（論理名称）

| 項目ID | 論理名称    | 必須 | 編集可否     | 備考                |
| ---- | ------- | -- | -------- | ----------------- |
| F-01 | テナントコード | 必須 | 新規時のみ編集可 | 更新時は非活性表示         |
| F-02 | テナント名   | 必須 | 常に編集可    | 桁数上限あり            |
| F-03 | タイムゾーン  | 必須 | 常に編集可    | プルダウン選択           |
| F-04 | 状態      | 必須 | 常に編集可    | active / inactive |

#### 4.3.3 バリデーション概要

* テナントコード

  * 必須、桁数上限、使用可能文字種（英数字と一部記号など）
* テナント名

  * 必須、桁数上限
* タイムゾーン

  * プルダウンからの選択必須
* 状態

  * 定義済みの値のみ（active / inactive）

※ 詳細な桁数・文字種は詳細設計で定義。

#### 4.3.4 操作

* 「保存」ボタン

  * 新規モード：`tenants` に INSERT。
  * 更新モード：`tenants` の当該レコードを UPDATE。
* 「削除」または「無効化」ボタン

  * 状態を inactive に変更する想定（物理削除は行わない案を推奨）。
* 「管理者一覧へ」ボタン

  * SA-03 `/sys-admin/tenants/{tenantId}/admins` へ遷移。
* 「一覧に戻る」ボタン

  * SA-01 `/sys-admin/tenants` へ遷移。

---

### 4.4 SA-03 テナント管理者一覧

#### 4.4.1 レイアウト概要

* 画面タイトルエリア

  * タイトル：「テナント管理者一覧」
  * サブタイトルとして対象テナント名を表示（例：「テナント：◯◯マンション」）
  * 右上に「新規管理者登録」ボタン
* テーブルエリア

  * 対象テナントの管理者ユーザ一覧

#### 4.4.2 テーブル列定義（論理名称）

| 表示順 | 論理名称    | 説明                | 備考                      |
| --- | ------- | ----------------- | ----------------------- |
| 1   | メールアドレス | ログインに利用するメール      | 主キー相当の識別                |
| 2   | 表示名     | 画面上での表示名          | `users.display_name` 相当 |
| 3   | 状態      | active / inactive | このテナントにおける状態            |
| 4   | 最終ログイン  | 最終ログイン日時（任意）      | 取得可能な範囲で                |

#### 4.4.3 操作

* 「新規管理者登録」ボタン

  * SA-04 へ遷移。
* 行の「編集」ボタン

  * SA-05 へ遷移。
* 行の「削除」ボタン

  * 当該テナントに対する tenant_admin ロールおよび `user_tenants` の関係を削除 or 無効化（詳細は DB 設計と合わせて定義）。
* 「テナント詳細へ戻る」ボタン

  * SA-02 へ遷移。

---

### 4.5 SA-04 テナント管理者新規登録

#### 4.5.1 レイアウト概要

* タイトル：「テナント管理者登録」
* 対象テナント名をサブタイトル表示
* フォームは t-admin のユーザ登録画面と同じ構成を基本とする。

#### 4.5.2 入力項目（論理名称・例）

| 項目ID | 論理名称    | 必須 | 備考                  |
| ---- | ------- | -- | ------------------- |
| U-01 | メールアドレス | 必須 | Supabase Auth ユーザキー |
| U-02 | 表示名     | 必須 | 画面表示用               |
| U-03 | 氏名      | 任意 | 必要に応じて              |
| U-04 | 状態      | 必須 | active / inactive   |

※ t-admin 側のユーザ登録仕様に合わせて最終確定。

#### 4.5.3 バリデーション概要

* メールアドレス：形式チェック、桁数上限
* 表示名：必須、桁数上限
* 氏名：桁数上限
* 状態：定義値のみ

#### 4.5.4 挙動

* 登録時のパターン分岐：

  * 既存メールアドレスの場合：

    * Supabase Auth / `users` は既存レコードを利用。
    * `user_tenants` に (user_id, tenantId) を追加。
    * `user_roles` に tenant_admin ロールを追加。
  * 新規メールアドレスの場合：

    * Supabase Auth にユーザ新規作成。
    * `users` に INSERT。
    * `user_tenants` に (user_id, tenantId)。
    * `user_roles` に tenant_admin ロール追加。

* 「保存」ボタン成功時 → SA-03 に戻る。

* 「キャンセル」ボタン → SA-03 に戻る（DB 更新なし）。

---

### 4.6 SA-05 テナント管理者編集

#### 4.6.1 レイアウト概要

* タイトル：「テナント管理者編集」
* 対象テナント名＋対象ユーザのメールアドレス／表示名を見出しに表示。
* 入力フォーム構成は SA-04 と同等。

#### 4.6.2 編集可能項目

* 表示名
* 氏名
* 状態（active / inactive）

メールアドレスは識別子のため原則変更不可とし、変更が必要な場合は別途運用で対応（仕様として明記）。

#### 4.6.3 操作

* 「保存」ボタン

  * `users` の対象項目更新（表示名・氏名など）。
  * 当該テナントにおける状態（必要なら `user_tenants` 側の status）更新。
* 「管理者ロール解除」ボタン（実装する場合）

  * `user_roles` の tenant_admin ロールを削除 or 無効化。
* 「キャンセル」ボタン

  * SA-03 に戻る。

---

## 5. 権限制御（概要）

* `/sys-admin/*` 配下の画面・API は、`user_roles` 等を用いて system_admin 権限を必須とする。
* テナント ID による RLS は基本的に適用せず、「システム全体を扱う」という前提で設計する。
* テナント管理者ユーザ一覧・登録・編集は、常に URL の `{tenantId}` を明示し、その ID に対してのみ操作を行う。

---

## 6. 今後詳細設計で詰める項目

* 各項目の物理カラム名との対応表
* 桁数・型・使用可能文字種（バリデーション仕様）
* 状態値の正確な定義（active / inactive 以外が必要かどうか）
* 削除ボタンの挙動（論理削除か、status 変更かの最終決定）
* Supabase Auth / Prisma 実装方針との整合（API 境界、RLS ポリシー等）

本基本設計を前提として、詳細設計書および Windsurf 用作業指示書で項目定義・バリデーション・API I/F を具体化する。
