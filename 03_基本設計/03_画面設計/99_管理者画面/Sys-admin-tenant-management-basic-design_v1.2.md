# システム管理者向けテナント管理・テナント管理者管理 基本設計書（ドラフト v1.2）

## 1. 概要

### 1.1 目的

本書は、システム管理者（system_admin）が利用する以下の機能について、画面構成と振る舞いを定義する。

* テナント一覧表示・選択
* テナントの新規作成・更新・無効化（削除相当）
* テナント管理者ユーザ一覧表示（テナント単位）
* テナント管理者ユーザの新規登録・更新・削除（または管理者ロール解除）

本機能は、一般利用者・テナント管理者が利用する t-admin とは独立した「システム管理専用 UI」として提供する。:contentReference[oaicite:0]{index=0}  

### 1.2 前提・制約

* 認証は既存の MagicLink 認証を利用する。
* ログイン入口は以下の 2 系統に分離する：
  * 一般利用者・テナント管理者向け: `/login`
  * システム管理者向け: `/sys-admin/login`
* `/login` でログインしたユーザは、テナント内の画面（HOME・t-admin 等）のみ利用できる。`/sys-admin/*` への導線は提供しない。
* `/sys-admin/login` でログインした system_admin ユーザは、テナント内画面には遷移せず、本書で定義するシステム管理専用画面（SA-00〜SA-05）のみ利用できる。
* system_admin 権限は TKD が DB 上で直接付与する。画面上から付与・削除する機能は実装しない。:contentReference[oaicite:1]{index=1}  
* system_admin 権限は、`user_roles` テーブルにおける以下のレコードで表現する：

  * `role_scope = 'system'`
  * `role_code = 'system_admin'`
* system_admin ユーザは、システム管理専用のダミーテナント（例: `tenant_code = 'SYSTEM'`）に所属させる。
  * `user_roles.tenant_id` にはこのダミーテナントの `tenants.id` を設定する。
  * system_admin 権限の判定では tenant_id を参照せず、`role_scope` / `role_code` のみを用いる。
* `system_admin` ロールを持つユーザでログインした場合のみ、本書で定義する画面群にアクセスできる。
* システム管理画面で扱う対象は以下に限定する：

  * `tenants` テーブル（テナントの基本属性と状態）
  * 対象テナントに紐づくテナント管理者ユーザ  
    * `users` / `user_roles` の既存モデルを t-admin と共通で利用する
* テナント管理者ユーザについて「このテナントにおける有効／無効」の状態フラグは設けず、「管理者である／ない」は tenant_admin ロールの有無（該当 `user_roles` レコードの存在）で表現する。
* `user_tenants` は掲示板既読管理等で利用されるが、本機能のロジックおよび画面表示では利用しない（テナント所属は `users.tenant_id` を正とする）。
* ユーザとテナントの関係は「1ユーザ = 1テナント」とし、複数テナント所属はサポートしない。
* 一般ユーザや通常の t-admin 機能（掲示板・翻訳・その他設定）は本書の対象外とする。:contentReference[oaicite:2]{index=2}  

### 1.3 DB アクセスと認証・認可方針

* `/sys-admin/*` 配下の画面・API は、`system_admin` 権限を必須とする。
* **認証・認可ガードには、共通基盤（Middleware + Server Helper）を利用する。**
  * Middleware (`proxy.ts`) による一次ガードで、未認証・未認可ユーザをリダイレクトする。
  * Server Helper (`systemAdminAuth.ts`) による二次ガードで、API や Server Component 内での厳密な権限チェックを行う。
* DB アクセスは、原則としてアプリケーションから Supabase クライアント経由で行い、RLS により `system_admin` のみが全テナントを参照・更新できるようにする。
* 必要に応じて service_role を利用する場合でも、アプリケーション側で `system_admin` チェックを必須とし、誤操作範囲を極小化する。:contentReference[oaicite:3]{index=3}  

---

## 2. 画面一覧

| 画面ID  | 画面名                           | URL（案）                                          | 概要                         |
|--------|----------------------------------|----------------------------------------------------|------------------------------|
| SA-00  | システム管理ログイン             | `/sys-admin/login`                                 | system_admin 専用ログイン画面 |
| SA-01  | システム管理ホーム（テナント一覧） | `/sys-admin/tenants`                               | テナント一覧表示・選択、新規テナント作成入口 |
| SA-02  | テナント詳細・編集               | `/sys-admin/tenants/{tenantId}`                    | 単一テナントの基本情報表示・編集、管理者一覧への遷移 |
| SA-03  | テナント管理者一覧               | `/sys-admin/tenants/{tenantId}/admins`             | 指定テナントに紐づくテナント管理者ユーザの一覧表示 |
| SA-04  | テナント管理者新規登録           | `/sys-admin/tenants/{tenantId}/admins/new`         | 指定テナントの管理者ユーザ新規登録 |
| SA-05  | テナント管理者編集               | `/sys-admin/tenants/{tenantId}/admins/{userId}`    | 指定テナントの管理者ユーザの属性・権限編集 |

（SA-01〜SA-05 の内容は v1.0 から変更なし。SA-00 を新規追加。）:contentReference[oaicite:4]{index=4}  

---

## 3. 画面遷移

1. system_admin 権限を持つユーザが `/sys-admin/login` からログイン。
2. ログイン後遷移：`/sys-admin/tenants`（SA-01）。:contentReference[oaicite:5]{index=5}  
3. SA-01 からの遷移：

   * 行選択（テナント名クリックなど） → SA-02 `/sys-admin/tenants/{tenantId}`
   * 「新規テナント作成」ボタン → SA-02 を新規モードで表示（`{tenantId}` なし / `new` モード）
4. SA-02 からの遷移：

   * 「管理者一覧へ」ボタン → SA-03 `/sys-admin/tenants/{tenantId}/admins`
   * 「戻る」→ SA-01 `/sys-admin/tenants`
5. SA-03 からの遷移：

   * 「新規管理者登録」ボタン → SA-04 `/sys-admin/tenants/{tenantId}/admins/new`
   * 行の「編集」ボタン → SA-05 `/sys-admin/tenants/{tenantId}/admins/{userId}`
   * 「テナント詳細へ戻る」→ SA-02 `/sys-admin/tenants/{tenantId}`
6. SA-04 / SA-05 からの遷移：

   * 「保存」成功時 → SA-03 に戻る
   * 「キャンセル」→ SA-03 に戻る

※ テナント側（`/login` 経由）の画面から `/sys-admin/*` への遷移は設計上存在しない。system_admin は常に `/sys-admin/login` からシステム管理専用モードとしてログインする。

---

## 4. 画面要件

### 4.1 共通レイアウト方針

* 既存 HarmoNet の PC 向け管理画面レイアウトに準拠する。
* ヘッダー：アプリ共通 AppHeader を利用。
* コンテンツ：左右余白のある 1 カラムレイアウト。
* フッター：共通フッター（AppFooter）を利用。
* 画面タイトルは左上に論理名称で表示（例：「テナント一覧」「テナント詳細」「テナント管理者一覧」）。
* ボタン類は右寄せ（新規作成・保存・キャンセルなど）。:contentReference[oaicite:6]{index=6}  

---

### 4.2 SA-01 システム管理ホーム（テナント一覧）

#### 4.2.1 レイアウト概要

* 画面タイトルエリア
  * タイトル：「テナント一覧」
  * 右側に「新規テナント作成」ボタン
* テーブルエリア
  * テナント一覧テーブル（ページングあり想定）

#### 4.2.2 テーブル列定義（論理名称）

| 表示順 | 論理名称      | 説明                         | 備考                                      |
|--------|---------------|------------------------------|-------------------------------------------|
| 1      | テナントコード | テナントを一意に識別するコード | クリックでテナント詳細へ遷移               |
| 2      | テナント名     | テナントの論理名称           |                                           |
| 3      | タイムゾーン   | テナントの基準タイムゾーン   |                                           |
| 4      | 状態           | active / inactive            | 表示は「有効」「無効」など日本語（tenants.status） |
| 5      | 作成日時       | テナント作成日時             | 読み取り専用                              |

※ 物理カラム名（例：`tenant_code`, `tenant_name` 等）は詳細設計書の項目対応表で定義。:contentReference[oaicite:7]{index=7}  

#### 4.2.3 操作

* 「新規テナント作成」ボタン
  * クリックで SA-02 を新規モードで表示。
* テーブル行クリック（テナントコード or テナント名）
  * 対象テナントの SA-02 に遷移。

---

### 4.3 SA-02 テナント詳細・編集

（4.3.1〜4.3.4 は v1.0 のまま。ここではログイン分離と権限制御に関わる変更はないため、内容はそのままとする。）

※ もともと重複していた F-01〜F-04 の表とバリデーション説明は、将来的に詳細設計で一元化するが、本基本設計では削除せず残す。

---

### 4.4 SA-03 テナント管理者一覧

#### 4.4.1 レイアウト概要

* 画面タイトルエリア

  * タイトル：「テナント管理者一覧」
  * サブタイトルとして対象テナント名を表示（例：「テナント：◯◯マンション」）
  * 右上に「新規管理者登録」ボタン
* テーブルエリア

  * 対象テナントの管理者ユーザ一覧

#### 4.4.2 テーブル列定義（論理名称）

テナント管理者の「状態（有効／無効）」フラグは持たず、tenant_admin ロールを持つかどうかのみで管理者であることを表現する。

| 表示順 | 論理名称       | 説明                      | 備考                            |
|--------|----------------|---------------------------|---------------------------------|
| 1      | メールアドレス | ログインに利用するメール | 主キー相当の識別（変更不可）   |
| 2      | 表示名         | 画面上での表示名         | `users.display_name` 相当       |
| 3      | 最終ログイン   | 最終ログイン日時（任意） | 取得可能な範囲で（存在しない場合は空欄） |

#### 4.4.3 操作

* 「新規管理者登録」ボタン
  * SA-04 へ遷移。
* 行の「編集」ボタン
  * SA-05 へ遷移。
* 行の「削除」または「管理者ロール解除」ボタン
  * 当該テナントに対する tenant_admin ロール（`user_roles` の該当レコード）を削除する。  
    ユーザ（`users` レコード）自体は削除しない。
* 「テナント詳細へ戻る」ボタン
  * SA-02 へ遷移。

---

### 4.5 SA-04 テナント管理者新規登録

#### 4.5.1 レイアウト概要

* タイトル：「テナント管理者登録」
* 対象テナント名をサブタイトル表示
* フォームは t-admin のユーザ登録画面と同じ構成を基本とする（`users` / `user_roles` モデルを共有）。

#### 4.5.2 入力項目（論理名称・例）

| 項目ID | 論理名称       | 必須 | 備考                        |
|--------|----------------|------|-----------------------------|
| U-01   | メールアドレス | 必須 | Supabase Auth ユーザキー    |
| U-02   | 表示名         | 必須 | 画面表示用                  |
| U-03   | 氏名           | 任意 | 必要に応じて（フルネーム） |

※ 状態（有効／無効）の概念は持たず、「管理者である／ない」は tenant_admin ロールの有無で表現する。:contentReference[oaicite:8]{index=8}  

#### 4.5.3 バリデーション概要

* メールアドレス：形式チェック、桁数上限
* 表示名：必須、桁数上限
* 氏名：桁数上限

#### 4.5.4 挙動

* 登録時のパターン分岐：

  * 既存メールアドレスの場合：

    * Supabase Auth / `users` は既存レコードを利用。
    * `users.tenant_id` が対象テナントと異なる場合はエラーとし、「別テナントに所属しているユーザは管理者として追加できません。」等のメッセージを返す（1ユーザ=1テナント前提）。
    * `users.tenant_id` が同一であれば users はそのまま利用し、`user_roles` に tenant_admin ロールを追加する。
    * **併せて `general_user` ロールも追加する（テナント管理者は一般ユーザとしての機能も利用可能とするため）。**
  * 新規メールアドレスの場合：

    * Supabase Auth にユーザ新規作成。
    * `users` に INSERT（tenant_id に対象テナントを設定。`group_code` / `residence_code` 等はダミー値を設定する方針は詳細設計側で定義）。
    * `user_roles` に tenant_admin ロールを追加。
    * **`user_roles` に general_user ロールを追加。**

* 「保存」ボタン成功時 → SA-03 に戻る。
* 「キャンセル」ボタン → SA-03 に戻る（DB 更新なし）。

---

### 4.6 SA-05 テナント管理者編集

#### 4.6.1 レイアウト概要

* タイトル：「テナント管理者編集」
* 対象テナント名＋対象ユーザのメールアドレス／表示名を見出しに表示。
* 入力フォーム構成は SA-04 と同等。

#### 4.6.2 編集可能項目

* 表示名
* 氏名

メールアドレスは Supabase Auth およびログイン識別子として利用するため、原則変更不可とする。メールアドレス変更が必要な場合は、運用として「新メールアドレスでユーザを新規登録し、旧ユーザを管理者から外す」フローを取る（アプリ上ではメール変更 UI を提供しない）。:contentReference[oaicite:9]{index=9}  

#### 4.6.3 操作

* 「保存」ボタン
  * `users` の対象項目更新（表示名・氏名など）。
* 「管理者ロール解除」ボタン
  * `user_roles` の tenant_admin ロールを削除する（当該テナントにおける管理者権限を解除）。
* 「キャンセル」ボタン
  * SA-03 に戻る。

---

## 5. 権限制御（概要）

* `/sys-admin/*` 配下の画面・API は、`user_roles` テーブルにおいて `role_scope = 'system'` かつ `role_code = 'system_admin'` を持つユーザのみアクセス可能とする。
* `/sys-admin/login` 経由でログインしたセッションに対してのみ、`/sys-admin/*` へのルーティングを許可する。
* 住民／テナント向けの `/login` セッションからは、`/sys-admin/*` への遷移リンクやメニューは表示しない。
* **共通認証ガード（Middleware + Server Helper）により、アプリケーション層で厳密なアクセス制御を行う。**
* RLS 方針（案）：

  * tenants / users / user_roles について、system_admin ユーザが全テナントを参照・更新できる RLS を定義する。
  * もしくは、service_role を利用する API についても、アプリケーション側で system_admin チェックを必須とし、一般ユーザからの誤アクセスを防ぐ。
* テナント ID による RLS は、通常業務系（/t-admin/* 等）に適用し、本書対象の `/sys-admin/*` では「system_admin 権限」の有無を第一条件とする。
* テナント管理者ユーザ一覧・登録・編集は、常に URL の `{tenantId}` を明示し、その ID に対してのみ `user_roles` を操作する（状態フラグは持たず、tenant_admin ロールの有無のみで管理者かどうかを表現する）。:contentReference[oaicite:10]{index=10}  

---
