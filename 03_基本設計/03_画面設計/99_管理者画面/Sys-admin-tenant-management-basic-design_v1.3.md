# システム管理者向けテナント管理・テナント管理者管理 基本設計書（ドラフト v1.3）

## 1. 概要

### 1.1 目的

本書は、システム管理者（system_admin）が利用する以下の機能について、画面構成と振る舞いを定義する。

* テナント一覧表示・選択
* テナントの新規作成・更新・無効化（削除相当）
* テナント管理者ユーザ一覧表示（テナント単位）
* テナント管理者ユーザの新規登録・更新・削除（または管理者ロール解除）

本機能は、一般利用者・テナント管理者が利用する t-admin とは独立した「システム管理専用 UI」として提供する。

### 1.2 前提・制約

* 認証は既存の MagicLink 認証を利用する。
* ログイン入口は以下の 2 系統に分離する：

  * 一般利用者・テナント管理者向け: `/login`
  * システム管理者向け: `/sys-admin/login`
* `/login` でログインしたユーザは、テナント内の画面（HOME・t-admin 等）のみ利用できる。`/sys-admin/*` への導線は提供しない。
* `/sys-admin/login` でログインした system_admin ユーザは、テナント内画面には遷移せず、本書で定義するシステム管理専用画面のみ利用できる。
* system_admin 権限は TKD が DB 上で直接付与する。画面上から付与・削除する機能は実装しない。
* system_admin 権限は、`user_roles` テーブルにおける以下のレコードで表現する：

  * `role_scope = 'system'`
  * `role_code = 'system_admin'`
* system_admin ユーザは、システム管理専用のダミーテナント（例: `tenant_code = 'SYSTEM'`）に所属させる。

  * `user_roles.tenant_id` にはこのダミーテナントの `tenants.id` を設定する。
  * system_admin 権限の判定では tenant_id を参照せず、`role_scope` / `role_code` のみを用いる。
* `system_admin` ロールを持つユーザでログインした場合のみ、本書で定義する画面にアクセスできる。
* システム管理画面で扱う対象は以下に限定する：

  * `tenants` テーブル（テナントの基本属性と状態）
  * 対象テナントに紐づくテナント管理者ユーザ

    * `users` / `user_roles` の既存モデルを t-admin と共通で利用する
* テナント管理者ユーザについて「このテナントにおける有効／無効」の状態フラグは設けず、「管理者である／ない」は tenant_admin ロールの有無（該当 `user_roles` レコードの存在）で表現する。
* `user_tenants` は掲示板既読管理等で利用されるが、本機能のロジックおよび画面表示では利用しない（テナント所属は `users.tenant_id` を正とする）。
* ユーザとテナントの関係は「1ユーザ = 1テナント」とし、複数テナント所属はサポートしない。
* 一般ユーザや通常の t-admin 機能（掲示板・翻訳・その他設定）は本書の対象外とする。
* 本基本設計書における「SA-02〜SA-05」は、**個別画面ではなく、SA-01 画面内のセクション ID** として扱う（実装は 1 画面構成）。

### 1.3 DB アクセスと認証・認可方針

* `/sys-admin/*` 配下の画面・API は、`system_admin` 権限を必須とする。
* **認証・認可ガードには、共通基盤（Middleware + Server Helper）を利用する。**

  * Middleware (`proxy.ts`) による一次ガードで、未認証・未認可ユーザをリダイレクトする。
  * Server Helper (`systemAdminAuth.ts`) による二次ガードで、API や Server Component 内での厳密な権限チェックを行う。
* DB アクセスは、原則としてアプリケーションから Supabase クライアント経由で行い、RLS により `system_admin` のみが全テナントを参照・更新できるようにする。
* 必要に応じて service_role を利用する場合でも、アプリケーション側で `system_admin` チェックを必須とし、誤操作範囲を極小化する。

---

## 2. 画面一覧

### 2.1 実装画面一覧

| 画面ID  | 画面名        | URL                  | 概要                                      |
| ----- | ---------- | -------------------- | --------------------------------------- |
| SA-00 | システム管理ログイン | `/sys-admin/login`   | system_admin 専用ログイン画面                   |
| SA-01 | システム管理ホーム  | `/sys-admin/tenants` | テナント詳細＋テナント管理者管理＋テナント一覧を 1 画面で提供するコンソール |

### 2.2 SA-01 内部セクション定義（論理 ID）

v1.0 で定義していた SA-02〜SA-05 は、**別画面としては実装せず**、以下のように SA-01 画面内のセクションとして扱う。

| セクションID    | セクション名         | 画面上の配置        | 概要                    |
| ---------- | -------------- | ------------- | --------------------- |
| SA-02      | テナント詳細セクション    | 画面上部          | 単一テナントの基本情報表示・編集      |
| SA-03      | テナント管理者一覧セクション | 画面中段          | 指定テナントに紐づくテナント管理者一覧表示 |
| SA-04      | テナント管理者登録セクション | 画面中段（SA-03 下） | 管理者ユーザ新規登録フォーム        |
| SA-05      | テナント管理者編集セクション | 画面中段（SA-03 下） | 管理者ユーザ編集フォーム          |
| SA-01-TAIL | テナント一覧セクション    | 画面下部          | 全テナント一覧表示・選択          |

URL としては **SA-01 のみ**が存在し、セクションの切替・表示非表示は、状態管理による UI 切替で実現する。

---

## 3. 画面遷移

1. system_admin 権限を持つユーザが `/sys-admin/login`（SA-00）からログイン。
2. ログイン後遷移：`/sys-admin/tenants`（SA-01 実装画面）。
3. SA-01 内の遷移は **すべて同一 URL 上の状態遷移** とし、ページ遷移は行わない。

### 3.1 SA-01 内部遷移

* テナント一覧セクション（画面下部）で行選択

  * `selectedTenantId` を更新し、画面上部のテナント詳細セクション（SA-02）とテナント管理者セクション（SA-03〜SA-05）の表示内容を切り替える。
* 「新規テナント作成」ボタン

  * SA-02 セクションを新規モードに切り替え（入力項目を空にし、登録ボタンで新規テナント作成）。
* テナント管理者一覧（SA-03）で「新規管理者登録」ボタン

  * SA-04 セクションを表示し、新規登録フォームモードに切り替える。
* 管理者一覧行の「編集」ボタン

  * SA-05 セクションを表示し、編集フォームモードに切り替える。
* 管理者登録フォームで「保存」成功時

  * SA-03 の一覧を再読込し、フォームをクリア（モードを初期状態に戻す）。
* 管理者編集フォームで「保存」成功時

  * SA-03 の一覧を再読込し、フォームをクリア（モードを初期状態に戻す）。

---

## 4. 画面要件

### 4.1 共通レイアウト方針

* 既存 HarmoNet の PC 向け管理画面レイアウトに準拠する。
* ヘッダー：アプリ共通 AppHeader を利用。
* コンテンツ：左右余白のある 1 カラムレイアウト。
* フッター：共通フッター（AppFooter）を利用。
* 画面タイトルは左上に論理名称で表示（例：「テナント管理コンソール」）。
* ボタン類は各セクション内で右寄せとし、主要アクション（保存・登録）は Primary ボタンで表現する。

---

### 4.2 SA-02 テナント詳細セクション（画面上部）

#### 4.2.1 レイアウト概要

* セクションタイトル: 「テナント詳細」
* 項目

  * テナントコード
  * テナント名
  * タイムゾーン
  * ステータス（有効 / 無効）
* ボタン

  * 「クリア」 … 入力内容をリセット
  * 「登録」 … 新規登録 / 更新

#### 4.2.2 入力項目

* テナントコード

  * 必須、英数字 + `-` `_` のみ、最大 32 文字、システム全体で一意
* テナント名

  * 必須、最大 80 文字
* タイムゾーン

  * 必須、IANA TZ から選択

#### 4.2.3 メッセージ

* 保存成功: 「テナント情報を保存しました。」
* 無効化成功: 「テナントを無効化しました。このテナントの利用者はログインできなくなります。」
* 再有効化成功: 「テナントを再有効化しました。」

---

### 4.3 SA-03 テナント管理者一覧セクション

#### 4.3.1 レイアウト概要

* セクションタイトル

  * 「テナント管理者」
* サブタイトル

  * 「テナント: {テナント名}」を表示
* 管理者一覧テーブル

  * 列

    * メールアドレス
    * 表示名（ニックネーム）
    * 氏名（画面表示は `last_name` + `fast_name` の連結）
    * 最終ログイン（任意、取得できる場合のみ）
    * 操作（編集 / 管理者解除）
* 管理者登録・編集フォーム（SA-04 / SA-05）

  * 一覧の直下に配置し、モードに応じて「新規登録」「編集」を切り替える。

#### 4.3.2 操作

* 管理者一覧行の「編集」

  * 下部フォーム（SA-05）に選択ユーザの **メールアドレス / 表示名 / 姓 / 名 / 姓ふりがな / 名ふりがな** を読み込み、編集モードにする。
  * メールアドレスは編集不可とする。
* 管理者一覧行の「管理者解除」

  * 対象ユーザの `tenant_admin` ロールに紐づく `user_roles` レコードを削除する。
  * `users` レコード自体は削除しない。
* 「新規管理者登録」ボタン

  * 下部フォーム（SA-04）を新規登録モードで表示する。

---

### 4.4 SA-04 テナント管理者新規登録セクション

#### 4.4.1 レイアウト概要

* タイトル（サブ）: 「管理者ユーザ登録」
* 対象テナント名をサブタイトル表示
* フォームは t-admin のユーザ登録画面と同じ構成を基本とする（`users` / `user_roles` モデルを共有）。

#### 4.4.2 入力項目（論理名称・例）

| 項目ID | 論理名称    | 必須 | 備考                          |
| ---- | ------- | -- | --------------------------- |
| U-01 | メールアドレス | 必須 | Supabase Auth ユーザキー         |
| U-02 | 表示名     | 必須 | 画面表示用（`users.display_name`） |
| U-03 | 姓       | 必須 | `users.last_name` に対応       |
| U-04 | 名       | 必須 | `users.fast_name` に対応       |
| U-05 | 姓ふりがな   | 任意 | `users.last_name_kana` に対応  |
| U-06 | 名ふりがな   | 任意 | `users.fast_name_kana` に対応  |

※ 状態（有効／無効）の概念は持たず、「管理者である／ない」は tenant_admin ロールの有無で表現する。

#### 4.4.3 バリデーション概要

* メールアドレス：形式チェック、桁数上限
* 表示名：必須、桁数上限
* 姓／名：必須、桁数上限（それぞれ別カラム：`users.last_name`, `users.fast_name`）
* 姓ふりがな／名ふりがな：任意、桁数上限（かな種別チェック等は詳細設計側で定義）

#### 4.4.4 挙動

* 登録時のパターン分岐：

  * 既存メールアドレスの場合：

    * Supabase Auth / `users` は既存レコードを利用。
    * `users.tenant_id` が対象テナントと異なる場合はエラーとし、「別テナントに所属しているユーザは管理者として追加できません。」等のメッセージを返す（1ユーザ=1テナント前提）。
    * `users.tenant_id` が同一であれば `users` はそのまま利用し、`user_roles` に tenant_admin ロールを追加する。
    * 併せて `general_user` ロールも追加する（テナント管理者は一般ユーザとしての機能も利用可能とするため）。
  * 新規メールアドレスの場合：

    * Supabase Auth にユーザ新規作成。
    * `users` に INSERT（tenant_id に対象テナントを設定。`group_code` / `residence_code` 等はダミー値を設定する方針は詳細設計側で定義）。
    * `user_roles` に tenant_admin ロールを追加。
    * `user_roles` に general_user ロールを追加。
* 「保存」ボタン成功時 → 管理者一覧（SA-03）の再読込とフォームリセットを行う。
* 「キャンセル」ボタン → 入力内容を破棄し、フォームを初期状態に戻す。

---

### 4.5 SA-05 テナント管理者編集セクション

#### 4.5.1 レイアウト概要

* タイトル（サブ）: 「管理者ユーザ編集」
* 対象テナント名＋対象ユーザのメールアドレス／表示名を見出しに表示。
* 入力フォーム構成は SA-04 と同等（メールアドレスのみ編集不可）。

#### 4.5.2 編集可能項目

* 表示名
* 姓
* 名
* 姓ふりがな
* 名ふりがな

メールアドレスは Supabase Auth およびログイン識別子として利用するため、原則変更不可とする。メールアドレス変更が必要な場合は、運用として「新メールアドレスでユーザを新規登録し、旧ユーザを管理者から外す」フローを取る（アプリ上ではメール変更 UI を提供しない）。

#### 4.5.3 操作

* 「保存」ボタン

  * `users` の対象項目更新（`display_name` / `last_name` / `fast_name` / `last_name_kana` / `fast_name_kana`）。
  * 更新成功時は SA-03 の一覧を再読込し、フォームを初期状態に戻す。
* 「管理者ロール解除」ボタン

  * `user_roles` の tenant_admin ロールを削除する（当該テナントにおける管理者権限を解除）。
* 「キャンセル」ボタン

  * 入力内容を破棄し、フォームを初期状態に戻す。

---

### 4.6 SA-01-TAIL テナント一覧セクション（画面下部）

#### 4.6.1 レイアウト概要

* セクションタイトル: 「テナント一覧」
* テーブルエリア

  * テナント一覧テーブル（ページングあり想定）

#### 4.6.2 テーブル列定義（論理名称）

| 表示順 | 論理名称    | 説明                | 備考                               |
| --- | ------- | ----------------- | -------------------------------- |
| 1   | テナントコード | テナントを一意に識別するコード   | 行選択時にテナント詳細セクションを切り替え            |
| 2   | テナント名   | テナントの論理名称         |                                  |
| 3   | タイムゾーン  | テナントの基準タイムゾーン     |                                  |
| 4   | 状態      | active / inactive | 表示は「有効」「無効」など日本語（tenants.status） |
| 5   | 作成日時    | テナント作成日時          | 読み取り専用                           |

#### 4.6.3 操作

* 行選択

  * 選択したテナントをアクティブテナントとし、SA-02 / SA-03〜05 の表示内容を更新する。
* 「新規テナント作成」ボタン（配置位置はヘッダー右側またはセクション上部）

  * SA-02 を新規モードに切り替える。

---

## 5. 権限制御（概要）

* `/sys-admin/*` 配下の画面・API は、`user_roles` テーブルにおいて `role_scope = 'system'` かつ `role_code = 'system_admin'` を持つユーザのみアクセス可能とする。
* `/sys-admin/login` 経由でログインしたセッションに対してのみ、`/sys-admin/*` へのルーティングを許可する。
* 住民／テナント向けの `/login` セッションからは、`/sys-admin/*` への遷移リンクやメニューは表示しない。
* **共通認証ガード（Middleware + Server Helper）により、アプリケーション層で厳密なアクセス制御を行う。**
* RLS 方針（案）：

  * tenants / users / user_roles について、system_admin ユーザが全テナントを参照・更新できる RLS を定義する。
  * もしくは、service_role を利用する API についても、アプリケーション側で system_admin チェックを必須とし、一般ユーザからの誤アクセスを防ぐ。
* テナント ID による RLS は、通常業務系（/t-admin/* 等）に適用し、本書対象の `/sys-admin/*` では「system_admin 権限」の有無を第一条件とする。
* テナント管理者ユーザ一覧・登録・編集は、常にアクティブな `{tenantId}`（選択中テナント）に対してのみ `user_roles` を操作する（状態フラグは持たず、tenant_admin ロールの有無のみで管理者かどうかを表現する）。

---

## 6. ChangeLog

| Version | Date       | Author    | Summary                                                        |
| ------- | ---------- | --------- | -------------------------------------------------------------- |
| 1.3     | 2025-12-06 | Tachikoma | SA-01 を 1 画面 3 セクション構成とする実装に合わせて整理。管理者氏名項目を fast/last 系カラムへ分割。 |
| 1.2     | 2025-11-30 | Tachikoma | SysAdmin ログイン画面（SA-00）追加。システム管理画面群（SA-01〜05）の画面一覧を定義。          |
| 1.1     | 2025-11-28 | Tachikoma | 初版 5 画面構成案（SA-01〜05）を作成。                                       |
| 1.0     | 2025-11-27 | Tachikoma | たたき台作成。                                                        |
