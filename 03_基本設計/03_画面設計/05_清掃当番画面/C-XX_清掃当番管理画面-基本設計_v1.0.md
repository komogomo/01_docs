# 清掃当番管理画面 基本設計書 v1.0

## 0. メタ情報

* ドキュメントID: C-XX-CleaningDuty-BasicDesign
* 対象画面: 清掃当番管理画面（ホーム画面 機能タイル遷移）
* 関連機能:

  * ホーム画面 機能タイル（旧「アンケート」 → 「清掃当番管理」に差し替え）
  * 言語切替（JA / EN / ZH）
* 関連テーブル（想定）:

  * `users`（姓/名分割, `tenant_id`, `group_code`, `residence_code` など）
  * `cleaning_duties`（本画面用 新規テーブル案）
  * i18n 用翻訳テーブル（静的文言はすべて DB 管理）
* 想定読者: 画面設計者 / Windsurf 実装担当 / テスト担当
* ステータス: v1.0 初版

---

## 1. 画面概要

### 1.1 目的

本画面は、大規模分譲住宅地等において、住民が持ち回りで行う「清掃当番」の状況を管理するための作業管理簿である。

紙や Excel の当番表を置き換え、以下を実現することを目的とする。

* グループ（班）ごとのゴミ収集場所に対して、誰がいつ清掃当番を実施したかを記録する
* 各住戸に対して「世帯主（代表者）」を紐付け、清掃当番の担当者として扱う
* 実施結果（チェック）と清掃日を記録し、グループ全体の直近の当番履歴（最大 3 サイクル分）を参照できる
* 班員自身が自分の順番の清掃結果を記録し、班長が内容を確認のうえ完了確定する

### 1.2 導線

* ホーム画面の機能タイルのうち、未使用の「アンケート」タイルを「清掃当番管理」に差し替える。
* ログイン後のホーム画面において、`users.group_code` を持つユーザには「清掃当番管理」タイルを表示する。
* 当該タイル押下で、本画面（清掃当番管理簿）へ遷移する。

### 1.3 利用者

本画面は、以下のユーザが利用する。

* 班員（一般利用者ロールを持ち、`group_code` が設定されているユーザ）

  * 自分のグループの清掃当番表を閲覧し、自分の住戸の当番を実施した際に「実施結果」を記録する。
* 班長（`group_leader` ロール + 一般利用者ロールを併せ持ち、`group_code` が設定されているユーザ）

  * 班員と同様に、自分の住戸の当番結果を記録する当番者である。
  * 追加で、自グループ各住戸の「世帯主（担当者）」を設定・変更し、清掃結果を確認のうえ完了確定を行う。

### 1.4 表示対象（自グループのみ）

* 表示対象は、ログインユーザと同一の `tenant_id` かつ同一の `group_code` を持つ行のみとする。
* すなわち、「自分が所属するグループの清掃当番表」だけが表示される。
* 他グループの清掃当番表は、本画面からは閲覧・操作ともにできない。

---

## 2. 認証・認可・アクセス制御

### 2.1 認証

* Supabase Auth により、ログイン済み (`auth.uid()` が存在) のユーザのみがホーム画面にアクセスできる。
* 未ログインユーザはホーム画面および本画面にアクセスできない。

### 2.2 画面への入室条件（ページ単位の認可）

* 条件:

  * 認証済みであること
  * `users.group_code IS NOT NULL` であること
* 上記を満たすユーザはロールに関係なく本画面へアクセスできる。

  * 班員（一般利用者ロール）
  * 班長（`group_leader` ロール + 一般利用者ロール）
  * その他のロールを併せ持っていても、`group_code` が設定されていれば入室可能

#### group_code 未設定の場合の扱い

* 認証済みだが `group_code IS NULL` のユーザは、本画面にはアクセスできない。
* その場合は、専用のメッセージを表示する（翻訳テーブル管理）。

  * JA 例:

    * 「清掃当番管理簿は、グループに所属している利用者のみご利用いただけます。」
    * 「お手数ですが、管理組合までお問い合わせください。」
* これは、`group_code` 未設定は管理組合側の登録漏れである前提に基づく。

### 2.3 画面内の操作権限（要素単位の認可）

* 共通: `group_code` を持つすべてのユーザ

  * 自分の住戸行の「実施結果」チェック ON/OFF
  * 自分の行の「清掃日」の確認
  * 自グループ全体の前回履歴（最大 3 サイクル分）の参照
* 追加権限: `group_leader` ロールを持つユーザ（班長）

  * 自グループの各行の「世帯主（assignee_id）」の設定・変更
  * 自グループの各行の「完了」ボタン押下（ダイアログ確認のうえ、`completed_at` 設定 + 次サイクル行作成）
* 禁止事項（いかなるロールでも不可）

  * 過去サイクル（`completed_at IS NOT NULL`）レコードの変更
  * 自分以外の住戸行の「実施結果」チェック／清掃日変更

※ RLS ポリシーおよび API レベルでの制御は詳細設計で定義する。本書では画面レベルの前提のみ記載する。

---

## 3. 画面構成

### 3.1 全体レイアウト

* 共通ヘッダー

  * 既存の共通ヘッダーを使用する。
  * 清掃当番管理専用のタイトルは表示しない。
  * 通知アイコン・言語切替ボタン等は既存仕様に準拠。

* 本文エリア

  * ユーザ管理画面と同一系統のカードレイアウトを採用する。
  * 上部:

    * 本文エリアの最上部に、ログインユーザのグループ ID を用いたタイトルを表示する。

      * 表示形式: `group_code + "_掃除当番管理簿"`
      * 例: `南-B_掃除当番管理簿`
      * 「_掃除当番管理簿」の部分は翻訳テーブル管理とし、言語切替に連動して変化させる。
  * 中段:

    * 清掃当番管理に関する説明テキスト（用途・操作方法など）
  * 下段:

    * 清掃当番表（テーブル）
    * 行ごとの操作ボタン（「前回」「完了」）

### 3.2 清掃当番表のテーブル構成

#### 3.2.1 列一覧（現行管理簿と同じ順序）

1. 項番

   * 表示のみ。
   * 1, 2, 3, ... の通し番号を表示する。

2. 実施結果

   * チェックボックス。
   * ログインユーザの住戸行（`residence_code` が一致する行）のみ操作可能。
   * ON にしたタイミングで、以下を更新する。

     * `is_done = true`
     * `cleaned_on = チェック操作時点のシステム日付`
   * OFF に戻す操作を許容するかは詳細設計で定義する（誤操作対応のみ想定）。

3. 清掃日

   * 表示: `cleaning_duties.cleaned_on`。
   * 実施結果チェック ON 時に自動でシステム日付が設定される。
   * 原則として表示のみとし、修正可否は詳細設計で定義する。

4. 住居番号

   * 表示: `residence_code`（例: "13-131", "7F702"）。
   * 値は世帯主に紐づく住戸情報から取得する。
   * 画面上で直接編集はできない。

5. 世帯主

   * 班長:

     * ドロップダウンで、自グループに所属するユーザを選択する。
     * 表示値: `users.last_name`（苗字）。
     * 内部値: `users.id` → `cleaning_duties.assignee_id` に保存。
     * 変更時には「編集」ボタンを押下し、再選択可能とする。
   * 班員:

     * テキスト表示のみ（`last_name`）。
     * 変更不可。

6. 操作

   * 行ごとの「編集」ボタンを配置する。
   * 班長: 世帯主の再設定のために [編集] ボタンを使用できる。
   * 班員: [編集] ボタンは表示しない、または非活性とする（世帯主変更不可）。

#### 3.2.2 ボタン配置（前回・完了）

* 「前回」ボタン

  * テーブルの直下（ページネーション付近）に 1 個だけ配置する。
  * グループ全体の清掃当番履歴（最大 3 サイクル分）を参照するトリガーとする。
  * 押下可能ロール: `group_code` を持つ全ユーザ。

* 「完了」ボタン

  * テーブルの右下に 1 個だけ配置する（現行管理簿と同じ配置イメージ）。
  * 押下可能ロール: `group_leader` ロールを持つ班長のみ。
  * 押下時は必ず確認ダイアログを表示し、OK で現在サイクルの完了処理を行う。

---

## 4. 清掃当番データモデル（画面観点）

### 4.1 cleaning_duties テーブル案

本画面専用の清掃当番管理テーブルを新設する前提とする。
1 レコードは「ある住戸の、ある当番サイクルの結果」を表す。

想定スキーマ（Prisma 風イメージ）:

```prisma
model cleaning_duties {
  id             String   @id @default(uuid())
  tenant_id      String
  group_code     String      // users.group_code
  residence_code String      // users.residence_code
  cycle_no       Int         // 当番サイクル番号（1,2,3,...）

  assignee_id    String      // 世帯主ユーザ（担当者）
  is_done        Boolean  @default(false)
  cleaned_on     DateTime?   // 清掃日（チェック時のシステム日付）
  completed_at   DateTime?   // 完了確定日時（班長が完了ボタン押下）

  created_at     DateTime @default(now())   // レコード作成日時
  updated_at     DateTime @updatedAt        // 最終更新日時

  // relations（概要レベル）
  tenant   tenants @relation(fields: [tenant_id], references: [id])
  assignee users   @relation(fields: [assignee_id], references: [id])

  @@index([tenant_id, group_code, residence_code])
  @@index([tenant_id, group_code, residence_code, cycle_no])
}
```

### 4.2 状態遷移（1 レコードのライフサイクル）

1. 初期状態（新サイクル作成直後）

   * `is_done = false`
   * `cleaned_on = null`
   * `completed_at = null`
   * `assignee_id` は班長による世帯主設定時点で保持される。

2. 掃除実施（班員または班長本人）

   * 対象: 自分の住戸の現在サイクルのレコード 1 件。
   * 自分の行の「実施結果」チェックボックスを ON。
   * 更新:

     * `is_done = true`
     * `cleaned_on = チェックした時点のシステム日付`
     * `updated_at` 自動更新

3. 完了確定（班長のみ）

   * 前提: `is_done = true` であること（掃除済み）。
   * 班長が当該行の「完了」ボタン押下 → 確認ダイアログ表示。
   * ダイアログ文言（JA のイメージ、実際は翻訳テーブル管理）:

     * タイトル: 「清掃当番を完了します」
     * 本文: 「この清掃当番を完了します。以降、この記録は変更できません。よろしいですか？」
     * ボタン: [キャンセル] [完了する]
   * 「完了する」選択時の更新:

     * 当該レコードに `completed_at = now()` を設定。
     * これによりレコードは「履歴（確定済み）」となり、以降編集不可とする。
     * 次サイクル用レコードを自動生成する。

       * `cycle_no = 旧 + 1`
       * `tenant_id, group_code, residence_code, assignee_id` を引き継ぐ。
       * `is_done = false, cleaned_on = null, completed_at = null`。

4. 履歴状態

   * 条件: `completed_at IS NOT NULL`。
   * 画面上では履歴として参照のみ可能とし、`is_done / cleaned_on / assignee_id` 含め編集は禁止する。

---

## 5. 前回履歴表示仕様

### 5.1 対象範囲

* 「前回」ボタンは、グループ単位の履歴参照機能とする。
* 対象は、ログインユーザと同一 `tenant_id` かつ同一 `group_code` を持つすべての住戸に対する履歴（`completed_at IS NOT NULL` のレコード）。

### 5.2 取得ロジック（概要）

* `tenant_id = current_user.tenant_id`
* `group_code = current_user.group_code`
* `completed_at IS NOT NULL`
* `completed_at` 降順でソートし、上位 3 サイクル分を取得する。

  * 1 サイクルあたり複数住戸が存在するため、UI 上は「サイクル単位」または「完了日時単位」でまとめて表示する。

### 5.3 表示内容

* 履歴モーダル（読取専用）の例:

  * サイクル番号または実施回数（例: 第 1 回, 第 2 回, 第 3 回）
  * 清掃日 (`cleaned_on`)
  * 住居番号 (`residence_code`)
  * 世帯主 (`last_name`)
  * 完了日時 (`completed_at`)
* 編集操作（チェック/完了やり直し等）は一切提供せず、完全な読み取り専用とする。

---

## 6. ロール別操作一覧（画面観点）

### 6.1 現在サイクル & 自分の住戸行

| 操作                   | 班長 (group_leader + 一般) | 班員（一般） |
| -------------------- | ---------------------- | ------ |
| 清掃当番管理画面へのアクセス       | ○                      | ○      |
| 自分の行の実施結果チェック ON/OFF | ○                      | ○      |
| 自分の行の清掃日確認           | ○                      | ○      |
| 自分の行の世帯主の変更          | ○                      | ×      |
| 自分の行の完了ボタン押下         | ○（ダイアログ表示）             | ×      |

### 6.2 現在サイクル & 他人の住戸行（同グループ）

| 操作       | 班長            | 班員 |
| -------- | ------------- | -- |
| 実施結果チェック | ×（閲覧のみ）       | ×  |
| 清掃日      | ×（閲覧のみ）       | ×  |
| 世帯主の変更   | ○（自グループ内行のみ可） | ×  |
| 完了ボタン押下  | ×             | ×  |

### 6.3 履歴（過去サイクル, `completed_at IS NOT NULL`）

| 操作           | 班長         | 班員 |
| ------------ | ---------- | -- |
| 実施結果・清掃日の変更  | ×（閲覧のみ）    | ×  |
| 世帯主の変更       | ×          | ×  |
| 完了やり直し       | ×          | ×  |
| 前回ボタンからの履歴閲覧 | ○（自グループ全体） | ○  |

---

## 7. i18n（多言語対応）

### 7.1 静的文言の扱い

* 本画面におけるすべての静的文言（ラベル、ボタン名、ダイアログメッセージ、エラー文言等）は、`common.json` ではなく、既存の i18n 用翻訳テーブルに登録されたキーから取得する。
* 例となるキー（あくまで案）：

  * `cleaningDuty.titleSuffix` → "_掃除当番管理簿" / " Cleaning Duty Ledger" 等
  * `cleaningDuty.description` → 画面説明文
  * `cleaningDuty.complete.confirm.title` / `.message` / `.confirmButton` / `.cancelButton`
  * `cleaningDuty.error.noGroupCode` → group_code 未設定時のメッセージ

### 7.2 言語切替

* 共通ヘッダーの言語切替ボタン（JA / EN / ZH）で、本画面の文言もすべて切り替わる。
* 言語切替時には、

  * 本文タイトル `group_code + suffix`
  * 説明文
  * テーブル列ヘッダ
  * ボタンラベル
  * ダイアログ文言
  * エラーメッセージ
    などが、選択言語に対応する翻訳に置き換わる。

---

## 8. エラー・エンプティ状態

### 8.1 group_code 未設定

* 前述の通り、認証済みだが `group_code IS NULL` のユーザが本画面 URL にアクセスした場合は、以下のメッセージを表示し、清掃当番表は表示しない。

  * 「清掃当番管理簿は、グループに所属している利用者のみご利用いただけます。」
  * 「お手数ですが、管理組合までお問い合わせください。」

### 8.2 自グループに住戸が存在しない

* `cleaning_duties` または住戸情報に自グループの対象行が 1 行も存在しない場合は、以下のようなメッセージを表示する（案）。

  * 「このグループに登録された掃除当番はまだありません。」
* 初期化方法（初回行の作成タイミング）は詳細設計で定義する（班長ログイン時に自動生成する 等）。

### 8.3 サーバエラー・ネットワークエラー

* データ取得や更新に失敗した場合は、共通のエラーハンドリング方針に従う。
* 画面上には簡潔なエラーメッセージを表示し、詳細はログに記録する。

---

## 9. 非機能・その他

* パフォーマンス

  * 対象はログインユーザの `tenant_id + group_code` のみであり、1 画面に表示される行数はグループ内住戸数に限定される。
  * 一般的な班規模（数十戸想定）であれば問題ないが、行数が多い場合でもスムーズに操作できるよう、テーブル表示やモーダル表示を軽量に保つ。

* 共通部品（ロガー）

  * 本画面は、HarmoNet 全体で利用している共通ロガーコンポーネントを利用する。
  * 画面固有の監査・専用ログ要件は持たず、他画面と同じレベルのエラーログ／情報ログのみ出力対象とする。

* セキュリティ

  * 認証: Supabase Auth の現行方針に準拠する。
  * 認可: RLS ポリシーとアプリ側ロジックの両方で、`tenant_id` / `group_code` / `assignee_id` / `group_leader` ロールを用いた制御を行う（詳細は DB/RLS 詳細設計にて定義）。

---

以上。
