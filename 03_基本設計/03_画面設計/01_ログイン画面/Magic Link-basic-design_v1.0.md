# HarmoNet 基本設計書 - MagicLink ログイン機能 (A-01) v1.0

---

## 0. ドキュメント情報

- 文書名: HarmoNet 基本設計書 - MagicLink ログイン機能 (A-01)
- Document ID: HARMONET-BASIC-A01-MAGICLINK-AUTH
- Version: v1.0
- Status: Draft（TKD レビュー前）
- 対象システム: HarmoNet（マルチテナント型コミュニティ OS）
- 対象コンポーネント:
  - A-01 MagicLinkForm（MagicLink ログイン用カードタイル＋フォーム）
- 作成日: 2025-11-15
- 作成者: Tachikoma
- レビュー: TKD

---

## 1. 目的・背景

### 1.1 目的

本書の目的は、HarmoNet における **MagicLink ログイン機能（A-01 MagicLinkForm）** の基本設計を定義することである。

MagicLinkForm は、

- A1 ログイン画面基本設計で定義された「左右配置のカードタイル型ログインボタン」 のうち、  
  **「メールでログイン」側（左側想定）のカードタイル** を構成し、
- カード内の操作をきっかけに Supabase Auth を用いた MagicLink 送信を実行し、
- 結果を同じカード内のメッセージ表示に反映する

コンポーネントとして設計する。

### 1.2 背景

- A1 ログイン画面では、メール／Passkey の 2 つのログイン手段を、**左右のカードタイル**として提示する構造が決まっている。  
- 一般ユーザーにとっては、「メールアドレスでログイン」が最も分かりやすい手段であるため、MagicLink カードタイルを標準的な入口とする。
- パスワードの管理を避けるため、MagicLink によるパスワードレス認証を採用する。

---

## 2. 対象範囲と非対象

### 2.1 対象範囲

- `/login` 画面における **MagicLink ログイン用カードタイル UI**（左右カードのうちメール側）
- カード内のメール入力フォーム／ボタン／メッセージ領域の構成
- MagicLink ログインの開始トリガ（カード内ボタン押下）から、MagicLink 送信までのフロントエンド処理
- 入力チェック（形式レベル）と、カード内でのエラー／成功メッセージ表示
- MagicLink ログインに関するログ出力・メッセージ設計の方針レベル

### 2.2 非対象

- `/auth/callback` 以降のトークン検証・画面遷移の処理
- Supabase Auth サーバ側の内部実装（トークン検証・セッション管理）
- Passkey ログイン（A-02）の詳細仕様（別基本設計書で定義）

---

## 3. 業務要件・ユースケース

### 3.1 想定ユーザー

- メールアドレスを保有している居住者／管理者
- スマホ・PC からブラウザで HarmoNet にアクセスする一般ユーザー

### 3.2 代表ユースケース

#### UC-01: MagicLink カードタイルからログインする

1. ユーザーが `/login` を表示する。
2. 画面中央付近に、「メールでログイン」カードタイル（MagicLinkForm）と「Passkey ログイン」カードタイル（A-02）が横並びで表示される。  
3. ユーザーが MagicLink カードタイル内のメールアドレス入力欄に自分のアドレスを入力する。
4. 同カードタイル内の「ログイン」ボタンを押下する。
5. MagicLinkForm が形式チェックを行い、OK なら Supabase Auth に対して MagicLink 送信を依頼する。
6. 送信成功時、同カード内のメッセージ領域に「メールを確認してください」等の案内を表示する。

#### UC-02: MagicLink カードタイルで入力エラーが発生する

1. ユーザーが誤った形式のメールアドレスを入力する。
2. MagicLinkForm がボタン押下後にクライアント側で形式チェックを行い、カード内メッセージ領域にエラーメッセージを表示する。
3. ユーザーが修正して再入力し、再度ボタンを押下する。

#### UC-03: MagicLink 送信時にエラーが発生する

1. UC-01 と同様に送信を試みる。
2. ネットワーク障害などにより Supabase 連携が失敗する。
3. MagicLinkForm はカード内にエラーメッセージを表示し、再試行の案内などを行う。

---

## 4. 機能要件（基本設計レベル）

### 4.1 コンポーネントの役割

#### A-01 MagicLinkForm

* UI:

  * ログイン画面の中に配置される「メールでログイン」用カードタイルの**左側カード**を構成する。  
  * カード内に以下の要素を含む。
    * タイトル: 「メールでログイン」など（A1 で定義された文言方針に準拠）
    * 説明テキスト: 「入力したメールアドレスにログイン用リンクを送信します」などの短い案内
    * メールアドレス入力フィールド（ラベル付き）
    * 「ログイン」ボタン（プライマリアクション）
    * 入力エラーや送信結果を表示するメッセージ領域
* ロジック:

  * 「ログイン」ボタン押下をきっかけに、入力されたメールアドレスの形式チェックを行う。
  * 形式チェックが通った場合に、Supabase Auth へ MagicLink 送信処理を依頼する。
  * 送信中／成功／失敗などの状態を管理し、それに応じて
    * ボタンの活性／非活性
    * メッセージ表示内容
    * 入力欄へのフォーカス戻し
    を切り替える。

### 4.2 入出力（概念）

**入力**

- ユーザー入力: メールアドレス文字列
- ユーザー操作: MagicLink カード内「ログイン」ボタン押下

**出力**

- MagicLink 送信 API の結果（成功／失敗）
- カードの状態（Idle／Sending／Sent／Error）
- ログイベント（例: `auth.login.magiclink.start` / `auth.login.magiclink.sent` / `auth.login.magiclink.error`）

### 4.3 エラーの考え方（概要）

- 入力エラー:
  - メールアドレス形式不正など、カード内で検出できるもの。
- 通信エラー:
  - ネットワーク障害や Supabase からのエラー応答。
- 想定外エラー:
  - 上記に分類できない例外的な状況。

詳細なエラー定義やコードは詳細設計で扱い、本書では「どの種類のエラーがあり得るか」を示す。

---

## 5. UX 方針（MagicLink カードタイル）

### 5.1 画面内での位置づけ

- `/login` 画面中央に、MagicLink カードタイルと Passkey カードタイルを**左右に 2 枚**並べる。  
- スマホ幅が狭い場合は、A1 の仕様通り縦積み（MagicLink→Passkey の順）にフォールバックする。
- どちらも「ログイン手段」であると一目で分かるようにしつつ、MagicLink カードを標準的な入口として扱う。

### 5.2 カードタイル構成イメージ

- アイコン: メールを示すアイコン（A1 のカード例に準拠）
- タイトル: 「ログイン」または「メールでログイン」
- サブテキスト: 「メールアドレスにログイン用リンクを送信します」など簡潔な説明
- 入力欄: メールアドレス用テキストフィールド（ラベル＋プレースホルダ）
- ボタン: 「ログイン」ラベルのボタン
- メッセージ領域: 成功・エラー・ガイダンスを表示

### 5.3 デザイン方針

- カードの形状・影・高さなどは、A1 の「カードタイル型ログインボタン」の仕様に揃える。  
  - rounded-2xl 相当
  - 最小限の shadow
  - 高さ 80〜92px 程度（テキスト量に応じて調整）
- MagicLink／Passkey のカードサイズや余白は、横並びでもバランスが取れるようにする。
- テキスト量はスマホでも読みやすい行数に抑える。

### 5.4 操作感

- ユーザーはカード内で「メールアドレス入力 → ログインボタン押下」だけでよい。
- 送信中はボタンを無効化し、カード内で「送信中」であることが分かる表示を行う。
- エラー時はカード内に理由と次のアクション（再入力・再送試行など）を表示する。

---

## 6. 外部インターフェース（概要）

### 6.1 Supabase Auth との連携

- MagicLink 送信には Supabase Auth のメール OTP 機能を用いる。
- リダイレクト先 URL は `/auth/callback` を基本とする。
- パラメータ（メールアドレス、リダイレクト先、その他オプション）は詳細設計側で定義する。

### 6.2 i18n とメッセージ

- カードタイトル・説明文・ボタンラベル・メッセージは i18n コンポーネントを通じて取得する。
- メッセージキーは `login.magiclink.*` のような名前空間で管理する。

---

## 7. セキュリティ・非機能

### 7.1 セキュリティ

- MagicLink のトークンは Supabase 側で安全に生成・検証されることを前提とする。
- エラーメッセージは内部情報を露出させず、ユーザーの次の行動（再試行など）が分かるレベルにとどめる。

### 7.2 可用性

- ネットワーク障害等により MagicLink 送信が失敗しても、再試行できる UI とする。
- 連続送信による負荷やスパムを防ぐため、送信ボタン連打の抑制（一定時間のクールダウン等）を検討対象とする。

---

## 8. ログ出力方針（MagicLink 関連）

- 想定イベント例:
  - `auth.login.magiclink.start` — MagicLink カード内「ログイン」ボタン押下時
  - `auth.login.magiclink.sent` — MagicLink 送信成功
  - `auth.login.magiclink.error` — MagicLink 送信失敗
- ログの目的は、不具合調査や利用状況の把握に限定し、個人を特定できる情報は最小限とする。

---

## 9. 今後の検討事項

- MagicLink 再送間隔や回数制限など、負荷・スパム対策の具体的ルール。
- メールテンプレート（件名・本文）の多言語化・ブランド反映方法。
- Passkey カードタイルとの文言・デザインバランス（どちらをどの程度目立たせるか）。

---

## 10. 改訂履歴

| Version | Date       | Summary                                          |
| ------- | ---------- | ------------------------------------------------ |
| 1.0     | 2025-11-15 | 初版作成。MagicLink カードタイルの基本設計を定義 |
