# HarmoNet 基本設計書 - MagicLink ログイン機能 (A-01) v1.1

---

## 0. ドキュメント情報

* 文書名: HarmoNet 基本設計書 - MagicLink ログイン機能 (A-01)
* Document ID: HARMONET-BASIC-A01-MAGICLINK-AUTH
* Version: v1.1
* Supersedes: v1.0
* Status: 基本設計（実装済み内容準拠）
* 対象システム: HarmoNet（マルチテナント型コミュニティ OS）
* 対象コンポーネント:

  * A-01 MagicLinkForm（MagicLink ログイン用フォーム）
* 作成日: 2025-11-19
* 作成者: Tachikoma
* レビュー: TKD

---

## 1. 目的・背景

### 1.1 目的

本書の目的は、HarmoNet における **MagicLink ログイン機能の仕様について記載する。

MagicLinkForm は、ログイン画面中央に「メールでログイン」用のカード（フォーム）として下記の通り表示する。

* メールアドレス入力
* Supabase Auth を用いた MagicLink 送信
* カード内でのメッセージ表示

### 1.2 背景

* ログイン画面（A1）は、Header / Footer / MagicLinkForm の 3 部構成で実装済みであり、本書はその中央フォームに対応する基本設計である。
* パスワードを使わず、メールアドレスだけでログインできるパスワードレス方式を採用することで、利用者の負担軽減とセキュリティを両立する。

---

## 2. 対象範囲と非対象

### 2.1 対象範囲

* `/login` 画面に表示される **MagicLink ログインフォーム**（A-01 MagicLinkForm）の UI と挙動
* フォーム内のメール入力、送信ボタン、メッセージ領域
* MagicLink 送信開始〜送信結果（成功／失敗）までのフロントエンド処理
* 入力チェック（形式レベル）
* ログ出力方針・メッセージ表示方針（基本設計レベル）

### 2.2 非対象

* `/auth/callback` 以降のトークン検証・画面遷移処理
* Supabase Auth サーバ側の内部実装（トークン検証・セッション管理）
* 他の認証方式（Passkey など）

---

## 3. 業務要件・ユースケース

### 3.1 想定ユーザー

* メールアドレスを保有している居住者・管理者
* スマホ／PC ブラウザから HarmoNet にアクセスする一般ユーザー

### 3.2 代表ユースケース

#### UC-01: MagicLink でログインリンクを受け取る

1. ユーザーが `/login` を表示する。
2. ログイン画面中央に「メールでログイン」フォーム（MagicLinkForm）が表示される。
3. ユーザーが自分のメールアドレスを入力する。
4. 「ログイン」ボタンを押下する。
5. MagicLinkForm がメール形式のチェックを行う。
6. 形式が正しければ、Supabase Auth に対して MagicLink 送信を依頼する。
7. 送信成功時、フォーム内に「ログイン用リンクを送信しました」等の案内メッセージを表示する。

#### UC-02: メール形式エラー

1. ユーザーが誤った形式（例: `user@`）のメールアドレスを入力する。
2. 「ログイン」ボタン押下後、MagicLinkForm が形式チェックを実行する。
3. 形式が不正な場合、フォーム内にエラーメッセージを表示し、送信処理は行わない。
4. ユーザーが入力を修正し、再度「ログイン」を押下する。

#### UC-03: MagicLink 送信時のエラー

1. UC-01 の手順に従い送信を試みる。
2. ネットワーク障害などで Supabase 連携が失敗する。
3. MagicLinkForm はフォーム内にエラーメッセージ（通信エラーなど）を表示する。
4. ユーザーは接続状態を確認し、再試行できる。

---

## 4. 機能要件（基本設計レベル）

### 4.1 コンポーネントの役割

#### A-01 MagicLinkForm

**UI の役割**

* ログイン画面中央に配置される「メールでログイン」用フォームを構成する。
* フォーム内に以下の要素を含む：

  * タイトル：例「メールでログイン」
  * 説明文：例「入力したメールアドレスにログイン用リンクを送信します」
  * メールアドレス入力フィールド（ラベル付き）
  * 「ログイン」ボタン
  * 成功／失敗メッセージ表示領域

**ロジックの役割**

* 「ログイン」ボタン押下をトリガーに、以下を行う：

  * メールアドレスの形式チェック
  * OK の場合、Supabase Auth へ MagicLink 送信を依頼
  * 送信中／成功／失敗時の状態管理
  * 状態に応じたボタン活性／メッセージ表示の切り替え

### 4.2 入出力（概念レベル）

**入力**

* ユーザー入力：メールアドレス文字列
* ユーザー操作：「ログイン」ボタン押下

**出力**

* Supabase Auth の応答結果（成功／失敗）
* MagicLinkForm の状態：

  * `idle` / `sending` / `sent` / `error_input` / `error_network` / `error_auth` / `error_unexpected`
* ログイベント（例）：

  * `auth.login.start`
  * `auth.login.success.magiclink`
  * `auth.login.fail.*`

### 4.3 エラー種別（概要）

* 入力エラー

  * メール形式不正など、クライアント側で判定できるもの。
* 通信エラー

  * ネットワーク障害や Supabase 接続エラー。
* 認証エラー

  * Supabase Auth が返す認証系エラー。
* 想定外エラー

  * 上記に分類できない例外的な状況。

詳細なエラーコード・メッセージは詳細設計書で定義する。

---

## 5. UX 方針

### 5.1 画面内位置付け

* A1 ログイン画面基本設計 v1.1 に準拠し、`/login` 画面中央に MagicLinkForm を配置する。
* フォームはカード状のコンテナとして表示し、モバイル幅（max-w-md）を基本とする。

### 5.2 フォーム構成イメージ

* アイコン：メールアイコン
* タイトル：例「メールでログイン」
* サブテキスト：短い説明文
* メールアドレス入力欄
* 「ログイン」ボタン
* 成功／エラー用メッセージ領域

### 5.3 デザイン方針

* A1 ログイン画面のトーン（やさしく・自然・控えめ）に完全準拠。
* カード：rounded-2xl、最小限の shadow、padding 充分。
* テキスト量はモバイルでも読みやすい行数に抑える。

### 5.4 操作感

* 操作フローは「メール入力 → ログイン押下」の 1 ステップで完結する。
* 送信中はボタンを disabled にし、状態が視覚的に分かるようにする。
* エラー時はフォーム内に理由と次のアクションを簡潔に表示する。

---

## 6. 外部インターフェース（概要）

### 6.1 Supabase Auth 連携

* MagicLink 送信には Supabase Auth の `signInWithOtp()` を利用する。
* リダイレクト先 URL は `/auth/callback` を基本とする。
* 送信パラメータ（メールアドレス、リダイレクトURL 等）は詳細設計書にて具体化。

### 6.2 i18n

* タイトル・説明文・ボタン・メッセージは StaticI18nProvider 経由で取得する。
* キーは `auth.login.magiclink.*` 等の名前空間で管理する。

---

## 7. セキュリティ・非機能

### 7.1 セキュリティ

* MagicLink のトークン生成・検証は Supabase Auth 側で行う。
* フロント側ではトークン値を扱わない。
* メッセージは内部構造を露出せず、ユーザーの次アクション（再入力・再試行）が分かるレベルに留める。

### 7.2 可用性・運用

* 送信失敗時も再試行可能な UI とする。
* 過剰な連続送信を防ぐため、送信中のボタン連打を抑止する。

---

## 8. ログ出力方針（概要）

* ログは共通ログユーティリティを通じて出力する。
* 想定イベント：

  * `auth.login.start` — ログインボタン押下
  * `auth.login.success.magiclink` — MagicLink 送信成功
  * `auth.login.fail.input` — 入力エラー
  * `auth.login.fail.supabase.network` — 通信エラー
  * `auth.login.fail.supabase.auth` — 認証エラー
  * `auth.login.fail.unexpected` — 想定外エラー
* メールアドレスはログ上ではマスキングする、または出力しない方針とする。

---

## 9. 改訂履歴

| Version | Date       | Summary                                       |
| ------- | ---------- | --------------------------------------------- |
| 1.1     | 2025-11-19 | Passkey 関連を全削除し、実装済み MagicLinkForm に準拠して全面更新。 |
| 1.0     | 2025-11-15 | 初版作成。MagicLink カードタイルの基本設計を定義。                |

---

**End of Document**
